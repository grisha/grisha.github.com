<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Grisha Trubetskoy]]></title>
  <link href="http://grisha.org/atom.xml" rel="self"/>
  <link href="http://grisha.org/"/>
  <updated>2013-05-23T22:57:02-04:00</updated>
  <id>http://grisha.org/</id>
  <author>
    <name><![CDATA[Gregory Trubetskoy]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Checking out Cloudera Impala]]></title>
    <link href="http://grisha.org/blog/2013/05/23/checking-out-cloudera-impala/"/>
    <updated>2013-05-23T12:43:00-04:00</updated>
    <id>http://grisha.org/blog/2013/05/23/checking-out-cloudera-impala</id>
    <content type="html"><![CDATA[<p>I&#8217;ve decided to check out
<a href="http://blog.cloudera.com/blog/2012/10/cloudera-impala-real-time-queries-in-apache-hadoop-for-real/">Impala</a>
last week and here&#8217;s some notes on how that went.</p>

<h2>First thoughts</h2>

<p>I was very impressed with how easy it was to install, even considering
our unusual set up (see below). In my simple ad-hoc tests Impala
performed orders of magnitude faster than Hive. So far it seems solid
down to the little details, like the shell prompt with a fully
functional libreadline and column headers nicely formatted.</p>

<h2>Installing</h2>

<p>The first problem I encountered was that we use Cloudera
<a href="http://www.cloudera.com/content/cloudera-content/cloudera-docs/CDHTarballs/3.25.2013/CDH4-Downloadable-Tarballs/CDH4-Downloadable-Tarballs.html">tarballs</a>
in our set up, but Impala is only available as a package (RPM in our
case). I tried compiling it from
<a href="https://github.com/cloudera/impala">source</a>, but it&#8217;s not a trivial
compile - it requires <a href="http://llvm.org/">LLVM</a> (which is way cool,
BTW) and has a bunch of dependencies, it didn&#8217;t work out-of-the-box
for me so I&#8217;ve decided to take an alternative route (I will definitely get it compiled some weekend soon).</p>

<p>Retreiving contents of an RPM is trivial (because it&#8217;s really a cpio
archive), and then I&#8217;d just have to &#8220;make it work&#8221;.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ curl -O http://archive.cloudera.com/impala/redhat/6/x86_64/impala/1.0/RPMS/x86_64/impala-server-1.0-1.p0.819.el6.x86_64.rpm
</span><span class='line'>$ mkdir impala
</span><span class='line'>$ cd impala
</span><span class='line'>$ rpm2cpio ../impala-server-1.0-1.p0.819.el6.x86_64.rpm | cpio -idmv</span></code></pre></td></tr></table></div></figure>


<p>I noticed that <code>usr/bin/impalad</code> is a shell script, and it appears to
rely on a few environment vars for configuration, so I created a shell
script that sets them which looks approximately like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nb">export </span><span class="nv">JAVA_HOME</span><span class="o">=</span>/usr/java/default
</span><span class='line'><span class="nb">export </span><span class="nv">IMPALA_LOG_DIR</span><span class="o">=</span> <span class="c"># your log dir</span>
</span><span class='line'><span class="nb">export </span><span class="nv">IMPALA_STATE_STORE_PORT</span><span class="o">=</span>24000
</span><span class='line'><span class="nb">export </span><span class="nv">IMPALA_STATE_STORE_HOST</span><span class="o">=</span> <span class="c"># probably namenode host or whatever</span>
</span><span class='line'><span class="nb">export </span><span class="nv">IMPALA_BACKEND_PORT</span><span class="o">=</span>22000
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">IMPALA_HOME</span><span class="o">=</span> <span class="c"># full path to usr/lib/impala from the RPM, e.g. /home/grisha/impala/usr/lib/impala</span>
</span><span class='line'><span class="nb">export </span><span class="nv">IMPALA_CONF_DIR</span><span class="o">=</span> <span class="c"># config dir, e.g. /home/grisha/impala/etc/impala&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">IMPALA_BIN</span><span class="o">=</span><span class="k">${</span><span class="nv">IMPALA_HOME</span><span class="k">}</span>/sbin-retail
</span><span class='line'><span class="nb">export </span><span class="nv">LIBHDFS_OPTS</span><span class="o">=</span>-Djava.library.path<span class="o">=</span><span class="k">${</span><span class="nv">IMPALA_HOME</span><span class="k">}</span>/lib
</span><span class='line'><span class="nb">export </span><span class="nv">MYSQL_CONNECTOR_JAR</span><span class="o">=</span> <span class="c"># full path a mysql-connect jar</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">HIVE_HOME</span><span class="o">=</span> <span class="c"># your hive home - note: every impala nodes needs it, just config, not the whole Hive install</span>
</span><span class='line'><span class="nb">export </span><span class="nv">HIVE_CONF_DIR</span><span class="o">=</span> <span class="c"># this seems redundant, my guess HIVE_HOME is enough, but whatever</span>
</span><span class='line'><span class="nb">export </span><span class="nv">HADOOP_CONF_DIR</span><span class="o">=</span> <span class="c"># path the hadoop config, the dir that has hdfs-site.xml, etc.</span>
</span><span class='line'>
</span><span class='line'><span class="nb">export </span><span class="nv">IMPALA_STATE_STORE_ARGS</span><span class="o">=</span><span class="s2">&quot; -log_dir=${IMPALA_LOG_DIR} -state_store_port=${IMPALA_STATE_STORE_PORT}&quot;</span>
</span><span class='line'><span class="nb">export </span><span class="nv">IMPALA_SERVER_ARGS</span><span class="o">=</span><span class="s2">&quot; \                                                                                                                                                                                  -log_dir=${IMPALA_LOG_DIR} \                                                                                                                                                                              -state_store_port=${IMPALA_STATE_STORE_PORT} \                                                                                                                                                            -use_statestore \                                                                                                                                                                                         -state_store_host=${IMPALA_STATE_STORE_HOST} \                                                                                                                                                            -be_port=${IMPALA_BACKEND_PORT}&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>With the above environment vars set, starting Impala should amount to
the following (you probably want to run those in separate windows, also note that
the state store needs to be started first):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>./usr/bin/statestored <span class="k">${</span><span class="nv">IMPALA_STATE_STORE_ARGS</span><span class="k">}</span> <span class="c"># do this on IMPALA_STATE_STORE_HOST only</span>
</span><span class='line'><span class="nv">$ </span>./usr/bin/impalad <span class="k">${</span><span class="nv">IMPALA_SERVER_ARGS</span><span class="k">}</span> <span class="c"># do this on every node</span>
</span></code></pre></td></tr></table></div></figure>


<p>The only problem that I encountered was that Impala needed
short-circuit access enabled, so I had to add the following to the hdfs-site.xml:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'> <span class="nt">&lt;property&gt;</span>
</span><span class='line'>   <span class="nt">&lt;name&gt;</span>dfs.client.read.shortcircuit<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>   <span class="nt">&lt;value&gt;</span>true<span class="nt">&lt;/value&gt;</span>
</span><span class='line'> <span class="nt">&lt;/property&gt;</span>
</span><span class='line'> <span class="nt">&lt;property&gt;</span>
</span><span class='line'>   <span class="nt">&lt;name&gt;</span>dfs.domain.socket.path<span class="nt">&lt;/name&gt;</span>
</span><span class='line'><span class="c">&lt;!-- adjust this to your set up: --&gt;</span>
</span><span class='line'>   <span class="nt">&lt;value&gt;</span>/var/run/dfs_domain_socket_PORT.sock<span class="nt">&lt;/value&gt;</span>
</span><span class='line'> <span class="nt">&lt;/property&gt;</span>
</span><span class='line'> <span class="nt">&lt;property&gt;</span>
</span><span class='line'>   <span class="nt">&lt;name&gt;</span>dfs.client.file-block-storage-locations.timeout<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>   <span class="nt">&lt;value&gt;</span>3000<span class="nt">&lt;/value&gt;</span>
</span><span class='line'> <span class="nt">&lt;/property&gt;</span>
</span><span class='line'> <span class="nt">&lt;property&gt;</span>
</span><span class='line'><span class="c">&lt;!-- adjust this too: --&gt;</span>
</span><span class='line'>   <span class="nt">&lt;name&gt;</span>dfs.block.local-path-access.user<span class="nt">&lt;/name&gt;</span>
</span><span class='line'>   <span class="nt">&lt;value&gt;</span><span class="c">&lt;!-- user name --&gt;</span><span class="nt">&lt;/value&gt;</span>
</span><span class='line'> <span class="nt">&lt;/property&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once the above works, we need <code>impala-shell</code> to test it. Again, I pulled it out of the RPM:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>$ curl -O http://archive.cloudera.com/impala/redhat/6/x86_64/impala/1.0/RPMS/x86_64/impala-shell-1.0-1.p0.819.el6.x86_64.rpm
</span><span class='line'>$ mkdir shell ; cd shell
</span><span class='line'>$ rpm2cpio ../impala-shell-1.0-1.p0.819.el6.x86_64.rpm | cpio -idmv
</span></code></pre></td></tr></table></div></figure>


<p>I was then able to start the shell and connect. You can connect to any Impala node (read the docs):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='xml'><span class='line'>$ ./usr/bin/impala-shell
</span><span class='line'>[localhost:21000] &gt; connect some_node;
</span><span class='line'>Connected to some_node:21000
</span><span class='line'>Server version: impalad version 1.0 RELEASE (build d1bf0d1dac339af3692ffa17a5e3fdae0aed751f)
</span><span class='line'>[some_node:21000] &gt; select count(*) from your_favorite_table;
</span><span class='line'>Query: select count(*) from your_favorite_table
</span><span class='line'>Query finished, fetching results ...
</span><span class='line'>+-----------+
</span><span class='line'>| count(*)  |
</span><span class='line'>+-----------+
</span><span class='line'>| 302052158 |
</span><span class='line'>+-----------+
</span><span class='line'>Returned 1 row(s) in 2.35s
</span></code></pre></td></tr></table></div></figure>


<p>Ta-da! The above query takes a good few minutes in Hive, BTW.</p>

<h2>Other Notes</h2>

<ul>
<li>Impala does not support custom SerDe&#8217;s so it won&#8217;t work if you&#8217;re relying on JSON. It does support Avro.</li>
<li>There is no support for UDF&#8217;s, so our <a href="https://github.com/livingsocial/HiveSwarm">HiveSwarm</a> is of no use.</li>
<li>INSERT OVERWRITE works, which is good.</li>
<li>LZO support works too.</li>
<li>It appears that everything impala does will appear in HDFS as the
user under which Impala is running. Be careful with this, as you
might inadvertently give your users superuser privs on HDFS via Hue,
for example. (Oh did I mention Hue completely supports Impala
too?). From what I can tell there is no way to set a username, this
is a bit of a show-stopper for us, actually.</li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Relational database on top of key-value store explained (or why B-trees are cool)]]></title>
    <link href="http://grisha.org/blog/2013/05/11/relational-database-on-top-of-key-value-store-explained/"/>
    <updated>2013-05-11T11:36:00-04:00</updated>
    <id>http://grisha.org/blog/2013/05/11/relational-database-on-top-of-key-value-store-explained</id>
    <content type="html"><![CDATA[<p>This post attempts to explain how a relational database can be
implemented atop a key/value store, a subject that I&#8217;ve long found
rather mysterious.</p>

<p>Every once in a while I would come across a mention that a relational
database can be implemented using a key/value store (aka dictionary,
hash table or hash map - for brevity I&#8217;ll be using <em>map</em> from here on).</p>

<p>Whenever I thought about it, it just didn&#8217;t make sense. A relational
database needs to store rows <em>in order</em>, and that&#8217;s one feature that
maps do not provide. Imagine we have a table keyed by employee id
stored in a map and we need to traverse it by id in ascending order. A
hypothetical keys() method would return us a list of ids ordered
randomly. It&#8217;s impossible to iterate over a hash map <em>in
order</em>. So how would a relational database work then?</p>

<p>It took a while for me to realize the root of my misunderstanding. I
naively was trying to picture how tables, rows and values can be
represented as key/value pairs, and that was the wrong path to take. I
was focusing on the wrong layer of abstraction.</p>

<p>As it turns out the
key [NPI] to this problem is the clever data structure commonly used
to store data in a relational DB known as
<em><a href="http://en.wikipedia.org/wiki/B-tree">B-Tree</a></em> (or a variation
thereof, <em><a href="http://en.wikipedia.org/wiki/B+tree">B+Tree</a></em>).
Okay, B-trees are nothing new and I&#8217;m sure we&#8217;ve all heard of them. In fact B-trees were
desgined in the 1970&#8217;s as a generalization of the
<a href="http://en.wikipedia.org/wiki/Binary_search_tree">Binary Search Tree</a> that was
more suited for block storage.</p>

<p>But there is something about B-trees that I did not know, and which
now that I do know, seems absolutely essential as well as simply brilliant. In his 1979 paper &#8220;The
Ubiquitous B-Tree&#8221; <a href="http://www.cs.purdue.edu/people/comer">Douglas Comer</a> writes:</p>

<blockquote> The availability of demand paging hardware suggests an
interesting implementation of B-trees.  Through careful allocation,
each node of the B-tree can be mapped into one page of the virtual
address space.  Then the user treats the B-tree as if it were in
memory.  Accesses to nodes (pages) which are not in memory cause the
system to &#8220;page-in&#8221; the node from secondary storage. </blockquote>


<p>The above paragraph implies that the B-Tree and all its data can be
stored in <em>pages</em>. In fact, if you look at the file
<a href="http://www.sqlite.org/src/artifact/eecc84f02375b2bb7a44abbcbbe3747dde73edb2">format of a SQLite 3 database</a>
(who says source code comments are bad?) you&#8217;ll see it states quite plainly  that the <em>file
is divided into pages</em>. (You will also see a fantastic description of exactly
how a B+tree works, but that&#8217;s way outside the scope of this post.)</p>

<p>The important point is that the entire file consists of pages and
nothing else. Inside those pages live the B-tree structure, as well as
the data. Each table is a B-tree and to access it we need to know the
starting page number, which in turn is stored in the sqlite_master
table whose root page is always the first page of the file. The root
page of a table is the head of the B-tree strucutre, and it may refer
to other pages, which in turn may be additional nodes of the tree or
pure data.</p>

<p>All pages are of the same size and are numbered
sequentially, thus we can easily retreive any page by its number
because its offset into the file is the page number multiplied by the
page size. (By default a SQLite3 page is 1K and will hold 4 keys,
i.e. the order of the tree is 4).</p>

<p>And bingo, there is our key/value pair: the page number is the key,
and the page itself is the value! All you need to do is stick those
pages into your favorite key/value store keyed by page number and
you&#8217;ve got a relational database atop a key/value store. It&#8217;s that
simple.</p>

<p>P.S. An astute reader may point out that there is such a thing as a
<em>sorted map</em>. But a sorted map is very different from a &#8220;pure&#8221; hash
map. The miracle of hashing is that not only does it let you find
elements in O(1) time, but more importantly that it is very suitable
for distributed processing, where the map may be spread across
multiple servers. And if you start thinking about how a <em>sorted</em> map
might be implemented in a distributed fashion, you will ultimately
loop back to B-trees, because that&#8217;s typically how it&#8217;s actually done.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MapJoin: a simple way to speed up your Hive queries]]></title>
    <link href="http://grisha.org/blog/2013/04/19/mapjoin-a-simple-way-to-speed-up-your-hive-queries/"/>
    <updated>2013-04-19T11:15:00-04:00</updated>
    <id>http://grisha.org/blog/2013/04/19/mapjoin-a-simple-way-to-speed-up-your-hive-queries</id>
    <content type="html"><![CDATA[<p>Mapjoin is a little-known feature of Hive. It allows a table to be
loaded into memory so that a (very fast) join could be performed
entirely within a mapper without having to use a Map/Reduce step. If
your queries frequently rely on small table joins (e.g. cities or
countries, etc.)  you might see a very substantial speed-up from using
mapjoins.</p>

<p>There are two ways to enable it. First is by using a hint, which looks
like <code>/*+ MAPJOIN(aliasname), MAPJOIN(anothertable) */</code>. This C-style comment
should be placed immediately following the <code>SELECT</code>. It directs Hive
to load <code>aliasname</code> (which is a table or alias of the query) into
memory.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sql'><span class='line'><span class="k">SELECT</span> <span class="cm">/*+ MAPJOIN(c) */</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">orders</span> <span class="n">o</span> <span class="k">JOIN</span> <span class="n">cities</span> <span class="k">c</span> <span class="k">ON</span> <span class="p">(</span><span class="n">o</span><span class="p">.</span><span class="n">city_id</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Another (better, in my opinion) way to turn on mapjoins is to let Hive
do it automatically. Simply set <code>hive.auto.convert.join</code> to true in
your config, and Hive will automatically use mapjoins for any tables
smaller than <code>hive.mapjoin.smalltable.filesize</code> (default is 25MB).</p>

<p>Mapjoins have a limitation in that the same table or alias cannot be
used to join on different columns in the same query. (This makes sense
because presumably Hive uses a HashMap keyed on the column(s) used in
the join, and such a HashMap would be of no use for a join on
different keys).</p>

<p>The workaround is very simple - do not use the same aliases in your
query.</p>

<p>I also found that when the Hive documentation states that such queries
are &#8221;<a href="https://cwiki.apache.org/Hive/languagemanual-joins.html#LanguageManualJoins-Mapjoinrestrictions">not supported</a>&#8221;
 they mean that the query will fail in unexpected
ways, sometimes with a Java traceback.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Linus on understanding pointers]]></title>
    <link href="http://grisha.org/blog/2013/04/02/linus-on-understanding-pointers/"/>
    <updated>2013-04-02T10:52:00-04:00</updated>
    <id>http://grisha.org/blog/2013/04/02/linus-on-understanding-pointers</id>
    <content type="html"><![CDATA[<p>A while back <a href="http://en.wikipedia.org/wiki/Linus_Torvalds">Linus Torvalds</a> <a href="http://meta.slashdot.org/story/12/10/11/0030249/linus-torvalds-answers-your-questions">answered questions on Slashdot</a>.</p>

<p>One of the answers was on the subject of understanding of pointers:</p>

<blockquote><p><small>At the opposite end of the spectrum, I actually wish more people
understood the really core low-level kind of coding. Not big, complex
stuff like the lockless name lookup, but simply good use of
pointers-to-pointers etc. For example, I&#8217;ve seen too many people who
delete a singly-linked list entry by keeping track of the &#8220;prev&#8221;
entry, and then to delete the entry, doing something like</small></p>

<p><small>if (prev)<br/>
  prev->next = entry->next;<br/>
else<br/>
  list_head = entry->next;<br/>
</small></p>

<p><small>and whenever I see code like that, I just go &#8220;This person doesn&#8217;t
understand pointers&#8221;. And it&#8217;s sadly quite common.</small></p>

<p><small>People who understand pointers just use a &#8220;pointer to the entry
pointer&#8221;, and initialize that with the address of the list_head. And
then as they traverse the list, they can remove the entry without
using any conditionals, by just doing a &#8220;*pp = entry->next&#8221;</small></p></blockquote>

<p>There were a few comments, but none explained what he really
meant. So here it is.</p>

<p>Imagine you have a linked list defined as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="k">typedef</span> <span class="k">struct</span> <span class="n">list_entry</span> <span class="p">{</span>
</span><span class='line'>    <span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">list_entry</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span> <span class="n">list_entry</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>You need to iterate over it from the begining to end and remove a
specific element whose value equals the value of <code>to_remove</code>. The more
obvious way to do this would be:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">list_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span> <span class="cm">/* assuming head exists and is the first entry of the list */</span>
</span><span class='line'><span class="n">list_entry</span> <span class="o">*</span><span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">==</span> <span class="n">to_remove</span><span class="p">)</span>     <span class="cm">/* this is the one to remove */</span>
</span><span class='line'>        <span class="k">if</span> <span class="p">(</span><span class="n">prev</span><span class="p">)</span>
</span><span class='line'>           <span class="n">prev</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span> <span class="cm">/* remove the entry */</span>
</span><span class='line'>        <span class="k">else</span>
</span><span class='line'>            <span class="n">head</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>      <span class="cm">/* special case - first entry */</span>
</span><span class='line'>
</span><span class='line'>    <span class="cm">/* move on to the next entry */</span>
</span><span class='line'>    <span class="n">prev</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
</span><span class='line'>    <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>What we are doing above is iterating over the list until <code>entry</code> is
NULL, which means we&#8217;ve reached the end of the list (line 4). When we
come across an entry we want removed (line 5), we assign the value of
current <code>next</code> pointer to the previous one, thus eliminating the
current element (line 7).</p>

<p>There is a special case above - at the beginning of the iteration
there is no previous entry (<code>prev</code> is NULL), and so to remove the
first entry in the list you have to modify <code>head</code> itself (line 9).</p>

<p>What Linus was saying is that the above code could be simplified by
making the previous element a <em>pointer to a pointer</em> rather than just a
pointer. The code then looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">list_entry</span> <span class="o">**</span><span class="n">pp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">head</span><span class="p">;</span> <span class="cm">/* pointer to a pointer */</span>
</span><span class='line'><span class="n">list_entry</span> <span class="o">*</span><span class="n">entry</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">while</span> <span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">if</span> <span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">==</span> <span class="n">to_remove</span><span class="p">)</span>
</span><span class='line'>        <span class="o">*</span><span class="n">pp</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">pp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span><span class='line'>    <span class="n">entry</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The above code is very similar to the previous variant, but notice how
we no longer need to watch for the special case of the first element
of the list, since <code>pp</code> is not NULL at the beginning. Simple and
clever.</p>

<p>Also, someone in that thread commented that the reason this is better
is because <code>*pp = entry-&gt;next</code> is <em>atomic</em>.  It is most certainly NOT
atomic. The above expression contains two dereference operators (<code>*</code>
and <code>-&gt;</code>) and one assignment, and neither of those three things is
atomic. This is a common misconception, but alas pretty much <em>nothing</em>
in C should ever be assumed to be atomic (including the <code>++</code> and <code>--</code>
operators)!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Storm Notes]]></title>
    <link href="http://grisha.org/blog/2013/04/01/storm-notes/"/>
    <updated>2013-04-01T17:05:00-04:00</updated>
    <id>http://grisha.org/blog/2013/04/01/storm-notes</id>
    <content type="html"><![CDATA[<p>Some random thoughts on having tinkered with
<a href="http://storm-project.net/">Storm</a> over the past few weeks.</p>

<p>It took me some time to understand what Storm is, and I am still not
clear I have found a perfect use for it. (This is not
a criticism of Storm, the point is that the concepts it introduces are
new, somewhat diffuclt and will need some time so sync in). The best way to get the basic
understanding of Storm concepts is to watch Nathan Marz&#8217;s <a href="https://www.youtube.com/watch?v=bdps8tE0gYo">excellent presentation</a>.</p>

<p>In simple terms, Storm is a tool that lets you run code in parallel
across a cluster of servers. It differs from Map/Reduce in that the
actual algorithm is entirely up to you, and in essence all that Storm
provides is the framework that supervises all the moving pieces of your
application (known as a <em>topology</em>) and provides a uniform way of
creating, testing locally, sumbitting to a cluster, logging,
monitoring, as well as primitives for sending data between components
such as grouping data by using hashing, etc.</p>

<p>Storm is mainly meant for stream processing. A stream could be
anything, some of the most obvious examples may be your web logs,
tables containing user actions such as clicks, transactions,
purchases, trades, etc. If the data is coming in at a rate where it&#8217;s
challenging to process it on one server, Storm provides a way to scale
it across a cluster of servers and can handle ridiculous amounts of
incoming data. The result is a real-time view of summary data that is
always up to date.</p>

<p>Storm is written in Java and Clojure, which makes the JVM the common
denominator, so any JVM language should work as &#8220;native&#8221;. Storm also provides a
primitive for using pipes to a process which means that you can write
a component in anything - from a Bash script to C, all it needs to do
is read stdin and write stdout.</p>

<p>For those who would prefer to try it out using a higher-level
language, there is an excellent project called
<a href="https://github.com/colinsurprenant/redstorm">Redstorm</a> which lets you
write your topology in JRuby. While a Redstorm topology may not be as
fast as something written in pure Java, the reduced development
time is well worth any trade offs, and you always have the option of
perfecting it later by porting your code to something JVM-native when
your understanding of how it ought to work is solidified in your mind.</p>

<p>If you&#8217;re going to go the Redstorm route, a couple of gotchas that I
came across were:</p>

<ul>
<li><p>Storm 0.8.2 and JRuby 1.7.2 disagree on the version of Yaml parsing
jar (snakeyaml). Don&#8217;t know what the solution is if you absolutely must parse
Yaml other than downgrading to JRuby 1.6.8, otherwise you can just
use something other than Yaml: JSON or just plain eval().</p></li>
<li><p>If you&#8217;re going to use ActiveRecord (which does work fine), watch
out for how to properly use it in a multi-threaded environment. You
might need to wrap some code in synchronize (see <a href="https://github.com/jruby/jruby/wiki/Concurrency-in-jruby">Concurrency in JRuby</a>.
You will also need make sure your ActiveRecord connections are not
shared by concurrent threads by using
<a href="http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/ConnectionPool.html#method-i-with_connection">connection_pool.with_connection</a></p></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[on prioritization - important vs urgent]]></title>
    <link href="http://grisha.org/blog/2013/03/27/on-prioritization/"/>
    <updated>2013-03-27T10:13:00-04:00</updated>
    <id>http://grisha.org/blog/2013/03/27/on-prioritization</id>
    <content type="html"><![CDATA[<p>Every item on a TODO list can be classified as <em>urgent</em>, <em>important</em>
or <em>neither</em>. We should act on important items first, urgent second and
ignore the rest.</p>

<p>Sometimes an item lands on our TODO list described as extremely urgent
without any explanation of importance. In this case the important item
(and thus to be done <em>first</em>) becomes <em>determining the importance of the
extremely urgent item in question</em>, even if it means delaying it.</p>

<p>The reason I so strongly believe that understanding the importance of
every thing we do is essential is quite simple: understanding
the importance implies understanding of the ultimate objective. And
inversely, not understanding the importance implies not understanding
the objective.</p>

<p>And if after some discussion and thinking one still cannot assess the
importance of a task, and nobody can explain it, then it
is simply not important, however urgent it may seem.</p>

<p>There are exceptions, however. Sometimes importance can be difficult
to verbalize. We should always be attuned to that. In my personal
experience reiterated urgency in response to &#8220;why it is important&#8221; is
a bad sign, whereas an emotional reaction of the &#8220;you just don&#8217;t get
it, how can I explain this to you?&#8221; is a very good sign.</p>

<p>And sometimes, when you trust that the person requesting something of
you truly believes it is both important and urgent but is unable to
verbalize the importance sufficiently well, you may have to take their
word for it and just do it, without fully understanding the
importance.</p>

<p>It is also important to remember to always take the time to explain
importance of things we request of others. We naturally enjoy working
on important things and resent &#8220;urgent&#8221; and unimportant tasks.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[On keeping lots of integers in memory]]></title>
    <link href="http://grisha.org/blog/2013/03/25/on-keeping-lots-of-integers-in-memory/"/>
    <updated>2013-03-25T22:09:00-04:00</updated>
    <id>http://grisha.org/blog/2013/03/25/on-keeping-lots-of-integers-in-memory</id>
    <content type="html"><![CDATA[<p>Once upon a time (over a year ago) I found myself needing to store large numbers of
integers in memory. The goal was to store a graph of all our
purchasers and items purchased, so that we could quickly identify
like-minded purchasers based on common purchases and make real-time
recommendations of the form &#8220;people like you also bought&#8221;. This
approach is commonly known as <a href="http://en.wikipedia.org/wiki/Collaborative_filtering">collaborative filtering</a>,
and exactly how we did it would be a subject of some future post
(perhaps).</p>

<p>At the time, I was looking at tens of millions of purchases by tens of
millions people of hundreds of thousands of items. The only
information I needed to store were id&#8217;s of people and items, which
were just integers. While this seemed like a lot of data, I
believed it was entirely feasible to store them all in memory.</p>

<p>I didn&#8217;t have time to write my own implementation for storing this
graph, so I looked at a bunch of tools out there, asked around, and
the only one that seemed to fit the bill exactly in the end was
<a href="http://redis.io/">Redis</a>. Yes, there are a few projects out there
that tout graph storage as their specialty, but none of them could
scale anywhere close to the level I needed. And in the end the term
&#8220;graph database&#8221; turned out to be a red herring of sorts. Any language
such as Python, Ruby or Java provides the basic data structures
quite sufficient for storing a graph as an adjacency list
out-of-the-box. You can store a graph in any key-value store, or even
in your favorite RDBMS. (To this day I&#8217;m not convinced there is any
good use case for the so-called graph databases out there.)</p>

<p>There were a few things that set Redis apart:</p>

<p>First, it keeps everything in RAM, which meant that updating this
dataset would be very fast, fast enough to keep it up-to-date in real
time.</p>

<p>The second great thing about Redis is <a href="http://redis.io/commands#sorted_set">Sorted Sets</a>. This data structure
and the operations it supports fit what we needed to do
precisely. (Again, sorry for sparing you the details, but roughly, you
need to store a Set of item ids for every person as well as a Set of
person ids for every item, and &#8220;people like you&#8221; then becomes the
union of all the Sets of items that are directly linked to &#8220;you&#8221;.)</p>

<p>Thirdly, Redis supports replication, which meant that if the most
CPU-intensive task of computing the actual recommendations (which
requires union-ing of a large number of large Sorted Sets) becomes a
bottle neck, we could address this by running it on slaves, and
we could easily scale the system by simply adding more slaves.</p>

<p>Last (but hardly least) is Redis&#8217; ability to persist and quickly load
the in-memory database. You begin to appreciate the immense value of
this once you start populating Redis by pulling historical data from
your RDBMS and realize that it could take many hours or even days.</p>

<p>Everything was going great with my plan but soon I ran into a problem.
Not even a quarter of the way through the initial load process, I
noticed Redis reporting 20+ GB being used, which meant that the
particular machine I was testing this on wouldn&#8217;t have enough
RAM. That was a bummer. Especially because it began to look like the
whole architecture would require more memory than would be financially
sensible for this project (yes, you could get a machine with 1TB of
memory, but it was and still is prohibitively expensive).</p>

<p>My hunch (supported by some quick back-of-the-napkin calculations) was
that this was a software problem, not a hardware one.</p>

<p>The first obvious inefficiency of storing integers on a 64-bit
system is how much space an integer takes up. 64 bits (or 8 bytes)
is enough to store a number as large as 92,23,372,036,854,775,807. Yet
this number takes up exactly as much memory as 17 or 1234 (pick your
favorite small number). In fact, the range of integers I was dealing
with was well under 1 billion and 32 bits would more than suffice.</p>

<p>Add to this that on a 64-bit system every <em>pointer</em> is also (you guessed
it) - 64 bits. So if you&#8217;re storing a (singly) linked list of
integers, you end up with 8 bytes for the integer and 8 bytes for the
&#8220;next&#8221; pointer, or 16 bytes per integer. And if your data structure
is even more complex, such as a Redis Sorted Set, which is actually
implemented as two structures updated simultaneously (a Skip List and a
Hash), well, then you begin to see that our integers may end up taking
up as much if not less memory than the pointers pointing to them.</p>

<p>One simple way to reduce the memory bloat was to compile Redis in
32-bit mode.  Redis makes it super easy with &#8220;make 32bit&#8221;.  Because of
the smaller pointer size the 32-bit mode uses much less memory, but of
course the caveat is that the total address space is limited to 32
bits or about 4GB.  While this did reduce the footprint by a great
deal, it wasn&#8217;t sufficient for my data set, which still looked to be
more than 4GB in size.</p>

<p>Then I came across this page on <a href="http://redis.io/topics/memory-optimization" title="">memory optimization</a>.  Little
did I know Redis already provided a very compact way of storing
integers. For small lists, sets or hashes, Redis uses a special
structure it calls <em>ziplist</em> that can store variable-length
integers and strings. The advantage is that it is very compact, but
the flipside is that such lists can only be processed
sequentially. (This is because you can&#8217;t access an n-th element in
such a list because sizes of elements vary, so you must scan from
beginning). But it tunrs out that sequential processing is actually
more efficient for small lists rather than following a more complex
algorithm (hashing or whatever) because it requires no
indirection and can be accomplished with simple pointer math.</p>

<p>Redis&#8217; zset-max-ziplist-entries config setting sets a threshold - any
Sorted Set that has fewer elements than the setting is stored as a
ziplist and as soon as it reaches the number greater than the setting
it is converted to the full-fledged Sorted Set data
structure.</p>

<p>What was interesting is that in my tests bumping up the value from the
default of 128 to as high as 10000 didn&#8217;t seem to have any noticeable
performance impact while reduced the memory usage by an order of
magnitude. My best guess is that even at 10K elements this list is
small enough to be processed entirely in the CPU cache.</p>

<p>The effect of tweaking this setting seemed like pure magic, so I just
had to dig deeper and figure out exactly how it works. You can see the
description of the format in the comments for this file in Redis
source: <a href="https://github.com/antirez/redis/blob/unstable/src/ziplist.c">src/ziplist.c</a>.</p>

<p>The technique is very simple - the first 4 bits are used to identify
the size of the integer. The relevant comment text:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">*</span> <span class="o">|</span><span class="mi">11000000</span><span class="o">|</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">byte</span>
</span><span class='line'><span class="o">*</span> <span class="n">Integer</span> <span class="n">encoded</span> <span class="n">as</span> <span class="kt">int16_t</span> <span class="p">(</span><span class="mi">2</span> <span class="n">bytes</span><span class="p">).</span>
</span><span class='line'><span class="o">*</span> <span class="o">|</span><span class="mi">11010000</span><span class="o">|</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">byte</span>
</span><span class='line'><span class="o">*</span> <span class="n">Integer</span> <span class="n">encoded</span> <span class="n">as</span> <span class="kt">int32_t</span> <span class="p">(</span><span class="mi">4</span> <span class="n">bytes</span><span class="p">).</span>
</span><span class='line'><span class="o">*</span> <span class="o">|</span><span class="mi">11100000</span><span class="o">|</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">byte</span>
</span><span class='line'><span class="o">*</span> <span class="n">Integer</span> <span class="n">encoded</span> <span class="n">as</span> <span class="kt">int64_t</span> <span class="p">(</span><span class="mi">8</span> <span class="n">bytes</span><span class="p">).</span>
</span><span class='line'><span class="o">*</span> <span class="o">|</span><span class="mi">11110000</span><span class="o">|</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">byte</span>
</span><span class='line'><span class="o">*</span> <span class="n">Integer</span> <span class="n">encoded</span> <span class="n">as</span> <span class="mi">24</span> <span class="n">bit</span> <span class="kt">signed</span> <span class="p">(</span><span class="mi">3</span> <span class="n">bytes</span><span class="p">).</span>
</span><span class='line'><span class="o">*</span> <span class="o">|</span><span class="mi">11111110</span><span class="o">|</span> <span class="o">-</span> <span class="mi">1</span> <span class="n">byte</span>
</span><span class='line'><span class="o">*</span> <span class="n">Integer</span> <span class="n">encoded</span> <span class="n">as</span> <span class="mi">8</span> <span class="n">bit</span> <span class="kt">signed</span> <span class="p">(</span><span class="mi">1</span> <span class="n">byte</span><span class="p">).</span>
</span><span class='line'><span class="o">*</span> <span class="o">|</span><span class="mi">1111</span><span class="n">xxxx</span><span class="o">|</span> <span class="o">-</span> <span class="p">(</span><span class="n">with</span> <span class="n">xxxx</span> <span class="n">between</span> <span class="mo">0000</span> <span class="n">and</span> <span class="mi">1101</span><span class="p">)</span> <span class="n">immediate</span> <span class="mi">4</span> <span class="n">bit</span> <span class="n">integer</span><span class="p">.</span>
</span><span class='line'><span class="o">*</span> <span class="n">Unsigned</span> <span class="n">integer</span> <span class="n">from</span> <span class="mi">0</span> <span class="n">to</span> <span class="mf">12.</span> <span class="n">The</span> <span class="n">encoded</span> <span class="n">value</span> <span class="n">is</span> <span class="n">actually</span> <span class="n">from</span>
</span><span class='line'><span class="o">*</span> <span class="mi">1</span> <span class="n">to</span> <span class="mi">13</span> <span class="n">because</span> <span class="mo">0000</span> <span class="n">and</span> <span class="mi">1111</span> <span class="n">can</span> <span class="n">not</span> <span class="n">be</span> <span class="n">used</span><span class="p">,</span> <span class="n">so</span> <span class="mi">1</span> <span class="n">should</span> <span class="n">be</span>
</span><span class='line'><span class="o">*</span> <span class="n">subtracted</span> <span class="n">from</span> <span class="n">the</span> <span class="n">encoded</span> <span class="mi">4</span> <span class="n">bit</span> <span class="n">value</span> <span class="n">to</span> <span class="n">obtain</span> <span class="n">the</span> <span class="n">right</span> <span class="n">value</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Actually, back when I looked at it, there was no 24-bit integer
encoding, which led me to submitting a <a href="https://github.com/antirez/redis/issues/469">patch</a>, which
was gladly accepted (and corrected for <a href="http://en.wikipedia.org/wiki/Two%27s_complement">two&#8217;s complement</a> support) by <a href="http://invece.org/">antirez</a>.</p>

<p>Since that time I&#8217;ve been noticing different takes on variable-length
integer storage in other projects.</p>

<p>For example <a href="http://www.bitcoin.org">Bitcoin</a> uses <a href="https://en.bitcoin.it/wiki/Protocol_specification#Variable_length_integer">variable-length integers</a> to minimize the total size of the block
chain. The bitcoin algo is as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'> <span class="o">*</span> <span class="n">Examine</span> <span class="n">at</span> <span class="n">the</span> <span class="n">first</span> <span class="n">byte</span>
</span><span class='line'> <span class="o">*</span>  <span class="o">-</span> <span class="n">If</span> <span class="n">that</span> <span class="n">first</span> <span class="n">byte</span> <span class="n">is</span> <span class="n">less</span> <span class="n">than</span> <span class="mi">253</span><span class="p">,</span>
</span><span class='line'> <span class="o">*</span>    <span class="n">use</span> <span class="n">the</span> <span class="n">byte</span> <span class="n">literally</span>
</span><span class='line'> <span class="o">*</span>  <span class="o">-</span> <span class="n">If</span> <span class="n">that</span> <span class="n">first</span> <span class="n">byte</span> <span class="n">is</span> <span class="mi">253</span><span class="p">,</span> <span class="n">read</span> <span class="n">the</span> <span class="n">next</span> <span class="n">two</span> <span class="n">bytes</span>
</span><span class='line'> <span class="o">*</span>    <span class="n">as</span> <span class="n">a</span> <span class="n">little</span> <span class="n">endian</span> <span class="mi">16</span><span class="o">-</span><span class="n">bit</span> <span class="n">number</span> <span class="p">(</span><span class="n">total</span> <span class="n">bytes</span> <span class="n">read</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
</span><span class='line'> <span class="o">*</span>  <span class="o">-</span> <span class="n">If</span> <span class="n">that</span> <span class="n">first</span> <span class="n">byte</span> <span class="n">is</span> <span class="mi">254</span><span class="p">,</span> <span class="n">read</span> <span class="n">the</span> <span class="n">next</span> <span class="n">four</span> <span class="n">bytes</span>
</span><span class='line'> <span class="o">*</span>    <span class="n">as</span> <span class="n">a</span> <span class="n">little</span> <span class="n">endian</span> <span class="mi">32</span><span class="o">-</span><span class="n">bit</span> <span class="n">number</span> <span class="p">(</span><span class="n">total</span> <span class="n">bytes</span> <span class="n">read</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
</span><span class='line'> <span class="o">*</span>  <span class="o">-</span> <span class="n">If</span> <span class="n">that</span> <span class="n">first</span> <span class="n">byte</span> <span class="n">is</span> <span class="mi">255</span><span class="p">,</span> <span class="n">read</span> <span class="n">the</span> <span class="n">next</span> <span class="n">eight</span> <span class="n">bytes</span>
</span><span class='line'> <span class="o">*</span>   <span class="n">as</span> <span class="n">a</span> <span class="n">little</span> <span class="n">endian</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span> <span class="n">number</span> <span class="p">(</span><span class="n">total</span> <span class="n">bytes</span> <span class="n">read</span> <span class="o">=</span> <span class="mi">9</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="sqlite.org">SQLite3</a> uses its own variable-length integer format,
possibly cleverer than the two above:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="o">**</span> <span class="n">Cell</span> <span class="n">content</span> <span class="n">makes</span> <span class="n">use</span> <span class="n">of</span> <span class="n">variable</span> <span class="n">length</span> <span class="n">integers</span><span class="p">.</span>  <span class="n">A</span> <span class="n">variable</span>
</span><span class='line'><span class="o">**</span> <span class="n">length</span> <span class="n">integer</span> <span class="n">is</span> <span class="mi">1</span> <span class="n">to</span> <span class="mi">9</span> <span class="n">bytes</span> <span class="n">where</span> <span class="n">the</span> <span class="n">lower</span> <span class="mi">7</span> <span class="n">bits</span> <span class="n">of</span> <span class="n">each</span>
</span><span class='line'><span class="o">**</span> <span class="n">byte</span> <span class="n">are</span> <span class="n">used</span><span class="p">.</span>  <span class="n">The</span> <span class="n">integer</span> <span class="n">consists</span> <span class="n">of</span> <span class="n">all</span> <span class="n">bytes</span> <span class="n">that</span> <span class="n">have</span> <span class="n">bit</span> <span class="mi">8</span> <span class="n">set</span> <span class="n">and</span>
</span><span class='line'><span class="o">**</span> <span class="n">the</span> <span class="n">first</span> <span class="n">byte</span> <span class="n">with</span> <span class="n">bit</span> <span class="mi">8</span> <span class="n">clear</span><span class="p">.</span>  <span class="n">The</span> <span class="n">most</span> <span class="n">significant</span> <span class="n">byte</span> <span class="n">of</span> <span class="n">the</span> <span class="n">integer</span>
</span><span class='line'><span class="o">**</span> <span class="n">appears</span> <span class="n">first</span><span class="p">.</span>  <span class="n">A</span> <span class="n">variable</span><span class="o">-</span><span class="n">length</span> <span class="n">integer</span> <span class="n">may</span> <span class="n">not</span> <span class="n">be</span> <span class="n">more</span> <span class="n">than</span> <span class="mi">9</span> <span class="n">bytes</span> <span class="kt">long</span><span class="p">.</span>
</span><span class='line'><span class="o">**</span> <span class="n">As</span> <span class="n">a</span> <span class="n">special</span> <span class="k">case</span><span class="p">,</span> <span class="n">all</span> <span class="mi">8</span> <span class="n">bytes</span> <span class="n">of</span> <span class="n">the</span> <span class="mi">9</span><span class="n">th</span> <span class="n">byte</span> <span class="n">are</span> <span class="n">used</span> <span class="n">as</span> <span class="n">data</span><span class="p">.</span>  <span class="n">This</span>
</span><span class='line'><span class="o">**</span> <span class="n">allows</span> <span class="n">a</span> <span class="mi">64</span><span class="o">-</span><span class="n">bit</span> <span class="n">integer</span> <span class="n">to</span> <span class="n">be</span> <span class="n">encoded</span> <span class="n">in</span> <span class="mi">9</span> <span class="n">bytes</span><span class="p">.</span>
</span><span class='line'><span class="o">**</span>
</span><span class='line'><span class="o">**</span>    <span class="mh">0x00</span>                      <span class="n">becomes</span>  <span class="mh">0x00000000</span>
</span><span class='line'><span class="o">**</span>    <span class="mh">0x7f</span>                      <span class="n">becomes</span>  <span class="mh">0x0000007f</span>
</span><span class='line'><span class="o">**</span>    <span class="mh">0x81</span> <span class="mh">0x00</span>                 <span class="n">becomes</span>  <span class="mh">0x00000080</span>
</span><span class='line'><span class="o">**</span>    <span class="mh">0x82</span> <span class="mh">0x00</span>                 <span class="n">becomes</span>  <span class="mh">0x00000100</span>
</span><span class='line'><span class="o">**</span>    <span class="mh">0x80</span> <span class="mh">0x7f</span>                 <span class="n">becomes</span>  <span class="mh">0x0000007f</span>
</span><span class='line'><span class="o">**</span>    <span class="mh">0x8a</span> <span class="mh">0x91</span> <span class="mh">0xd1</span> <span class="mh">0xac</span> <span class="mh">0x78</span>  <span class="n">becomes</span>  <span class="mh">0x12345678</span>
</span><span class='line'><span class="o">**</span>    <span class="mh">0x81</span> <span class="mh">0x81</span> <span class="mh">0x81</span> <span class="mh">0x81</span> <span class="mh">0x01</span>  <span class="n">becomes</span>  <span class="mh">0x10204081</span>
</span><span class='line'><span class="o">**</span>
</span><span class='line'><span class="o">**</span> <span class="n">Variable</span> <span class="n">length</span> <span class="n">integers</span> <span class="n">are</span> <span class="n">used</span> <span class="k">for</span> <span class="n">rowids</span> <span class="n">and</span> <span class="n">to</span> <span class="n">hold</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span>
</span><span class='line'><span class="o">**</span> <span class="n">bytes</span> <span class="n">of</span> <span class="n">key</span> <span class="n">and</span> <span class="n">data</span> <span class="n">in</span> <span class="n">a</span> <span class="n">btree</span> <span class="n">cell</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are also other more sophisticated techniques of storing lists of integers such as
<a href="http://en.wikipedia.org/wiki/Elias_gamma">Elias encoding</a> and <a href="http://en.wikipedia.org/wiki/Golomb_coding">Golomb coding</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Testing out Octopress]]></title>
    <link href="http://grisha.org/blog/2013/03/25/how-does-this-work/"/>
    <updated>2013-03-25T11:46:00-04:00</updated>
    <id>http://grisha.org/blog/2013/03/25/how-does-this-work</id>
    <content type="html"><![CDATA[<p>Thanks to <a href="http://octopress.org">Octopress</a> and <a href="http://github.com">Github</a> I blog&#8230;.</p>

<p>And I Tweet, too?</p>

<blockquote class="twitter-tweet"><p>Thanks to Octopress and Github pages I now have a blog: <a href="http://t.co/yKm0TVRMMu" title="http://grisha.org/">grisha.org</a></p>&mdash; Grisha Trubetskoy (@humblehack) <a href="https://twitter.com/humblehack/status/316339220371349508">March 26, 2013</a></blockquote>


<script async src="http://grisha.org//platform.twitter.com/widgets.js" charset="utf-8"></script>



]]></content>
  </entry>
  
</feed>
