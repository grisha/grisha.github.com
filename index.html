
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Gregory Trubetskoy</title>
  <meta name="author" content="Gregory Trubetskoy">

  
  <meta name="description" content="When doing computing that requires data to be local to the machine,
e.g. model training on a GPU, data may be downloaded from tables in
BigQuery or &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://grisha.org">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Gregory Trubetskoy" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<!-- MathJax -->
<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$']],
    processEscapes: true,
  },
  messageStyle: "none",
  "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
  });
</script>
<!-- <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-42971867-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Gregory Trubetskoy</a></h1>
  
    <h2>Notes to self.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:grisha.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2020/05/08/mini-bigquery-etl-in-python-with-bq-etl/">Keeping ETL in BigQuery&nbsp;with&nbsp;bq_etl.</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2020-05-08T12:22:00-04:00" pubdate data-updated="true">May 8<span>th</span>, 2020</time>
        
         | <a href="/blog/2020/05/08/mini-bigquery-etl-in-python-with-bq-etl/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>When doing computing that requires data to be local to the machine,
e.g. model training on a GPU, data may be downloaded from tables in
BigQuery or similar SQL-centric environments such as Hadoop/Hive. (The
<a href="https://github.com/grisha/bq_etl">project</a> I describe here is
BigQuery-specific for now, but the concept applies and can be extended
to any such tool).</p>

<p>There is always the question of when does one bring data out of
BigQuery and how much more data transformation is acceptible
afterwards. I believe that the correct answer is a rather strong
“none”: all possible data transformation should be done <em>before</em> the
data leave BigQuery.</p>

<p>Reality is oft otherwise. Once information is downloaded to local
storage, it is much easier to load up a Pandas dataframe for a quick
tweak.  Even though the proper fix would be to correct the SQL and run
it again, it is just too convenient to adjust data locally. Once a
dataset has been corrected locally, possibly multiple times as part of
development iteration, it becomes critically important to somehow keep
track of which files result from which code version. You can hopefully
see how this is gradually becoming a data nightmare.</p>

<p>Data monkey patching is difficult to track because the place in code
where it happens usually is not in any way tied to the SQL statement
for which it is correcting. The SQL defining the original data may be
in a different code base or in none at all.</p>

<p>Here is my simple solution. It starts with a few requirements:</p>

<blockquote>
  <ul>
    <li>Each SQL statement should be in its own .sql file.</li>
  </ul>
</blockquote>

<p>This makes it possible to view and edit this code as what it is - SQL,
not a string in Python code.</p>

<blockquote>
  <ul>
    <li>The name and the content of the .sql file should dictate the name
of the output table.</li>
  </ul>
</blockquote>

<p>The simplest way to do this is with a short hash of the contents
appended to the table name. Once that is true, the .sql file becomes a
complete description of the output table. If the SQL file is altered,
it would result in a different table.</p>

<blockquote>
  <ul>
    <li>There should be no need to use external tools to keep track of
the state.</li>
  </ul>
</blockquote>

<p>You do not need MLFlow or Redis to know that the SQL has been
executed - the mere table’s existence in BigQuery is evidence of it.</p>

<blockquote>
  <ul>
    <li>The location of  any GCS extracts from this table should uniquely match the table name.</li>
  </ul>
</blockquote>

<p>If the blob(s) exist, it means that the extract has been performed.</p>

<blockquote>
  <ul>
    <li>The local filename should still depend on the original .sql file.</li>
  </ul>
</blockquote>

<p>Which makes it easy to check whether the data has been downloaded to
local storage.</p>

<p>Note that given the above scheme, if the name or the content of the
.sql file changes, so does the table name, the GCS extract name and
the local file name.</p>

<p>Given the above few constraints, we can now answer the questions of
“Should this SQL be executed or has it already been done?”, “Should
this table be extracted to GCS?” and “Should this GCS data be
downloaded?” and optionally forego these steps if they are already
done.</p>

<blockquote>
  <ul>
    <li>The order of execution of .sql files should be inferred from the
SQL itself.</li>
  </ul>
</blockquote>

<p>Last but no the least, if we have multiple SQL statements to be
executed, what dictates the order of execution? It turns out that SQL
statements do not need to be executed in any particular order <em>unless</em>
the output of one is input to another. As I have <a href="/blog/2016/11/14/table-names-from-sql/">written about before</a>,
this is best inferred
from the SQL itself and does not need to be explicitely
specified.</p>

<p>Last week I put together a simplistic little package that does all of
the above. See it on Github at <a href="https://github.com/grisha/bq_etl">https://github.com/grisha/bq_etl</a>.</p>

<p>It was written to serve my specific needs and for this reason it is
very bare-bones, but that’s not to say I’m not open to comments,
issues and pull requests to make it better!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/06/19/sql-dag/">Implicit SQL DAG in Maestro</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2019-06-19T17:17:00-04:00" pubdate data-updated="true">Jun 19<span>th</span>, 2019</time>
        
         | <a href="/blog/2019/06/19/sql-dag/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Earlier I <a href="/blog/2019/06/05/maestro-is-open-source/">wrote about Maestro</a>,
a tool that we recently <a href="https://github.com/voxmedia/maestro/">open-sourced</a>.
At first glance, Maestro may appear to be yet another data pipeline
orchestration tool. What sets Maestro apart is that it is confined to
SQL only.</p>

<p>Maestro leverages the fact that any SQL statement declares its
prerequisites. In other words a collection of SQL statements already is
a <em>Directed</em> (and hopefully <em>Acyclic</em>) <em>Graph</em>.</p>

<p>Here is a simple example:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="c1">-- table foo created with</span>
</span><span class="line"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">bar</span>
</span><span class="line">
</span><span class="line"><span class="c1">-- table baz created with</span>
</span><span class="line"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">baz</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Upon examination of above two statements, it is clear that the table
<code>baz</code> must exist first, then the bottom statement can be executed to
create the table <code>bar</code> and lastly we can create <code>foo</code> by running the
first statement. We can picture the above DAG like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">  baz &lt;- bar &lt;- foo
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here is a slightly more complicated example:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="c1">-- table foo created with</span>
</span><span class="line"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">bar</span>
</span><span class="line">
</span><span class="line"><span class="c1">-- table baz created with</span>
</span><span class="line"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">baz</span>
</span><span class="line">
</span><span class="line"><span class="c1">-- table bleh</span>
</span><span class="line"><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">bar</span> <span class="k">JOIN</span> <span class="n">foo</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This DAG looks like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="text"><span class="line">  baz &lt;- bar &lt;- foo
</span><span class="line">          ^      ^
</span><span class="line">          |      |
</span><span class="line">          +------+-- bleh
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>It’s a rather simple idea. The only bit of configuration that Maestro
has to keep that SQL does not provide is the table name, because <code>foo</code>
cannot be inferred from <code>SELECT * FROM bar</code>.</p>

<p>Armed with this observation, we can now conceive of a tool which is a
collection of SQL statements, each having a name. This tool can be
capable of executing these statements in correct order of dependency
absent any other configuration. And that’s what Maestro does.</p>

<p>The main worry to be assuaged is that this approach is somehow
limiting. If our data store is BigQuery, well then SQL is <em>the</em> <em>only</em>
language it speaks. And if the data does indeed need to be processed
outside of BigQuery with SciPy or whatever, then there are many ways
we can invent to accomodate this without having to complicate the
simplicity of tables defined by SQL only.</p>

<p>Not only is this approach hardly limiting, on the contrary, it is
quite empowering. To create and schedule a new table in Maestro is a
matter of a few clicks, there is no coding involved
(aside from the SQL statement itself, of course).</p>

<p>The design limitation affecting most other pipeline orchestrators is
the assumption that a data processing task is more than an SQL
statement. With this caveat in place, the dependency has to be
specified explicitly. Ironically, the task frequently ends up being just an
SQL statement, but because of the extra flexibility assumed by the
tool, it must be wrapped in Python or some other language.</p>

<p>The beauty of Maestro’s DAG is that it is implicit, not explicit.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2019/06/05/maestro-is-open-source/">Maestro the BigQuery Orchestrator</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2019-06-05T15:59:00-04:00" pubdate data-updated="true">Jun 5<span>th</span>, 2019</time>
        
         | <a href="/blog/2019/06/05/maestro-is-open-source/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This blog post is mostly for the Google BigQuery nerds out there.  I
am delighted to announce that a little project we’ve been hacking on
for the past two years has been made open source under the Apache 2.0
license: <a href="https://github.com/voxmedia/maestro">https://github.com/voxmedia/maestro</a>.</p>

<p>Maestro is a trusty tool that imports data from our databases every
night and runs a bunch of BigQuery SQL to generate summaries,
analysis, recommendations, etc. If anything goes wrong, it lets us
know by posting to Slack. It also keeps track of resource utilization
so we can easily tell what each data transformation is costing
us. Maestro keeps track of who created which table so that when
there is a problem, we know whom to ask about it. All SQL changes are
pushed to Github, so that if anything is broken, it is trivial to
figure out what may have caused it by looking at the commit history.</p>

<p>Before Maestro we had a bunch of scripts and cron jobs, and we also
experimented with the multitude of data pipeline tools out there. The
problem was that adding a new SQL statement always required some form
of programming. The second problem was the interdependency management,
i.e. how does one script know that the other thing it relies on is
finished so it can start. Both problems are typically addressed in
ways that are error prone and inefficient. Not to mention that each
job  would be done differently, with varying levels of error
management and notifications. Maestro solved all that.</p>

<p>We still use scripts and cronjobs, and things like Airflow, and
probably will be using them forever. But when it comes to periodically
running some SQL to generate a summary table or importing another
table from a database, Maestro is clearly the first choice.</p>

<p>Maestro is a web app, though it didn’t start out this way. The first
version was just a daemon which stored its configuration in
Postgres. To change anything we would simply INSERT/UPDATE on the
<code>psql</code> command line. Later we added a crude React UI. The UI leaves a
lot to be desired, but given that the user base is mostly data
engineers and data scientists, no one is complaining.</p>

<p>Maestro requires no programming. The dependency graph is inferred by
examining the SQL, which is how it should be. Everything is in one
place, all errors and notifications are always consistent.</p>

<p>In addition to having a UI, Maestro also has a
<a href="https://github.com/voxmedia/maestro/tree/master/pythonlib">Python client library</a>
making it very easy to integrate with your favorite data science packages.
Maestro can also export tables as CSV to Google Cloud Storage and
notify your other apps via HTTP when it is done. It can also export
tables to Google Sheets for the humans.</p>

<p>Maestro is written in Go. It is trivial to deploy - it is a single
binary which only requires access to a database to store its
configuration and state. The binary can be compiled with all web
assets baked into itself and deployed in a <code>FROM scratch</code>
Docker container only megabytes in size. Being a Go program also makes
it quite performant when it comes to transferring data between
databases and BigQuery.</p>

<p><a href="https://github.com/voxmedia/maestro">Maestro source code</a> is in
Github and there is quite a bit of documentation in
<a href="https://godoc.org/github.com/voxmedia/maestro">Maestro godoc</a>, including the
<a href="https://godoc.org/github.com/voxmedia/maestro#hdr-Getting_Started">getting started</a>
instructions.</p>

<p>The structure of the source code and the UI implementation follows the
guidelines I set out in a series of <a href="https://grisha.org/blog/2017/04/27/simplistic-go-web-app/">previous posts</a>
on building Golang web apps.</p>

<p>Please check it out and let us know via Github issues if you have any
questions, comments, feature suggestions, etc.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/10/18/relative-imports-hack-in-go/">Relative Imports Hack in Golang</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-10-18T12:42:00-04:00" pubdate data-updated="true">Oct 18<span>th</span>, 2018</time>
        
         | <a href="/blog/2018/10/18/relative-imports-hack-in-go/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If you have multiple packages in your program’s Go source code, you
probably have come across a situation where if you create a fork on
Github or move/rename your top level directory, all your import
statements need to be adjusted.</p>

<p>There is a simple hack to accomplish relative imports by using the
<code>vendor</code> directory and symlinks. If you have a package directory
called <code>mypkg</code>, then the following should work:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>mkdir -p vendor/relative
</span><span class="line"><span class="nv">$ </span>ln -s ../../mypkg vendor/relative/mypkg
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>And now, your Go code could do this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">main</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">    <span class="s">&quot;fmt&quot;</span>
</span><span class="line">
</span><span class="line">    <span class="s">&quot;relative/mypkg&quot;</span>
</span><span class="line"><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I cannot think of any downsides to this approach, if you know of any,
please do comment!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2018/01/23/explaining-proof-of-work/">Blockchain Proof-of-Work Is a Decentralized Clock</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2018-01-23T11:41:00-05:00" pubdate data-updated="true">Jan 23<span>rd</span>, 2018</time>
        
         | <a href="/blog/2018/01/23/explaining-proof-of-work/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is an explanation of the key function on Proof-of-Work in the
Bitcoin blockchain.  It focuses on the one feature of Proof-of-Work
that is essential and shows that other features often talked about
such as security are secondary side-effects, useful, but not
essential.</p>

<p>This explanation rests on illustrating a few interesting properties of
how Proof-of-Work is used in the blockchain that are not immediately
obvious and sometimes are rather counter-intuitive, for example how
participants collectively solve a problem without <em>ever
communicating</em>.</p>

<p>Having understood each of these properties, one should conclude that
Proof-of-Work is primarily a mechanism which accomplishes a
distributed and decentralized system of timing, i.e. a clock.</p>

<p>Note that this write up isn’t about Proof-of-Work <em>per se</em>, it explains how the
blockchain takes advantage of it. If you do not know anything about Proof-of-Work,
then <a href="https://en.bitcoin.it/wiki/Proof_of_work">this</a> link might be a
good start.</p>

<h2 id="the-decentralized-ledger-time-ordering-problem">The Decentralized Ledger Time Ordering Problem</h2>

<p>Before describing the solution, let us focus on the problem. Much of
the literature around Proof-of-Work is so confusing because it
attempts to explain the solution without first identifying the
problem.</p>

<p>Any ledger absolutely needs order. One cannot spend money that has not
been received, nor can one spend money that is already
spent. Blockchain transactions (or blocks containing them) must be
ordered, unambiguously, and without the need for a trusted third
party.</p>

<p>Even if the blockchain was not a ledger but just data like a log of
some sort, for every node to have an identical copy of the blockchain,
order is required. A blockchain in a different order is a different
blockchain.</p>

<p>But if transactions are generated by anonymous participants all over
the world, and no central party is responsible for organizing the
list, how can it be done? For example transactions (or blocks) could
include timestamps, but how could these timestamps be trusted?</p>

<p>Time is but a <a href="http://www.preposterousuniverse.com/blog/2015/04/03/the-reality-of-time/">human concept</a>,
and any source of it, such as an atomic clock,
is a “trusted third party”. Which, on top of everything, is
<a href="https://www.youtube.com/watch?v=-6rWqJhDv7M">slightly wrong</a>  most of time due to network delays as well as
the <a href="http://www.astronomy.ohio-state.edu/~pogge/Ast162/Unit5/gps.html">effects of Relativity</a>.
Even <a href="https://en.wikipedia.org/wiki/Time_dilation">time dilation</a> between someone in an airplane vs
the ground, though minute, is sufficient to make ordering impossible.
Paradoxically, relying on a timestamp to
determine event order is not possible in a decentralized geographically dispersed system.</p>

<p>The “time” we are interested in is not the year, month, day, etc. that
we are used to. What we need is a mechanism by which we can verify that
one event took place before another or perhaps concurrently.</p>

<p>First though, for the notions of before and after to be applicable, a
<em>point in time</em> needs to be established. Establishing a point in time
may seem theoretically impossible at first because there is no
technology accurate enough to measure a
<a href="https://en.wikipedia.org/wiki/Planck_time">Planck</a>.  But as you’ll
see, Bitcoin works around this by creating its own notion of time
where precise points in time are in fact possible.</p>

<p>This problem is well described in
<a href="https://en.wikipedia.org/wiki/Leslie_Lamport">Leslie Lamport’s</a> 1978 paper
<a href="https://amturing.acm.org/p558-lamport.pdf">“Time, Clocks, and the Ordering of Events in a Distributed System”</a>
which doesn’t actually provide a comprehensive solution other than
“properly synchronized physical clocks”. In 1982 Lamport also
described the <a href="https://people.eecs.berkeley.edu/~luca/cs174/byzantine.pdf">“Byzantine Generals Problem”</a>,
and Satoshi in one of his first emails <a href="http://satoshi.nakamotoinstitute.org/emails/cryptography/11/">explains</a>,
how Proof-of-Work is a solution, though the <a href="https://bitcoin.org/bitcoin.pdf">Bitcoin paper</a> states “To
implement a distributed <em>timestamp server</em> on a peer-to-peer basis, we
will need to use a proof-of-work system”, suggesting that it
primarily solves the issue of timestamping.</p>

<h2 id="timing-is-the-root-problem">Timing is the Root Problem</h2>

<p>It must be stressed that the <em>impossibility of associating events with points in time</em>
in distributed systems was the unsolved problem that
precluded a decentralized ledger from ever being possible until
Satoshi Nakamoto invented a solution. There are many other technical details that
play into the blockchain, but timing is fundamental and paramount.
Without timing there is no blockchain.</p>

<h2 id="proof-of-work-recap">Proof-of-Work Recap</h2>

<p>Very briefly, the Bitcoin Proof-of-Work is a value whose
<a href="https://en.wikipedia.org/wiki/SHA-2">SHA-2</a> hash
conforms to a certain requirement which makes such a value difficult
to find. The difficulty is established by requiring that the hash is
less than a specific number, the smaller the number, the more rare the
input value and the higher the difficulty of finding it.</p>

<p>It is called “Proof Of Work” because it is known that a value with
such a hash is extremely rare, which means that finding such a value
requires a lot of trial and error, i.e. “work”. Work in turn implies
<em>time</em>.</p>

<p>By varying the requirement, we can vary the difficulty and thus the
probability of such a hash being found. The Bitcoin Difficulty adjusts
dynamically so that a proper hash is found on average once every ten
minutes.</p>

<h2 id="nothing-happens-between-blocks">Nothing Happens Between Blocks</h2>

<p>The state of the chain is reflected by its blocks, and each new block
produces a new state. The blockchain state moves forward one block at
a time, and the average 10 minutes of a block is the smallest measure
of blockchain time.</p>

<h2 id="sha-is-memoryless-and-progress-free">SHA is Memoryless and Progress-Free</h2>

<p>The Secure Hash Algorithm is what is known in statistics and
probability as <a href="https://en.wikipedia.org/wiki/Memorylessness"><em>memoryless</em></a>.
This is a property that is particularly counter-intuitive for us humans.</p>

<p>The best example of memoryless-ness is a coin toss. If a coin comes up
heads 10 times in a row, does it mean that the next toss is more
likely to be tails? Our intuition says yes, but in reality each toss
has a 50/50 chance of either outcome regardless of what happened immediately
prior.</p>

<p>Memorylessness is required for the problem to be <em>progress-free</em>.
Progress-free means that as miners try to solve blocks iterating over
<a href="https://en.bitcoin.it/wiki/Nonce">nonces</a>, each attempt is a
stand-alone event and the probability of finding a solution is
constant at each attempt, regardless of how much work has been done in
the past. In other words at each attempt the participant is not
getting any “closer” to a solution or is making no progress. And a miner
who’s been looking for a solution for a year isn’t more likely to
solve a block at the next attempt than a miner who started a second ago.</p>

<p>The probability of finding the solution given a specific difficulty in
a given period of time is therefore determined <em>solely by the speed at
which all participants can iterate through the hashes</em>. Not the prior
history, not the data, just the hashrate.</p>

<p>The hashrate in turn is a function of the number of participants and
the speed of the equipment used to calculate the hash.</p>

<p>(NB: Though strictly speaking SHA is not progress-free because there is a
finite number of hashes, the range of a 256-bit integer is so
vast that it is practically progress-free.)</p>

<h2 id="the-sha-input-is-irrelevant">The SHA Input is Irrelevant</h2>

<p>In the Bitcoin blockchain the input is a block header.
But if we just fed it random values, the probability of finding a
conforming hash would <em>still be the same</em>. Regardless of whether the
input is a valid block header or bytes from /dev/random, it is going
to take 10 minutes on average to find a solution.</p>

<p>Of course if you find a conforming hash but your input wasn’t a valid
block, such a solution cannot be added to the blockchain, but it is
still Proof-of-Work (albeit useless).</p>

<h2 id="the-difficulty-is-intergalactic">The Difficulty is Intergalactic</h2>

<p>Curiously, the difficulty is <em>universal</em>, meaning it spans the entire
universe. We could have miners on Mars helping out, they do not need
to know, or communicate with the Earth miners, the problem would still be
solved every 10 minutes. (Ok, they’ll need to somehow tell the Earth
people that they solved it if they do, or else we’ll never know about
it.)</p>

<p>Remarkably, the distant participants are communicating without
actually communicating, because they are collectively solving the same
statistical problem and yet they’re not even aware of each other’s
existence.</p>

<p>This “universal property” while at first seemingly magical is actually
easy to explain. I used the term “universal” because it describes it
well in one word, but really it means “known by every participant”.</p>

<p>The input to SHA-256 can be thought of as an integer between 0 and
2<sup>256</sup> (because the output is 32 bytes, i.e. also between 0
and 2<sup>256</sup>, anything larger guarantees a collision,
i.e. becomes redundant). Even though it is extremely large
(<a href="https://learncryptography.com/cryptanalysis/why-is-2-256-secure">exponentially larger</a>
than the number of atoms in the perceivable universe), it is a set of numbers that is known by every participant
and the participants can only pick from this set.</p>

<p>If the input set is universally known, the function (SHA-256) is
universally known, as well as the difficulty requirement is universally known,
then the probability of finding a solution is also indeed “universal”.</p>

<h2 id="trying-a-sha-makes-you-a-participant">Trying a SHA Makes You a Participant</h2>

<p>If the stated problem is to find a conforming hash, all you have to do
is to try it once, and bingo, you’ve affected the global hash rate,
and for that one attempt you were a participant helping others solve
the problem. You did not need to tell others that you did it (unless
you actually found a solution), others didn’t need to know about it,
but your attempt <em>did</em> affect the outcome. For the whole universe, no
less.</p>

<p>If the above still seems suspicious, a good analogy might be the
problem of finding large prime numbers. Finding the largest prime
number is hard and once one is found, it becomes “discovered” or
“known”. There is an infinite number of prime numbers, but only one
instance of each number in the universe. Therefore whoever attempts to
find the largest prime is working on the same problem, not a separate
instance of it. You do not need to tell anyone you decided to look for
the largest prime, you only need to announce when you find one. If no
one ever looks for the largest prime, then it is never going to be
found. Thus, participation (i.e. an attempt to find one), even if it’s
in total secrecy, still affects the outcome, as long as the final
discovery (if found at all) is publicized.</p>

<p>Taking advantage of this mind-boggling probabilistic phenomenon whereby
any participation affects the outcome even if in complete secrecy and
without success, <em>is</em> what makes Satoshi’s invention so remarkably
brilliant.</p>

<p>It is noteworthy that since SHA is progress-free, each attempt could be
thought of as a participant joining the effort and immediately
leaving. Thus miners join and leave, quintillions of times per second.</p>

<h2 id="the-participation-is-revealed-in-statistics">The Participation is Revealed in Statistics</h2>

<p>The magical secret participation property also works in reverse. The
global hashrate listed on many sites is known not because every miner
registered at some “miners registration office” where they report
their hash rate periodically. No such thing exists.</p>

<p>The hash rate is known because for a solution of a specific difficulty
to be found in 10 minutes, on average this many attempts
(~10<sup>21</sup> as of this writing) had to have been made by someone
somewhere.</p>

<p>We do not know who these participants are, they never announced that
they are working, those who did not find a solution (which is
practically all of them) never told anyone they were working, their
location could have been anywhere in the universe, and yet we know
with absolute certainty that they exist. Simply because the problem
continues to be solved.</p>

<h2 id="work-is-a-clock">Work is a Clock</h2>

<p>And there is the crux of it: The difficulty in finding a conforming
hash acts as <em>a clock</em>. A universal clock, if you will, because there
is only one such clock in the universe, and thus there is nothing to
sync and anyone can “look” at it.</p>

<p>It doesn’t matter that this clock is imprecise. What matters is that
it is the same clock for everyone and that the state of the
chain can be tied unambiguously to the ticks of this clock.</p>

<p>This clock is operated by the multi-exahash rate of an unknown
number of collective participants spread across the planet,
completely independent of one another.</p>

<h2 id="last-piece-of-the-puzzle">Last Piece of the Puzzle</h2>

<p>The solution must be the hash of a block (the block header, to be precise). As
we mentioned, the input doesn’t matter, but if it is an actual block,
then whenever a solution is found, it happened at the tick of our
Proof-of-Work clock. Not before, not after, but <em>exactly at</em>. We know
this unambiguosly because the block was part of that mechanism.</p>

<p>To put it another way, if blocks weren’t the input to the SHA256
function, we’d still have a distributed clock, but we couldn’t tie blocks to
the ticks of this clock. Using blocks as input addresses this issue.</p>

<p>Noteworthy, our Proof-of-Work clock only provides us with ticks. There
is no way tell order from the ticks, this is what the hash chain is
for.</p>

<h2 id="what-about-the-distributed-consensus">What About the Distributed Consensus?</h2>

<p>Consensus means agreement. What all participants have no choice but to
agree on is that <em>the clock has ticked</em>. Also that everyone knows the
tick and the data attached to it. And this, in fact, does solve the
Byzantine Generals Problem, as Satoshi explained in an email
referenced earlier.</p>

<p>There is a separate consensus in a rare but common case of two
consecutive ticks being associated with conflicting blocks. The
conflict is resolved by what block will be associated with the next
tick, rendering one of the disputed blocks “orphan”. How the chain will
continue is a matter of chance, and so this too could probably be
indirectly attributed to the Proof-of-Work clock.</p>

<h2 id="and-that-is-it">And that is it</h2>

<p>This is what Proof-of-Work does for the blockchain. It is not a
“lottery” where miners win the right to solve a block, nor is it some
peculiar conversion of real energy into a valuable concept, those
are all red herrings.</p>

<p>For example the lottery and the miner’s reward aspect is what
encourages miners to participate, but it isn’t what makes the
blockchain possible. Blocks hashes form a chain, but again, that has
nothing to do with Proof-of-Work, it cryptographically reinforces
recording of the block ordering. The hash chain also makes the
previous ticks “more certain”, “less deniable” or simply more secure.</p>

<p>Proof-of-Work is also the mechanism by which blocks become effectively
immutable, and that’s a nice side-effect which makes Segregated
Witness possible, but it could just as well be done by preserving the
signatures (witness), so this too is secondary.</p>

<h2 id="conclusion">Conclusion</h2>

<p>The Bitcoin blockchain Proof-of-Work is simply a distributed, decentralized clock.</p>

<p>If you understand this explanation, then you should have a much better
grasp of how Proof-of-Work compares to <a href="https://en.wikipedia.org/wiki/Proof-of-stake">Proof-of-Stake</a>,
and it should
be apparent that the two are not comparable: Proof-Of-Stake is about
(randomly distributed) authority, while Proof-of-Work is a clock.</p>

<p>In the context of the blockchain, Proof-of-Work is probably a
misnomer. The term is a legacy from the
<a href="https://en.wikipedia.org/wiki/Hashcash">Hashcash</a> project, where it
indeed served to prove work. In the blockchain it is primarily about
verifiably taking time. When one sees a hash that satisfies the
difficulty, one knows it must have taken time. The method by which the
delay is accomplished is “work”, but the hash is primarily interesting
because it is a proof of <em>time</em>.</p>

<p>The fact that Proof-of-Work is all about time rather than work also
suggests that there may be other similar statistical challenges that
are time-consuming but require less energy. It may also mean that the
Bitcoin hashrate is excessive and that the Bitcoin clock we described
above could operate as reliably on a fraction of the hashrate, but it
is the incentive structure that drives up the energy consumption.</p>

<p>Figuring out a way to pace ticks with less work is a trillion dollar
problem, if you find one, please do let me know!</p>

<p>P.S. Special thanks to <a href="http://sashat.me">Sasha Trubetskoy</a> of
<a href="https://galton.uchicago.edu/">UChicago Statistics</a>
for the review and suggestions for the above text.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/12/15/blockchain-and-postgres/">The Bitcoin Blockchain PostgresSQL Schema</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-12-15T08:28:00-05:00" pubdate data-updated="true">Dec 15<span>th</span>, 2017</time>
        
         | <a href="/blog/2017/12/15/blockchain-and-postgres/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In a <a href="/blog/2017/10/10/postgre-as-a-full-node/">previous post</a> I wrote
some initial thoughts on storing the blockchain in Postgres. It’s been
a couple of months and I’ve made some progress on the
<a href="https://github.com/blkchain/blkchain">import project</a>. This post documents
the latest incarnation of the SQL schema used to store the
blockchain as well as thoughts on why it was decided to be this way.</p>

<h2 id="blockchain-data-structure-overview">Blockchain Data Structure Overview</h2>

<p>The <a href="https://bitcoin.org/en/developer-reference#block-chain">Bitcoin blockchain</a>
consists of <em><a href="https://bitcoin.org/en/developer-reference#serialized-blocks">blocks</a></em>.
A block is a set of <em><a href="https://bitcoin.org/en/developer-reference#raw-transaction-format">transactions</a></em>.
A block also contains some <a href="https://bitcoin.org/en/developer-reference#block-headers">block-specific information</a>,
such as the nonce for the <a href="https://en.bitcoin.it/wiki/Proof_of_work">Proof-Of-Work</a> validating the block.</p>

<p>A transaction consist of <em>inputs</em> and <em>outputs</em>. The inputs reference
outputs from prior transactions, which may include transactions in the
same block. When an output is referenced by an input, the output is
considered spent in its entirety, i.e. there is no way to spend a part
of an output.</p>

<p>When two <em>different</em> transactions’ inputs reference the same output, it is
considered a <em><a href="https://en.wikipedia.org/wiki/Double-spending">double spend</a></em>,
and only one of the spending transactions is valid (the details
of how validity is determined are outside the scope of this write up).
While double-spends do imply that one of the transactions is invalid,
it is not uncommon for double-spends to exist at least for a period of time,
thus the database schema needs to allow them.</p>

<p>A transaction’s input value is the sum of its inputs and the output
value is the sum of its outputs. Naturally, the output value cannot
exceed the input value, but it is normal for the output value to be
<em>less</em> than the input value. The discrepancy between the input and the
output is the transaction <em><a href="https://en.bitcoin.it/wiki/Transaction_fees">fee</a></em>
and is taken by the miner solving the block in which the transaction is included.</p>

<p>The first transaction in a block is referred to as the
<em>coinbase</em>. Coinbase is a special transaction where the inputs refer
to a (non-existent) transaction hash of all zeros. Coinbase outputs
are the sum of all the fees and the <em><a href="https://en.bitcoin.it/wiki/Mining#Reward">miner reward</a></em>.</p>

<p>Curiously it is possible for the same coinbase transaction to be
included in more than one block, and there is at least
<a href="https://blockchain.info/tx/e3bf3d07d4b0375638d5f1db5255fe07ba2c4cb067cd81b84ee974b6585fb468">one case</a>
of this in the blockchain. The implication of this is that the second
instance of such a transaction is unspendable. This oddity was
addressed by a change in the consensus which requires the block
<em>height</em> to be referenced in the coinbase and is since then no longer
possible (see <a href="https://github.com/bitcoin/bips/blob/master/bip-0030.mediawiki">BIP30</a>).</p>

<p>The same transaction can be included in more than one block. This is
common during chain splits, i.e. when more than one miner solves a
block. Eventually one of such blocks will become <em>orphaned</em>, but there
is a period of time during which it is not known which chain is
considered “best”, and the database structure needs to accommodate
this. Chain splits also cause multiple blocks to have the same height
which implies that height alone cannot identify a particular block or
that it is unique.</p>

<p>With introduction of <em>SegWit</em> transactions also include <em>witness</em>
data. Witness is stored at the end of a transaction as a list where
each entry corresponds to an input. A witness entry is in turn a list,
because an input can have multiple signatures (aka witness). Presently
per-input witness list is stored in the input record as a BYTEA.</p>

<h2 id="row-ids-and-hashes">Row Ids and Hashes</h2>

<p>In the blockchain blocks and transactions are always referred to
through their <em>hash</em>. A hash is an array of 32 bytes. While in theory
we could build a schema which relies on the hash as the record
identifier, in practice it is cumbersome compared to the traditional
integer ids. Firstly, 32 bytes is four times larger than a BIGINT and
eight times larger than an INT, which impacts greatly the amount of
space required to store inputs and outputs as well as degrades index
performance. For this reason we use INT for block ids and BIGINT for
transaction ids (INT is not big enough and would overflow in a few
years).</p>

<p>There is also an ambiguity in how the hash is printed versus how it is
stored. While the SHA standard does not specify the endian-ness of the
hash and refers to it as an array of bytes, Satoshi Nakomoto decided
to treat hashes as little-endian 256-bit integers. The implication
being that when the hash is printed (e.g. as a transaction id) the order of
bytes is the reverse of how it is stored in the blockchain.</p>

<p>Using integer ids creates a complication in how inputs reference
outputs. Whereas in the blockchain it is done entirely via a
transaction hash, here we need to also store the integer id of the
referenced transaction (<code>prevout_tx_id</code>). This is an easily
justifiable optimization, without it to lookup the input transaction
would require first finding the transaction integer id. The downside
is that during the initial import maintaining the hash to integer id
correspondence in an efficient manner is bit of a challenge.</p>

<h2 id="integers">Integers</h2>

<p>Most integers in Core are defined as <code>uint32_t</code>, which is an unsigned
4-byte integer. Postgres 4-byte <code>INT</code> is signed, which presents us
with two options: (1) use <code>BIGINT</code> instead, or (2) use <code>INT</code> with the
understanding that larger values may appear as negative. We are opting
for the latter as preserving space is more important and for as long as
all the bits are correct, whether the integer is interpreted as signed
or unsigned is of no consequence.</p>

<h2 id="blocks">Blocks</h2>

<p>Blocks are collections of transactions. It is a many-to-many
relationship as multiple blocks can include to the same transaction. The
<a href="https://github.com/bitcoin/bitcoin/blob/0.15/src/primitives/block.h#L20">CBlockHeader</a>
is defined in Core as follows:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="c++"><span class="line"><span class="k">class</span> <span class="nc">CBlockHeader</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line"><span class="k">public</span><span class="o">:</span>
</span><span class="line">    <span class="c1">// header</span>
</span><span class="line">    <span class="n">int32_t</span> <span class="n">nVersion</span><span class="p">;</span>
</span><span class="line">    <span class="n">uint256</span> <span class="n">hashPrevBlock</span><span class="p">;</span>
</span><span class="line">    <span class="n">uint256</span> <span class="n">hashMerkleRoot</span><span class="p">;</span>
</span><span class="line">    <span class="n">uint32_t</span> <span class="n">nTime</span><span class="p">;</span>
</span><span class="line">    <span class="n">uint32_t</span> <span class="n">nBits</span><span class="p">;</span>
</span><span class="line">    <span class="n">uint32_t</span> <span class="n">nNonce</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Our <code>blocks</code> table is defined as follows:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line">  <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">blocks</span> <span class="p">(</span>
</span><span class="line">   <span class="n">id</span>           <span class="nb">SERIAL</span>
</span><span class="line">  <span class="p">,</span><span class="n">height</span>       <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">hash</span>         <span class="n">BYTEA</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="k">version</span>      <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">prevhash</span>     <span class="n">BYTEA</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">merkleroot</span>   <span class="n">BYTEA</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">time</span>         <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">bits</span>         <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">nonce</span>        <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">orphan</span>       <span class="nb">BOOLEAN</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">DEFAULT</span> <span class="k">false</span>
</span><span class="line">  <span class="p">,</span><span class="n">status</span>       <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">filen</span>        <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">filepos</span>      <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Columns <code>orphan</code>, <code>status</code>, <code>filen</code> and <code>filepos</code> are from the
<a href="https://github.com/bitcoin/bitcoin/blob/0.15/src/chain.h#L170">CBlockIndex</a>
class which is serialized in LevelDb and not formally part of the blockchain.
It contains information about the file in which the block was stored
on-disk as far as Core is concerned. This information is only
necessary for debugging purposes, also note that it is unique to the
particular instance of the Core database, i.e. if you were to wipe it
and download the chain from scratch, location and even status of
blocks is likely to be different.</p>

<p>Note that the C++ <code>CBlockHeader</code> class does not actually include the
hash, it is computed on-the-fly as needed. Same is true with respect
to transaction id.</p>

<p>We also need a many-to-many link to transactions, which is the
<code>block_txs</code> table. Not only do we need to record that a transaction is
included in a block, but also its exact position relative to other
transactions, denoted by the <code>n</code> column:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line">  <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">block_txs</span> <span class="p">(</span>
</span><span class="line">   <span class="n">block_id</span>      <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">n</span>             <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">tx_id</span>         <span class="nb">BIGINT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="transactions">Transactions</h3>

<p>A transaction is a collection of inputs and outputs. The
<a href="https://github.com/bitcoin/bitcoin/blob/0.15/src/primitives/transaction.h#L264">CTransaction</a>
C++ class is defined as follows:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="c++"><span class="line"><span class="k">class</span> <span class="nc">CTransaction</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line"><span class="k">public</span><span class="o">:</span>
</span><span class="line">    <span class="k">const</span> <span class="n">int32_t</span> <span class="n">nVersion</span><span class="p">;</span>
</span><span class="line">    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">CTxIn</span><span class="o">&gt;</span> <span class="n">vin</span><span class="p">;</span>
</span><span class="line">    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">CTxOut</span><span class="o">&gt;</span> <span class="n">vout</span><span class="p">;</span>
</span><span class="line">    <span class="k">const</span> <span class="n">uint32_t</span> <span class="n">nLockTime</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In Postgres transactions are in the <code>txs</code> table:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line">  <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">txs</span> <span class="p">(</span>
</span><span class="line">   <span class="n">id</span>            <span class="n">BIGSERIAL</span>
</span><span class="line">  <span class="p">,</span><span class="n">txid</span>          <span class="n">BYTEA</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="k">version</span>       <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">locktime</span>      <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>txid</code> column is the transaction hash and should not be confused
with <code>tx_id</code> in other tables referencing the transaction. (“txid” is
what the transaction hash is typically called in code and
documentation).</p>

<h2 id="outputs">Outputs</h2>

<p>In Core an output is represented by the
<a href="https://github.com/bitcoin/bitcoin/blob/0.15/src/primitives/transaction.h#L131">CTxOut</a>
class:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="c++"><span class="line"><span class="k">class</span> <span class="nc">CTxOut</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line"><span class="k">public</span><span class="o">:</span>
</span><span class="line">    <span class="n">CAmount</span> <span class="n">nValue</span><span class="p">;</span>
</span><span class="line">    <span class="n">CScript</span> <span class="n">scriptPubKey</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>CAmount</code> type above is a <code>typedef int64_t</code>, it is the value of
the output in <em>satoshis</em> which can be as high as <code>21M * 100M</code> (the
number of satoshis in a bitcoin).</p>

<p>In SQL, an output looks like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line">  <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">txouts</span> <span class="p">(</span>
</span><span class="line">   <span class="n">tx_id</span>        <span class="nb">BIGINT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">n</span>            <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">value</span>        <span class="nb">BIGINT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">scriptpubkey</span> <span class="n">BYTEA</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">spent</span>        <span class="n">BOOL</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>tx_id</code> column is the transaction to which this output belongs, <code>n</code>
is the position within the output list.</p>

<p>The <code>spent</code> column is an optimization, it is not part of the
blockchain. An output is spent if later in the blockchain there exists
an input referencing it. Core maintains a separate LevelDb dataset
called the <em>UTXO Set</em> (Unspent Transaction Output Set) which contains
all unspent outputs. The reason Core does it this way is because by
default it does not index transactions, i.e. Core actually does not
have a way of quickly retrieving a transaction from the store as there
generally is no need for such retrieval as part of a node operation,
while the UTXO Set is both sufficient and smaller than a full
transaction index. Since in Postgres we have no choice but to index
transactions, there is no benefit in having UTXOs as a separate table,
the <code>spent</code> flag serves this purpose instead.</p>

<p>The UTXO Set does not include any outputs with the value of 0, since
there is nothing to spend there even though no input refers to them
and they are not technically spent.</p>

<h2 id="inputs">Inputs</h2>

<p>An input in Core is represented by the
<a href="https://github.com/bitcoin/bitcoin/blob/0.15/src/primitives/transaction.h#L61">CTxIn</a>
class, which looks like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="c++"><span class="line"><span class="k">class</span> <span class="nc">CTxIn</span>
</span><span class="line"><span class="p">{</span>
</span><span class="line"><span class="k">public</span><span class="o">:</span>
</span><span class="line">    <span class="n">COutPoint</span> <span class="n">prevout</span><span class="p">;</span>
</span><span class="line">    <span class="n">CScript</span> <span class="n">scriptSig</span><span class="p">;</span>
</span><span class="line">    <span class="n">uint32_t</span> <span class="n">nSequence</span><span class="p">;</span>
</span><span class="line">    <span class="n">CScriptWitness</span> <span class="n">scriptWitness</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>COutPoint</code> class is a combination of a hash and an integer
representing an output. <code>CScriptWitness</code> is an array of “witnesses” or
(roughly speaking) signatures, which are byte arrays, just like the
<code>scriptSig</code>.</p>

<p>In our schema, an input is defined as:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line">  <span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">txins</span> <span class="p">(</span>
</span><span class="line">   <span class="n">tx_id</span>         <span class="nb">BIGINT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">n</span>             <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">prevout_hash</span>  <span class="n">BYTEA</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">prevout_n</span>     <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">scriptsig</span>     <span class="n">BYTEA</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">sequence</span>      <span class="nb">INT</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line">  <span class="p">,</span><span class="n">witness</span>       <span class="n">BYTEA</span>
</span><span class="line">  <span class="p">,</span><span class="n">prevout_tx_id</span> <span class="nb">BIGINT</span>
</span><span class="line">  <span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>As we already mentioned above <code>witness</code> is stored as opaque bytes. The
<code>prevout_tx_id</code> is the database row id of the transaction this input
is spending.</p>

<h2 id="indexes-and-foreign-key-constraints">Indexes and Foreign Key Constraints</h2>

<p>Blocks and transactions are indexed by <code>id</code> as their primary index.
Blocks also need an index on <code>hash</code> (unique), as well as on <code>height</code>
and on <code>prevhash</code> (not unique).  Transactions need a unique index on
the <code>txid</code>.</p>

<p>Inputs and outputs need <code>(tx_id, n)</code> as primary indexes. Inputs are
also indexed on <code>(prevout_tx_id, prevout_n)</code> so that we can quickly
identify the spending input given an output.</p>

<p>Finally, we need a basic set of foreign key constraints that ensure
the integrity between all the related tables.</p>

<h2 id="triggers">Triggers</h2>

<p>The <code>spent</code> column in the output and the <code>prevout_tx_id</code> of an input
are maintained by a trigger on the <code>txins</code> table. Every time an input
is inserted, it locates the database id of the transaction it spends
as well as updates the <code>spent</code> flag of the corresponding output.</p>

<p>Technically it is done using two triggers for performance
reasons. This is because a trigger that modifies the row being
inserted must be a BEFORE trigger, but BEFORE triggers are not allowed
to be to be CONSTRAINT triggers. CONSTRAINT triggers have the
advantage of being <em>deferrable</em>, i.e. they can be postponed until
(database) transaction commit time. Deferring constraints can speed up
inserts considerably, for this reason the code that updates <code>spent</code> is
in a separate AFTER trigger.</p>

<p>The trigger code is still rough around the edges, but here it is for
posterity anyway:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="n">txins_before_trigger_func</span><span class="p">()</span> <span class="k">RETURNS</span> <span class="k">TRIGGER</span> <span class="k">AS</span> <span class="err">$$</span>
</span><span class="line">  <span class="k">BEGIN</span>
</span><span class="line">    <span class="n">IF</span> <span class="p">(</span><span class="n">TG_OP</span> <span class="o">=</span> <span class="s1">&#39;UPDATE&#39;</span> <span class="k">OR</span> <span class="n">TG_OP</span> <span class="o">=</span> <span class="s1">&#39;INSERT&#39;</span><span class="p">)</span> <span class="k">THEN</span>
</span><span class="line">      <span class="n">IF</span> <span class="k">NEW</span><span class="p">.</span><span class="n">prevout_n</span> <span class="o">&lt;&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="k">AND</span> <span class="k">NEW</span><span class="p">.</span><span class="n">prevout_tx_id</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">THEN</span>
</span><span class="line">        <span class="k">SELECT</span> <span class="n">id</span> <span class="k">INTO</span> <span class="k">NEW</span><span class="p">.</span><span class="n">prevout_tx_id</span> <span class="k">FROM</span> <span class="n">txs</span> <span class="k">WHERE</span> <span class="n">txid</span> <span class="o">=</span> <span class="k">NEW</span><span class="p">.</span><span class="n">prevout_hash</span><span class="p">;</span>
</span><span class="line">        <span class="n">IF</span> <span class="k">NOT</span> <span class="k">FOUND</span> <span class="k">THEN</span>
</span><span class="line">          <span class="n">RAISE</span> <span class="n">EXCEPTION</span> <span class="s1">&#39;Unknown prevout_hash %&#39;</span><span class="p">,</span> <span class="k">NEW</span><span class="p">.</span><span class="n">prevout_hash</span><span class="p">;</span>
</span><span class="line">        <span class="k">END</span> <span class="n">IF</span><span class="p">;</span>
</span><span class="line">      <span class="k">END</span> <span class="n">IF</span><span class="p">;</span>
</span><span class="line">      <span class="k">RETURN</span> <span class="k">NEW</span><span class="p">;</span>
</span><span class="line">    <span class="k">END</span> <span class="n">IF</span><span class="p">;</span>
</span><span class="line">    <span class="k">RETURN</span> <span class="k">NULL</span><span class="p">;</span>
</span><span class="line">  <span class="k">END</span><span class="p">;</span>
</span><span class="line"><span class="err">$$</span> <span class="k">LANGUAGE</span> <span class="n">plpgsql</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="k">CREATE</span> <span class="k">TRIGGER</span> <span class="n">txins_before_trigger</span>
</span><span class="line"><span class="k">BEFORE</span> <span class="k">INSERT</span> <span class="k">OR</span> <span class="k">UPDATE</span> <span class="k">OR</span> <span class="k">DELETE</span> <span class="k">ON</span> <span class="n">txins</span>
</span><span class="line">  <span class="k">FOR</span> <span class="k">EACH</span> <span class="k">ROW</span> <span class="k">EXECUTE</span> <span class="k">PROCEDURE</span> <span class="n">txins_before_trigger_func</span><span class="p">();</span>
</span><span class="line">
</span><span class="line"><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="n">txins_after_trigger_func</span><span class="p">()</span> <span class="k">RETURNS</span> <span class="k">TRIGGER</span> <span class="k">AS</span> <span class="err">$$</span>
</span><span class="line">  <span class="k">BEGIN</span>
</span><span class="line">    <span class="n">IF</span> <span class="p">(</span><span class="n">TG_OP</span> <span class="o">=</span> <span class="s1">&#39;DELETE&#39;</span><span class="p">)</span> <span class="k">THEN</span>
</span><span class="line">      <span class="n">IF</span> <span class="k">OLD</span><span class="p">.</span><span class="n">prevout_tx_id</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">THEN</span>
</span><span class="line">        <span class="k">UPDATE</span> <span class="n">txouts</span> <span class="k">SET</span> <span class="n">spent</span> <span class="o">=</span> <span class="k">FALSE</span>
</span><span class="line">         <span class="k">WHERE</span> <span class="n">tx_id</span> <span class="o">=</span> <span class="n">prevout_tx_id</span> <span class="k">AND</span> <span class="n">n</span> <span class="o">=</span> <span class="k">OLD</span><span class="p">.</span><span class="n">prevout_n</span><span class="p">;</span>
</span><span class="line">      <span class="k">END</span> <span class="n">IF</span><span class="p">;</span>
</span><span class="line">      <span class="k">RETURN</span> <span class="k">OLD</span><span class="p">;</span>
</span><span class="line">    <span class="n">ELSIF</span> <span class="p">(</span><span class="n">TG_OP</span> <span class="o">=</span> <span class="s1">&#39;UPDATE&#39;</span> <span class="k">OR</span> <span class="n">TG_OP</span> <span class="o">=</span> <span class="s1">&#39;INSERT&#39;</span><span class="p">)</span> <span class="k">THEN</span>
</span><span class="line">      <span class="n">IF</span> <span class="k">NEW</span><span class="p">.</span><span class="n">prevout_tx_id</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">THEN</span>
</span><span class="line">        <span class="k">UPDATE</span> <span class="n">txouts</span> <span class="k">SET</span> <span class="n">spent</span> <span class="o">=</span> <span class="k">TRUE</span>
</span><span class="line">         <span class="k">WHERE</span> <span class="n">tx_id</span> <span class="o">=</span> <span class="k">NEW</span><span class="p">.</span><span class="n">prevout_tx_id</span> <span class="k">AND</span> <span class="n">n</span> <span class="o">=</span> <span class="k">NEW</span><span class="p">.</span><span class="n">prevout_n</span><span class="p">;</span>
</span><span class="line">        <span class="n">IF</span> <span class="k">NOT</span> <span class="k">FOUND</span> <span class="k">THEN</span>
</span><span class="line">          <span class="n">RAISE</span> <span class="n">EXCEPTION</span> <span class="s1">&#39;Unknown prevout_n % in txid % (id %)&#39;</span><span class="p">,</span> <span class="k">NEW</span><span class="p">.</span><span class="n">prevout_n</span><span class="p">,</span> <span class="k">NEW</span><span class="p">.</span><span class="n">prevout_hash</span><span class="p">,</span> <span class="k">NEW</span><span class="p">.</span><span class="n">prevout_tx_id</span><span class="p">;</span>
</span><span class="line">        <span class="k">END</span> <span class="n">IF</span><span class="p">;</span>
</span><span class="line">      <span class="k">END</span> <span class="n">IF</span><span class="p">;</span>
</span><span class="line">      <span class="k">RETURN</span> <span class="k">NEW</span><span class="p">;</span>
</span><span class="line">    <span class="k">END</span> <span class="n">IF</span><span class="p">;</span>
</span><span class="line">    <span class="k">RETURN</span> <span class="k">NULL</span><span class="p">;</span>
</span><span class="line">  <span class="k">END</span><span class="p">;</span>
</span><span class="line"><span class="err">$$</span> <span class="k">LANGUAGE</span> <span class="n">plpgsql</span><span class="p">;</span>
</span><span class="line">
</span><span class="line"><span class="k">CREATE</span> <span class="k">CONSTRAINT</span> <span class="k">TRIGGER</span> <span class="n">txins_after_trigger</span>
</span><span class="line"><span class="k">AFTER</span> <span class="k">INSERT</span> <span class="k">OR</span> <span class="k">UPDATE</span> <span class="k">OR</span> <span class="k">DELETE</span> <span class="k">ON</span> <span class="n">txins</span> <span class="k">DEFERRABLE</span>
</span><span class="line">  <span class="k">FOR</span> <span class="k">EACH</span> <span class="k">ROW</span> <span class="k">EXECUTE</span> <span class="k">PROCEDURE</span> <span class="n">txins_after_trigger_func</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="identifying-orphaned-blocks">Identifying Orphaned Blocks</h2>

<p>While this is not part of the schema, I thought it would be
of interest to the readers. An orphaned block is a block to
which no other <code>prevhash</code> refers. At the time of a chain split we
start out with two blocks referring to the same block as previous, but
the next block to arrive will identify one of the two as its previous
thereby orphaning the other of the pair.</p>

<p>To identify orphans we need to walk the chain backwards starting from
the highest height. Any block that this walk does not visit is an
orphan.</p>

<p>In SQL this can be done using the <code>WITH RECURSIVE</code> query like so:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="k">UPDATE</span> <span class="n">blocks</span>
</span><span class="line">   <span class="k">SET</span> <span class="n">orphan</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">orphan</span>
</span><span class="line">  <span class="k">FROM</span> <span class="p">(</span>
</span><span class="line">    <span class="k">SELECT</span> <span class="n">blocks</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">x</span><span class="p">.</span><span class="n">id</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">AS</span> <span class="n">orphan</span>
</span><span class="line">      <span class="k">FROM</span> <span class="n">blocks</span>
</span><span class="line">      <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="p">(</span>
</span><span class="line">        <span class="k">WITH</span> <span class="k">RECURSIVE</span> <span class="n">recur</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">prevhash</span><span class="p">)</span> <span class="k">AS</span> <span class="p">(</span>
</span><span class="line">          <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">prevhash</span><span class="p">,</span> <span class="mi">0</span> <span class="k">AS</span> <span class="n">n</span>
</span><span class="line">            <span class="k">FROM</span> <span class="n">blocks</span>
</span><span class="line">                            <span class="c1">-- this should be faster than MAX(height)</span>
</span><span class="line">           <span class="k">WHERE</span> <span class="n">height</span> <span class="k">IN</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">height</span> <span class="k">FROM</span> <span class="n">blocks</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">height</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">1</span><span class="p">)</span>
</span><span class="line">          <span class="k">UNION</span> <span class="k">ALL</span>
</span><span class="line">            <span class="k">SELECT</span> <span class="n">blocks</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">blocks</span><span class="p">.</span><span class="n">prevhash</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span> <span class="k">AS</span> <span class="n">n</span>
</span><span class="line">              <span class="k">FROM</span> <span class="n">recur</span>
</span><span class="line">              <span class="k">JOIN</span> <span class="n">blocks</span> <span class="k">ON</span> <span class="n">blocks</span><span class="p">.</span><span class="n">hash</span> <span class="o">=</span> <span class="n">recur</span><span class="p">.</span><span class="n">prevhash</span>
</span><span class="line">            <span class="o">%</span><span class="n">s</span>
</span><span class="line">        <span class="p">)</span>
</span><span class="line">        <span class="k">SELECT</span> <span class="n">recur</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">recur</span><span class="p">.</span><span class="n">prevhash</span><span class="p">,</span> <span class="n">n</span>
</span><span class="line">          <span class="k">FROM</span> <span class="n">recur</span>
</span><span class="line">      <span class="p">)</span> <span class="n">x</span> <span class="k">ON</span> <span class="n">blocks</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">x</span><span class="p">.</span><span class="n">id</span>
</span><span class="line">   <span class="p">)</span> <span class="n">a</span>
</span><span class="line">  <span class="k">WHERE</span> <span class="n">blocks</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The WITH RECURSIVE part connects rows by joining prevhash to hash,
thereby building a list which starts at the highest hight and going
towards the beginning until no parent can be found.</p>

<p>Then we LEFT JOIN the above to the blocks table, and where there is
no match (x.id IS NULL) we mark it as orphan.</p>

<h2 id="conclusion">Conclusion</h2>

<p>Devising this schema was surprisingly tedious and took many trial and
error attempts to reimport the entire blockchain which collectively
took weeks. Many different variations on how to optimize operations
were attempted, for example using an <em>expression index</em> to only index
a subset of a hash (first 10 bytes are still statistically unique),
etc.</p>

<p>I would love to hear comments from the database experts out there. I’m
not considering this version “final”, there is probably still room for
improvement and new issues might be discovered as I progress to
writing up how to insert new blocks and actually verify blocks and
transactions.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/10/20/blockchain-in-postgresql-part-2/">Blockchain in PostgreSQL Part 2</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-10-20T08:05:00-04:00" pubdate data-updated="true">Oct 20<span>th</span>, 2017</time>
        
         | <a href="/blog/2017/10/20/blockchain-in-postgresql-part-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Update: there is now a <a href="/blog/2017/12/15/blockchain-and-postgres/">better write up</a>
of the PostgreSQL schema. This post was rather half-baked as much was
still not understood when I wrote it.</p>

<p>In a <a href="/blog/2017/10/10/postgre-as-a-full-node/">previous post</a> I
described a simplistic schema to store the Bitcoin blockchain in
PostgreSQL. In this post I’m investigating pushing the envelope
with a bit of C programming.</p>

<h3 id="the-missing-functionality">The Missing Functionality</h3>

<p>Postgres cannot do certain things required to fully handle
transactions. The missing functionality is (at least):</p>

<ol>
  <li>
    <p>Support for <a href="https://en.bitcoin.it/wiki/Protocol_documentation#Variable_length_integer">Variable Length Integer</a>
used in the blockchain and more generally the binary encoding of a transaction or its components.</p>
  </li>
  <li>
    <p><a href="https://en.wikipedia.org/wiki/Elliptic_Curve_Digital_Signature_Algorithm">Elliptic Curve Signature</a>. Even
though postgres integrates with OpenSSL, which has that functionality, there is no way to call
the EC functions.</p>
  </li>
  <li>
    <p>Ability to parse and evaluate Bitcoin <a href="https://en.bitcoin.it/wiki/Script">script</a>. This is a biggie,
as transaction verification requires it, and it is one of the more complex and bug-prone
aspects of Bitcoin.</p>
  </li>
</ol>

<p>It is also important that all of the above be performant. Even though
varints, script and even elliptic curve could be implemented in plain
<a href="https://www.postgresql.org/docs/current/static/plpgsql.html">PL/pgSQL</a>,
it probably wouldn’t be fast enough for practical use. Which leaves us with the only possible option:
a <a href="https://www.postgresql.org/docs/current/static/xfunc-c.html">C extension</a>.</p>

<h3 id="avoid-reinventing-the-wheel">Avoid Reinventing the Wheel</h3>

<p>Anything is possible in C, but can we avoid having to reimplement it
from scratch? Are there libraries that could be leveraged?</p>

<p>As it is now, the Bitcoin protocol is primarily specified by its
source code, and the source of all truth is the <a href="https://github.com/bitcoin/bitcoin">Bitcoin Core</a>.
It is <a href="https://www.postgresql.org/docs/current/static/xfunc-c.html#extend-cpp">possible</a> to use C++ in PG
extensions, which means at least in theory the Bitcoin Core code could be leveraged somehow.</p>

<p>My initial conclusion is that this would be a daunting task. Bitcoin
Core code requires at least C++11, as well as Boost. It also seems
that the core code assumes its own specific storage and caching mechanism and
isn’t easily abstracted away from it. Not to mention that using C++
libs from Postgres has complexities of its own.</p>

<p>I looked around for a plain C implementation of Bitcoin and found a few
rather incomplete ones. The most functional one seems to be Jeff Garzik’s
<a href="https://github.com/jgarzik/picocoin">picocoin</a>. With the looming
<a href="https://bitcointechtalk.com/how-segwit2x-replay-protection-works-1a5e41767103">Segwit2x fork</a>
and all the controversy surrounding it this may seem like an odd
choice of a library, but for the purpose of what we are doing, I think
it’s fine. It also seems like Picocoin isn’t actively developed,
which is not great. I would very much appreciate opinions/advice on this, if
you know of a better C lib, do leave a comment.</p>

<h3 id="the-c-extension">The C extension</h3>

<p>Thanks to this excellent <a href="http://big-elephants.com/2015-10/writing-postgres-extensions-part-i/">series of posts</a>
and Postgres’ superb documentation, I was able to put together a proof-of-concept extension,
available at <a href="https://github.com/blkchain/pg_blkchain">https://github.com/blkchain/pg_blkchain</a>.
While the C internals of it would be subject for a whole separate post (or
few), suffice it to say that it is fairly rudimentary and all the
heavy lifting is delegated to the picocoin lib.</p>

<p>As of now, the extension provides a handful of functions:</p>

<ul>
  <li>
    <p><code>get_vin(tx bytea)</code> This is a <a href="https://www.postgresql.org/docs/current/static/functions-srf.html">Set Returning Function</a> (SRF),
which returns the transaction inputs as rows.</p>
  </li>
  <li>
    <p><code>get_vout(tx bytea)</code> Similarly to get_vin(), an SRF that returns outputs.</p>
  </li>
  <li>
    <p><code>parse_script(script bytea)</code> An SRF which parses a Bitcoin script and returns (more or less) human-readable rows.</p>
  </li>
  <li>
    <p><code>verify_sig(tx bytea, previous_tx bytea, n int)</code> Verifies a specific input of a transaction (denoted by <code>n</code>),
given a the previous transaction to which the input refers. Returns a boolean.</p>
  </li>
</ul>

<p>This is hardly enough to support all of what would be required by a
full node, but this is sufficient to do some interesting stuff.</p>

<p>Note that the function names and signatures are not final, this is a
work in progress and I expect this all to evolve and change. For
example, initially I implemented get_vout() which returned an array,
but in the end an SRF seemed like a more flexible approach.</p>

<h3 id="the-schema">The Schema</h3>

<p>In the last post I used separate tables for the transaction, inputs
and outputs. With the ability to serialize/deserialize transactions at
our disposal, there are more interesting options.</p>

<p>The most compact way to store transactions is to just use the
serialized binary form in a binary (bytea) column. We can get at any
particulars of it by using our functions.</p>

<p>The examples below are based on a single table created as</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">rtxs</span> <span class="p">(</span>
</span><span class="line">   <span class="n">id</span>            <span class="nb">BIGINT</span> <span class="k">NOT</span> <span class="k">NULL</span><span class="p">,</span>
</span><span class="line">   <span class="n">tx</span>            <span class="n">BYTEA</span> <span class="k">NOT</span> <span class="k">NULL</span>
</span><span class="line"><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I imported the first 100K blocks or so into this table, how it was
done I might describe in a separate post.</p>

<p>I’ll introduce the extension with my favorite example: the decoding of the
signature of the genesis block <a href="https://blockchain.info/tx/4a5e1e4baab89f3a32518a88c31bc87f618f76673e2cc77ab2127b7afdeda33b">input</a>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="k">SELECT</span> <span class="p">(</span><span class="n">sig</span><span class="p">).</span><span class="n">op_sym</span><span class="p">,</span> <span class="n">encode</span><span class="p">((</span><span class="n">sig</span><span class="p">).</span><span class="k">data</span><span class="p">,</span> <span class="s1">&#39;escape&#39;</span><span class="p">)</span>
</span><span class="line">  <span class="k">FROM</span> <span class="p">(</span>
</span><span class="line">    <span class="k">SELECT</span> <span class="n">parse_script</span><span class="p">((</span><span class="n">get_vin</span><span class="p">(</span><span class="n">tx</span><span class="p">)).</span><span class="n">scriptSig</span><span class="p">)</span> <span class="k">AS</span> <span class="n">sig</span> <span class="k">FROM</span> <span class="n">rtxs</span>
</span><span class="line">    <span class="k">WHERE</span> <span class="n">digest</span><span class="p">(</span><span class="n">digest</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="s1">&#39;sha256&#39;</span><span class="p">),</span> <span class="s1">&#39;sha256&#39;</span><span class="p">)</span> <span class="o">=</span> <span class="n">E</span><span class="s1">&#39;\\x3ba3edfd7a7b12b27ac72c3e67768f617fc81bc3888a51323a9fb8aa4b1e5e4a&#39;</span>
</span><span class="line">  <span class="p">)</span> <span class="n">x</span><span class="p">;</span>
</span><span class="line">   <span class="n">op_sym</span>    <span class="o">|</span>                                <span class="n">encode</span>
</span><span class="line"><span class="c1">-------------+-----------------------------------------------------------------------</span>
</span><span class="line"> <span class="n">OP_PUSHDATA</span> <span class="o">|</span> <span class="err">\</span><span class="mi">377</span><span class="err">\</span><span class="mi">377</span><span class="err">\</span><span class="mi">000</span><span class="err">\</span><span class="n">x1D</span>
</span><span class="line"> <span class="n">OP_PUSHDATA</span> <span class="o">|</span> <span class="err">\</span><span class="n">x04</span>
</span><span class="line"> <span class="n">OP_PUSHDATA</span> <span class="o">|</span> <span class="n">The</span> <span class="n">Times</span> <span class="mi">03</span><span class="o">/</span><span class="n">Jan</span><span class="o">/</span><span class="mi">2009</span> <span class="n">Chancellor</span> <span class="k">on</span> <span class="n">brink</span> <span class="k">of</span> <span class="k">second</span> <span class="n">bailout</span> <span class="k">for</span> <span class="n">banks</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="expression-indexes">Expression Indexes</h3>

<p>One neat feature of PostgreSQL is ability to
<a href="https://www.postgresql.org/docs/current/static/indexes-expressional.html">index expressions</a>.
For example, we know that we can compute a transaction hash with</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="k">select</span> <span class="n">digest</span><span class="p">(</span><span class="n">digest</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="s1">&#39;sha256&#39;</span><span class="p">),</span> <span class="s1">&#39;sha256&#39;</span><span class="p">)</span> <span class="k">from</span> <span class="n">rtxs</span> <span class="k">limit</span> <span class="mi">1</span><span class="p">;</span>
</span><span class="line">                               <span class="n">digest</span>
</span><span class="line"><span class="c1">--------------------------------------------------------------------</span>
</span><span class="line"> <span class="err">\</span><span class="n">x6e29b04a029e308344995fab2b75e953e1efa914d306ad47c14a3cebc84564fd</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Note that this is <a href="https://en.wikipedia.org/wiki/Endianness">little-endian</a>,
while conventionally transaction id’s are represented with bytes
reversed (big-endian): <a href="https://blockchain.info/tx/fd6445c8eb3c4ac147ad06d314a9efe153e9752bab5f994483309e024ab0296e">fd6445c8eb3c4ac147ad06d314a9efe153e9752bab5f994483309e024ab0296e</a></p>

<p>Now if we want to be able to look up transactions quickly by the
transaction hash, as is the convention, we can create an expression
index like so:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="k">ON</span> <span class="n">rtxs</span><span class="p">(</span><span class="n">digest</span><span class="p">(</span><span class="n">digest</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="s1">&#39;sha256&#39;</span><span class="p">),</span> <span class="s1">&#39;sha256&#39;</span><span class="p">));</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>When we do this, PostgreSQL scans the entire table, computes the hash
and stores it in the index. An index, after all, is just another table
(of sorts), and there is nothing wrong with indexes containing values
that do not exist in the table to which the index refers.</p>

<p>Once we do this, any time the expression <code>digest(digest(tx, 'sha256'), 'sha256')</code>
is used in reference to the <code>rtxs</code> table, PostgreSQL will not execute
the <code>digest()</code> function, but would instead use the value stored in
the index.</p>

<p>We can attest to this with</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="k">explain</span> <span class="k">analyze</span> <span class="k">SELECT</span> <span class="n">id</span>
</span><span class="line"><span class="k">FROM</span> <span class="n">rtxs</span>
</span><span class="line"><span class="k">WHERE</span> <span class="n">digest</span><span class="p">(</span><span class="n">digest</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="s1">&#39;sha256&#39;</span><span class="p">),</span> <span class="s1">&#39;sha256&#39;</span><span class="p">)</span> <span class="o">=</span> <span class="n">E</span><span class="s1">&#39;\\x6e29b04a029e308344995fab2b75e953e1efa914d306ad47c14a3cebc84564fd&#39;</span><span class="p">;</span>
</span><span class="line">                                                                    <span class="n">QUERY</span> <span class="n">PLAN</span>
</span><span class="line"><span class="c1">--------------------------------------------------------------------------------------------------------------------------------------------------</span>
</span><span class="line"> <span class="k">Index</span> <span class="n">Scan</span> <span class="k">using</span> <span class="n">rtxs_digest_idx</span> <span class="k">on</span> <span class="n">rtxs</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">42</span><span class="p">..</span><span class="mi">8</span><span class="p">.</span><span class="mi">44</span> <span class="k">rows</span><span class="o">=</span><span class="mi">1</span> <span class="n">width</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">020</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">020</span> <span class="k">rows</span><span class="o">=</span><span class="mi">1</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">   <span class="k">Index</span> <span class="n">Cond</span><span class="p">:</span> <span class="p">(</span><span class="n">digest</span><span class="p">(</span><span class="n">digest</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="s1">&#39;sha256&#39;</span><span class="p">::</span><span class="nb">text</span><span class="p">),</span> <span class="s1">&#39;sha256&#39;</span><span class="p">::</span><span class="nb">text</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;\x6e29b04a029e308344995fab2b75e953e1efa914d306ad47c14a3cebc84564fd&#39;</span><span class="p">::</span><span class="n">bytea</span><span class="p">)</span>
</span><span class="line"> <span class="n">Planning</span> <span class="n">time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">077</span> <span class="n">ms</span>
</span><span class="line"> <span class="n">Execution</span> <span class="n">time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">037</span> <span class="n">ms</span>
</span><span class="line"><span class="p">(</span><span class="mi">4</span> <span class="k">rows</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>This is pretty clever - even though we do not have an actual
“transaction hash” column in our table, we do have the value and an
index in the database.</p>

<h3 id="views">Views</h3>

<p>But what if we wanted to have a better readable representation of
transactions, for example something that includes the transaction
hash?</p>

<p>The best way to do this is via a view:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">tx_view</span> <span class="k">AS</span>
</span><span class="line">  <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">digest</span><span class="p">(</span><span class="n">digest</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="s1">&#39;sha256&#39;</span><span class="p">),</span> <span class="s1">&#39;sha256&#39;</span><span class="p">)</span> <span class="k">AS</span> <span class="n">txid</span><span class="p">,</span> <span class="n">tx</span>
</span><span class="line">    <span class="k">FROM</span> <span class="n">rtxs</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Postgres is clever enough to use the above index for the view:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="k">explain</span> <span class="k">analyze</span> <span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">tx_view</span>
</span><span class="line"> <span class="k">WHERE</span> <span class="n">txid</span> <span class="o">=</span> <span class="n">E</span><span class="s1">&#39;\\x6e29b04a029e308344995fab2b75e953e1efa914d306ad47c14a3cebc84564fd&#39;</span><span class="p">;</span>
</span><span class="line"><span class="c1">--------------------------------------------------------------------------------------------------------------------------------------------------</span>
</span><span class="line"> <span class="k">Index</span> <span class="n">Scan</span> <span class="k">using</span> <span class="n">rtxs_digest_idx</span> <span class="k">on</span> <span class="n">rtxs</span>  <span class="p">(</span><span class="n">cost</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">42</span><span class="p">..</span><span class="mi">8</span><span class="p">.</span><span class="mi">45</span> <span class="k">rows</span><span class="o">=</span><span class="mi">1</span> <span class="n">width</span><span class="o">=</span><span class="mi">318</span><span class="p">)</span> <span class="p">(</span><span class="n">actual</span> <span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="p">.</span><span class="mi">045</span><span class="p">..</span><span class="mi">0</span><span class="p">.</span><span class="mi">046</span> <span class="k">rows</span><span class="o">=</span><span class="mi">1</span> <span class="n">loops</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">   <span class="k">Index</span> <span class="n">Cond</span><span class="p">:</span> <span class="p">(</span><span class="n">digest</span><span class="p">(</span><span class="n">digest</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="s1">&#39;sha256&#39;</span><span class="p">::</span><span class="nb">text</span><span class="p">),</span> <span class="s1">&#39;sha256&#39;</span><span class="p">::</span><span class="nb">text</span><span class="p">)</span> <span class="o">=</span> <span class="s1">&#39;\x6e29b04a029e308344995fab2b75e953e1efa914d306ad47c14a3cebc84564fd&#39;</span><span class="p">::</span><span class="n">bytea</span><span class="p">)</span>
</span><span class="line"> <span class="n">Planning</span> <span class="n">time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">104</span> <span class="n">ms</span>
</span><span class="line"> <span class="n">Execution</span> <span class="n">time</span><span class="p">:</span> <span class="mi">0</span><span class="p">.</span><span class="mi">067</span> <span class="n">ms</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>A similar technique can applied to inputs and outputs, for example for
outputs we could create a view like so:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="k">CREATE</span> <span class="k">VIEW</span> <span class="n">rtxouts</span> <span class="k">AS</span>
</span><span class="line"> <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="n">vout</span><span class="p">).</span><span class="n">n</span><span class="p">,</span> <span class="p">(</span><span class="n">vout</span><span class="p">).</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">vout</span><span class="p">).</span><span class="n">scriptpubkey</span>
</span><span class="line">  <span class="k">FROM</span> <span class="p">(</span> <span class="k">SELECT</span> <span class="n">id</span><span class="p">,</span> <span class="n">get_vout</span><span class="p">(</span><span class="n">tx</span><span class="p">)</span> <span class="n">vout</span> <span class="k">FROM</span> <span class="n">rtxs</span><span class="p">)</span> <span class="n">x</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The outputs are now easily accessibly as:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="o">#</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">rtxouts</span> <span class="k">limit</span> <span class="mi">3</span><span class="p">;</span>
</span><span class="line"> <span class="n">id</span> <span class="o">|</span> <span class="n">n</span> <span class="o">|</span>   <span class="n">value</span>    <span class="o">|</span>                                                               <span class="n">scriptpubkey</span>
</span><span class="line"><span class="c1">----+---+------------+------------------------------------------------------------------------------------------------------------------------------------------</span>
</span><span class="line">  <span class="mi">1</span> <span class="o">|</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">5000000000</span> <span class="o">|</span> <span class="err">\</span><span class="n">x4104678afdb0fe5548271967f1a67130b7105cd6a828e03909a67962e0ea1f61deb649f6bc3f4cef38c4f35504e51ec112de5c384df7ba0b8d578a4c702b6bf11d5fac</span>
</span><span class="line">  <span class="mi">2</span> <span class="o">|</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">5000000000</span> <span class="o">|</span> <span class="err">\</span><span class="n">x410496b538e853519c726a2c91e61ec11600ae1390813a627c66fb8be7947be63c52da7589379515d4e0a604f8141781e62294721166bf621e73a82cbf2342c858eeac</span>
</span><span class="line">  <span class="mi">3</span> <span class="o">|</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">5000000000</span> <span class="o">|</span> <span class="err">\</span><span class="n">x41047211a824f55b505228e4c3d5194c1fcfaa15a456abdf37f9b9d97a4040afc073dee6c89064984f03385237d92167c13e236446b417ab79a0fcae412ae3316b77ac</span>
</span><span class="line"><span class="p">(</span><span class="mi">3</span> <span class="k">rows</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Want to know the most popular opcode used in scripts?</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="c1">--Note: this is obviously not the full blockchain</span>
</span><span class="line">
</span><span class="line"><span class="k">SELECT</span> <span class="p">(</span><span class="n">parse_script</span><span class="p">(</span><span class="n">scriptpubkey</span><span class="p">)).</span><span class="n">op_sym</span><span class="p">,</span> <span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">  <span class="k">FROM</span> <span class="p">(</span><span class="k">SELECT</span> <span class="n">scriptpubkey</span> <span class="k">FROM</span> <span class="n">rtxouts</span><span class="p">)</span> <span class="n">x</span>
</span><span class="line"><span class="k">GROUP</span> <span class="k">BY</span> <span class="n">op_sym</span>
</span><span class="line"><span class="k">ORDER</span> <span class="k">BY</span> <span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span class="line">  <span class="n">op_sym</span>     <span class="o">|</span>  <span class="k">count</span>
</span><span class="line"><span class="c1">----------------+---------</span>
</span><span class="line"> <span class="n">OP_NOP</span>         <span class="o">|</span>       <span class="mi">5</span>
</span><span class="line"> <span class="n">OP_DUP</span>         <span class="o">|</span> <span class="mi">1007586</span>
</span><span class="line"> <span class="n">OP_EQUALVERIFY</span> <span class="o">|</span> <span class="mi">1007586</span>
</span><span class="line"> <span class="n">OP_HASH160</span>     <span class="o">|</span> <span class="mi">1007586</span>
</span><span class="line"> <span class="n">OP_PUSHDATA</span>    <span class="o">|</span> <span class="mi">1139431</span>
</span><span class="line"> <span class="n">OP_CHECKSIG</span>    <span class="o">|</span> <span class="mi">1151434</span>
</span><span class="line"><span class="p">(</span><span class="mi">6</span> <span class="k">rows</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Anyway, that’s it for now. Please comment your questions/comments
below, or via twitter, I am very curious on what people think on this
approach!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/10/10/postgre-as-a-full-node/">Bitcoin Transaction Hash in Pure PostgreSQL</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-10-10T17:54:00-04:00" pubdate data-updated="true">Oct 10<span>th</span>, 2017</time>
        
         | <a href="/blog/2017/10/10/postgre-as-a-full-node/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Update: hacked together
<a href="https://github.com/blkchain/pg_blkchain">this</a>, more details to
follow later…</p>

<p>In theory, Postgres should be able to verify transactions and blocks,
as well as do a lot of other things that are currently only done by
full nodes. For this to be performant, it will most likely require an
extension written in C, but I’m curious how far we can get with bare
bones Postgres.</p>

<p>More importantly, would that actually be useful? A node is really
just a database, a very efficient one for a very specific purpose, but
would leveraging the full power of Postgres be somehow more beneficial
than just running Bitcoin-Qt or btcd, for example?</p>

<p>To get to the bottom of this would be a lot of work, and potentially a
lot of fun. It would also be a great blockchain learning exercise. (If
you’re working on a PG extension for Bitcoin or more generally
blockchain, please do let me know!)</p>

<h3 id="random-thoughts">Random Thoughts</h3>

<p>The structure of the Bitcoin blockchain is relatively simple.  We have
<em>transactions</em>, which in turn have <em>inputs</em> and <em>outputs</em> and belong
to <em>blocks</em>. Four tables, that’s it.</p>

<p>I’ve been able to import the whole blockchain with some fairly basic
Go code into my old Thinkpad running Linux overnight. The Go code
needs some more polishing and is probably worthy of a separate write
up, so I won’t get into it for now. Below is the schema I used. I
intentionally left out referential integrity and indexes to keep it
simple and avoid premature optimization.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
</pre></td><td class="code"><pre><code class=""><span class="line">CREATE TABLE blocks (                     -- CBlockIndex (chain.h)
</span><span class="line">   id           BIGINT NOT NULL
</span><span class="line">  ,prev         BIGINT NOT NULL              -- .prev-&gt;nHeight  // genesis will have -1
</span><span class="line">  ,height       BIGINT NOT NULL              -- .nHeight
</span><span class="line">  ,hash         BYTEA NOT NULL            -- &lt;computed&gt;
</span><span class="line">  ,version      BIGINT NOT NULL              -- .nVersion
</span><span class="line">  ,prevhash     BYTEA NOT NULL            -- .pprev-&gt;GetBlockHash()
</span><span class="line">  ,merkleroot   BYTEA NOT NULL            -- .hashMerkleRoot
</span><span class="line">  ,time         BIGINT NOT NULL           -- .nTime
</span><span class="line">  ,bits         BIGINT NOT NULL           -- .nBits
</span><span class="line">  ,nonce        BIGINT NOT NULL           -- .nNonce
</span><span class="line">);
</span><span class="line">
</span><span class="line">CREATE TABLE txs (
</span><span class="line">   id            BIGINT NOT NULL
</span><span class="line">  ,txid          BYTEA NOT NULL
</span><span class="line">  ,version       BIGINT NOT NULL
</span><span class="line">  ,locktime      BIGINT NOT NULL
</span><span class="line">);
</span><span class="line">
</span><span class="line">CREATE TABLE txins (
</span><span class="line">   id            BIGINT NOT NULL
</span><span class="line">  ,tx_id         BIGINT NOT NULL
</span><span class="line">  ,n             BIGINT NOT NULL
</span><span class="line">  ,prevout_hash  BYTEA NOT NULL
</span><span class="line">  ,prevout_n     BIGINT NOT NULL
</span><span class="line">  ,scriptsig     BYTEA NOT NULL
</span><span class="line">  ,sequence      BIGINT NOT NULL
</span><span class="line">);
</span><span class="line">
</span><span class="line">CREATE TABLE txouts (
</span><span class="line">   id           BIGINT NOT NULL
</span><span class="line">  ,tx_id        BIGINT NOT NULL
</span><span class="line">  ,n            BIGINT NOT NULL
</span><span class="line">  ,value        BIGINT NOT NULL
</span><span class="line">  ,scriptpubkey BYTEA NOT NULL
</span><span class="line">);
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>There are a couple projects out there that keep the blockchain in a
database, most notably
<a href="https://github.com/bitcoin-abe/bitcoin-abe">Abe</a>. I haven’t studied
the code very carefully, but my initial impression was that Abe tries
to use standard SQL that would work across most big databases, which
is philosophically different from my objective of going 100% Postgres
and leveraging all that it can do for us.</p>

<p>Bitcoin uses a lot of uint32’s. A Postgres INT is the correct size,
but it is signed, which means we have to use the next larger type,
BIGINT. It seems like it might be a waste to use 64 bits for a 32-bit
value, but I couldn’t think of anything better than a BIGINT. For the
binary stuff it seems like BYTEA is the best match.</p>

<p>So what can we do with this? There is no easy way to create or verify an
<a href="https://en.wikipedia.org/wiki/Elliptic_Curve_Digital_Signature_Algorithm">Elliptic Curve signature</a>
in Postgres, but with the help of the <a href="https://www.postgresql.org/docs/current/static/pgcrypto.html">pgcrypto</a>
extension, we should be able to at least generate the correct SHA256
digest which is used in the signature. As a side note, EC signature math is actually
remarkably simple and could probably be implemented
as a PG function, but I’m too lazy. Here it is in a
<a href="https://github.com/wobine/blackboard101/blob/master/EllipticCurvesPart5-TheMagic-SigningAndVerifying.py">few lines of Python</a>.</p>

<p>The rules on how Bitcoin generates the hash (which is then signed) are
slightly <a href="https://en.bitcoin.it/w/images/en/7/70/Bitcoin_OpCheckSig_InDetail.png">complicated</a>, and that’s an
<a href="https://lists.linuxfoundation.org/pipermail/bitcoin-dev/2014-November/006878.html">understatement</a>.</p>

<p>For the purposes of this exercise, I’d just be happy with a value that
matches, even if the code does not fully comply with the Bitcoin rules.</p>

<p>One problem I ran into was that, because Bitcoin blockchain is
little-endian except for where it isn’t, you often need a way to
reverse bytes in a BYTEA. Strangely, Postgres does not provide a way
to do that, unless I’m missing something. But thanks to
<a href="https://stackoverflow.com/questions/11142235/convert-bigint-to-bytea-but-swap-the-byte-order">stackoverflow</a>,
here is one way to do this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="k">CREATE</span> <span class="k">OR</span> <span class="k">REPLACE</span> <span class="k">FUNCTION</span> <span class="n">reverse</span><span class="p">(</span><span class="n">bytea</span><span class="p">)</span> <span class="k">RETURNS</span> <span class="n">bytea</span> <span class="k">AS</span> <span class="err">$</span><span class="n">reverse</span><span class="err">$</span>
</span><span class="line">    <span class="k">SELECT</span> <span class="n">string_agg</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">::</span><span class="n">bytea</span><span class="p">)</span>
</span><span class="line">       <span class="k">FROM</span> <span class="p">(</span>
</span><span class="line">          <span class="k">SELECT</span> <span class="n">substr</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="n">byte</span>
</span><span class="line">             <span class="k">FROM</span> <span class="n">generate_series</span><span class="p">(</span><span class="k">length</span><span class="p">(</span><span class="err">$</span><span class="mi">1</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">i</span><span class="p">)</span> <span class="n">s</span>
</span><span class="line"><span class="err">$</span><span class="n">reverse</span><span class="err">$</span> <span class="k">LANGUAGE</span> <span class="k">sql</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>We also have no way to render a Bitcoin
<a href="https://en.bitcoin.it/wiki/Protocol_documentation#Variable_length_integer">varint</a>, but we can fake it
with some substringing for the time being.</p>

<p>Equipped with this, we can construct the following statement, sorry
it’s a little long and I do not have the patience to explain it in
writing.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
</pre></td><td class="code"><pre><code class="sql"><span class="line"><span class="k">select</span> <span class="n">digest</span><span class="p">(</span><span class="n">digest</span><span class="p">(</span><span class="n">tx_ser</span> <span class="o">||</span> <span class="n">hashtype</span><span class="p">,</span> <span class="s1">&#39;sha256&#39;</span><span class="p">),</span> <span class="s1">&#39;sha256&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">shasha</span> <span class="k">from</span> <span class="p">(</span>
</span><span class="line"> <span class="k">select</span> <span class="k">substring</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="n">int8send</span><span class="p">(</span><span class="k">version</span><span class="p">))</span> <span class="k">from</span> <span class="mi">1</span> <span class="k">for</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span>
</span><span class="line">       <span class="n">vin</span> <span class="o">||</span>
</span><span class="line">       <span class="n">vout</span> <span class="o">||</span>
</span><span class="line">       <span class="k">substring</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="n">int8send</span><span class="p">(</span><span class="n">locktime</span><span class="p">))</span> <span class="k">from</span> <span class="mi">1</span> <span class="k">for</span> <span class="mi">4</span><span class="p">)</span> <span class="k">AS</span> <span class="n">tx_ser</span><span class="p">,</span>
</span><span class="line">       <span class="k">substring</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="n">int8send</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="k">from</span> <span class="mi">1</span> <span class="k">for</span> <span class="mi">4</span><span class="p">)</span> <span class="k">AS</span> <span class="n">hashtype</span>
</span><span class="line">  <span class="k">from</span> <span class="n">txs</span> <span class="n">t</span>
</span><span class="line">  <span class="k">join</span> <span class="n">txins</span> <span class="n">tt</span> <span class="k">ON</span> <span class="n">tt</span><span class="p">.</span><span class="n">tx_id</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">id</span>
</span><span class="line">  <span class="k">join</span> <span class="k">lateral</span> <span class="p">(</span>
</span><span class="line">    <span class="k">select</span> <span class="n">tx_id</span><span class="p">,</span> <span class="k">substring</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="n">int8send</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span> <span class="k">from</span> <span class="mi">1</span> <span class="k">for</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="n">string_agg</span><span class="p">(</span><span class="n">txin_ser</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">vin</span>
</span><span class="line">    <span class="k">from</span> <span class="p">(</span>
</span><span class="line">      <span class="k">select</span>
</span><span class="line">         <span class="n">ti</span><span class="p">.</span><span class="n">tx_id</span><span class="p">,</span>
</span><span class="line">         <span class="n">reverse</span><span class="p">(</span><span class="n">prevout_hash</span><span class="p">)</span> <span class="o">||</span>
</span><span class="line">         <span class="k">substring</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="n">int8send</span><span class="p">(</span><span class="n">prevout_n</span><span class="p">))</span> <span class="k">from</span> <span class="mi">1</span> <span class="k">for</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span>
</span><span class="line">         <span class="k">substring</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="n">int8send</span><span class="p">(</span><span class="k">length</span><span class="p">(</span><span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">ti</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">tt</span><span class="p">.</span><span class="n">n</span> <span class="k">THEN</span> <span class="n">ptxout</span><span class="p">.</span><span class="n">scriptpubkey</span> <span class="k">ELSE</span> <span class="s1">&#39;&#39;</span> <span class="k">END</span><span class="p">)))</span> <span class="k">from</span> <span class="mi">1</span> <span class="k">for</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
</span><span class="line">         <span class="k">CASE</span> <span class="k">WHEN</span> <span class="n">ti</span><span class="p">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">tt</span><span class="p">.</span><span class="n">n</span> <span class="k">THEN</span> <span class="n">ptxout</span><span class="p">.</span><span class="n">scriptpubkey</span> <span class="k">ELSE</span> <span class="s1">&#39;&#39;</span> <span class="k">END</span> <span class="o">||</span>
</span><span class="line">         <span class="k">substring</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="n">int8send</span><span class="p">(</span><span class="n">sequence</span><span class="p">))</span> <span class="k">from</span> <span class="mi">1</span> <span class="k">for</span> <span class="mi">4</span><span class="p">)</span> <span class="k">as</span> <span class="n">txin_ser</span>
</span><span class="line">      <span class="k">from</span> <span class="n">txins</span> <span class="n">ti</span>
</span><span class="line">      <span class="k">join</span> <span class="n">txs</span> <span class="n">ptx</span> <span class="k">on</span> <span class="n">ti</span><span class="p">.</span><span class="n">prevout_hash</span> <span class="o">=</span> <span class="n">ptx</span><span class="p">.</span><span class="n">txid</span>
</span><span class="line">      <span class="k">join</span> <span class="n">txouts</span> <span class="n">ptxout</span> <span class="k">on</span> <span class="n">ptxout</span><span class="p">.</span><span class="n">tx_id</span> <span class="o">=</span> <span class="n">ptx</span><span class="p">.</span><span class="n">id</span> <span class="k">and</span> <span class="n">ti</span><span class="p">.</span><span class="n">prevout_n</span> <span class="o">=</span> <span class="n">ptxout</span><span class="p">.</span><span class="n">n</span>
</span><span class="line">      <span class="k">order</span> <span class="k">by</span> <span class="n">ti</span><span class="p">.</span><span class="n">n</span>
</span><span class="line">     <span class="p">)</span> <span class="n">x</span>
</span><span class="line">   <span class="k">group</span> <span class="k">by</span> <span class="n">tx_id</span>
</span><span class="line">   <span class="p">)</span> <span class="n">vin</span> <span class="k">on</span> <span class="n">vin</span><span class="p">.</span><span class="n">tx_id</span> <span class="o">=</span> <span class="n">tt</span><span class="p">.</span><span class="n">tx_id</span>
</span><span class="line">   <span class="k">join</span> <span class="p">(</span>
</span><span class="line">      <span class="k">select</span> <span class="n">tx_id</span><span class="p">,</span> <span class="k">substring</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="n">int8send</span><span class="p">(</span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span> <span class="k">from</span> <span class="mi">1</span> <span class="k">for</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="n">string_agg</span><span class="p">(</span><span class="n">txout_ser</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">vout</span>
</span><span class="line">      <span class="k">from</span> <span class="p">(</span>
</span><span class="line">        <span class="k">select</span>
</span><span class="line">          <span class="n">tx_id</span><span class="p">,</span>
</span><span class="line">          <span class="n">reverse</span><span class="p">(</span><span class="n">int8send</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">||</span>
</span><span class="line">          <span class="k">substring</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="n">int8send</span><span class="p">(</span><span class="k">length</span><span class="p">(</span><span class="n">scriptpubkey</span><span class="p">)))</span> <span class="k">from</span> <span class="mi">1</span> <span class="k">for</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
</span><span class="line">          <span class="n">scriptpubkey</span> <span class="k">as</span> <span class="n">txout_ser</span>
</span><span class="line">        <span class="k">from</span> <span class="n">txouts</span>
</span><span class="line">        <span class="k">order</span> <span class="k">by</span> <span class="n">n</span>
</span><span class="line">        <span class="p">)</span> <span class="n">x</span>
</span><span class="line">      <span class="k">group</span> <span class="k">by</span> <span class="n">tx_id</span>
</span><span class="line">    <span class="p">)</span> <span class="k">out</span> <span class="k">ON</span> <span class="k">out</span><span class="p">.</span><span class="n">tx_id</span> <span class="o">=</span> <span class="n">tt</span><span class="p">.</span><span class="n">tx_id</span>
</span><span class="line"> <span class="k">where</span> <span class="n">tt</span><span class="p">.</span><span class="n">tx_id</span> <span class="o">=</span> <span class="mi">37898</span>
</span><span class="line"><span class="p">)</span> <span class="n">x</span><span class="p">;</span>
</span><span class="line"><span class="o">-</span><span class="p">[</span> <span class="n">RECORD</span> <span class="mi">1</span> <span class="p">]</span><span class="c1">--------------------------------------------------------------</span>
</span><span class="line"><span class="n">shasha</span> <span class="o">|</span> <span class="err">\</span><span class="n">x23c3bf5091f3cdaf5996b0091c5f5bb6d82f3cdc2ce077018bb854f40274e512</span>
</span><span class="line"><span class="o">-</span><span class="p">[</span> <span class="n">RECORD</span> <span class="mi">2</span> <span class="p">]</span><span class="c1">--------------------------------------------------------------</span>
</span><span class="line"><span class="n">shasha</span> <span class="o">|</span> <span class="err">\</span><span class="n">xbcd4d519931da3ab98ca9745a0ceba79f05306cad4fa6ee9863819d1783a2e00</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The particular transaction we are looking at is
<a href="https://blockchain.info/tx/2847ae66175042438532c2eccc5b39935fd1216453e62e2c3cb9c8e5020cc771">this</a>.
It happens to have id of 37898 in my database. In case you’re
wondering, for this example I used a subset of the blockchain which
only has the first 182,000 blocks. On the full blockchain and without
indexes, this statement would have taken an eternity to execute.</p>

<p>What makes this particular transaction interesting is that it has two
inputs, which is slightly trickier, because to spend them, there need to
be two different signatures of the same transaction. This is because
before signing, the input scriptSig needs to be replaced with the
output’s scriptPubKey (the oversimplified version). This is reflected in the SQL
in the use of <code>LATERAL</code> and <code>CASE</code>.</p>

<p>You do not have to take my word that the two hashes are correct, we
can verify them fairly easily with a bit of help from the Python ecdsa
library. Here is the code to verify the second hash. The key and the
signature are in the
<a href="https://blockchain.info/tx/2847ae66175042438532c2eccc5b39935fd1216453e62e2c3cb9c8e5020cc771">transaction itself</a>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="python"><span class="line"><span class="kn">import</span> <span class="nn">ecdsa</span>
</span><span class="line"><span class="kn">import</span> <span class="nn">codecs</span>
</span><span class="line"><span class="n">key</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
</span><span class="line">    <span class="s">&quot;04de99a4267263f495e07721f96241359b48b9f522973b9d333ed8e296357c595130535ca387601955f1406e335cf658bb6a12d62c177e9511498fefcafead1c0e&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&quot;hex&quot;</span><span class="p">)</span>
</span><span class="line"><span class="n">der</span> <span class="o">=</span> <span class="s">&#39;0V0</span><span class="se">\x10\x06\x07</span><span class="s">*</span><span class="se">\x86</span><span class="s">H</span><span class="se">\xce</span><span class="s">=</span><span class="se">\x02\x01\x06\x05</span><span class="s">+</span><span class="se">\x81\x04\x00\n\x03</span><span class="s">B</span><span class="se">\x00</span><span class="s">&#39;</span> <span class="o">+</span> <span class="n">key</span>
</span><span class="line"><span class="n">digest</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&quot;bcd4d519931da3ab98ca9745a0ceba79f05306cad4fa6ee9863819d1783a2e00&quot;</span><span class="p">,</span> <span class="s">&quot;hex&quot;</span><span class="p">)</span>
</span><span class="line"><span class="n">signature</span> <span class="o">=</span> <span class="n">codecs</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span>
</span><span class="line">    <span class="s">&quot;30460221008e95fd3536cfd437c49e4c1dfaeeb2ece0e521420c89f1487ca6eff94053485c022100ef3a8cdc9b0a6d6d403bf7758c6b617380db6936de2bbcd3b556ec5f45c03b54&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="s">&quot;hex&quot;</span><span class="p">)</span>
</span><span class="line"><span class="n">vk</span> <span class="o">=</span> <span class="n">ecdsa</span><span class="o">.</span><span class="n">VerifyingKey</span><span class="o">.</span><span class="n">from_der</span><span class="p">(</span><span class="n">der</span><span class="p">)</span>
</span><span class="line"><span class="k">print</span> <span class="n">vk</span><span class="o">.</span><span class="n">verify_digest</span><span class="p">(</span><span class="n">signature</span><span class="p">,</span> <span class="n">digest</span><span class="p">,</span> <span class="n">sigdecode</span><span class="o">=</span><span class="n">ecdsa</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">sigdecode_der</span><span class="p">)</span>
</span><span class="line"><span class="c"># True</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>I hope this was fun! Now I wonder how hard it would be to make an
extension to provide all the functionality required by Bitcoin….</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/09/28/electricity-cost-of-1-bitcoin/">Electricity Cost of 1 Bitcoin (Sep 2017)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-09-28T16:38:00-04:00" pubdate data-updated="true">Sep 28<span>th</span>, 2017</time>
        
         | <a href="/blog/2017/09/28/electricity-cost-of-1-bitcoin/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>How much does it cost in electricity to mine a Bitcoin?</p>

<p>As of Sep 28, 2017, according to blockchain.info the hashrate is:
9,214,860,125 GH/s.</p>

<p>These days it seems that the best miner available for sale is the
AntMiner S9. It is actually over a year old, and there are faster and
more energy efficient ASICs now, e.g. BitFury, but it is very hard to
get any information on those, so we will just use the S9 information.</p>

<p>The S9 is capable of 12,930 GH/s. The collective Bitcoin hash rate is
equivalent to 712,672 S9 miners running in parallel.</p>

<p>An S9 uses 1375W, which means that in 1 hour it consumes 1.375 kW/h.</p>

<p>In USA, a kWh costs $0.12 on average. (It can be
as low as 0.04, according to this <a href="https://www.eia.gov/electricity/monthly/epm_table_grapher.php?t=epmt_5_6_a">EIA chart</a>.)</p>

<p>At 12c per kWh a running S9 costs $0.165 per hour.</p>

<p>712,672 running S9’s would cost $117,591.02 per hour.</p>

<p>Bitcoin blocks are solved at 6 per hour on average. Thus, each block
costs $19,598.50 to solve.</p>

<p>The current mining reward is 12.5 BTC, which gives us the answer:</p>

<p>At \$0.12 kW/h a Bitcoin costs \$1,567.88 to mine.</p>

<p>At \$0.04 kW/h a Bitcoin costs \$522.62 to mine.</p>

<p>This, of course, does not include hardware and other costs.</p>

<p>It’s quite likely that the largest mining operations pay even less
than $0.04 for electricity and the hardware they use is many times
more efficient.</p>

<p>While grosly inaccurate, this shows that mining is quite profitable,
and that Bitcoin price would have to fall a lot for mining to stop
being profitable.</p>

<h3 id="looking-at-the-trend">Looking at the Trend</h3>

<p>Current difficulty is 1103400932964, The difficulty before that was
922724699725.</p>

<p>Difficulty adjusts every 2,016 blocks, which is about two weeks.</p>

<p>The Difficulty number is a coefficient of the “difficulty 1 target”,
i.e. where the hash has to begin with 4 zero bytes (32 zero bits). It
means is that it is N times harder than “1 target”.</p>

<p>We can see that at the last adjustment it went up by 180,676,233,239,
or 16%, which is quite a bit in just two weeks. The last adjustment
before that was from 888171856257, or 4%.</p>

<p>Assuming that the only miner in the world was the S9, the difficulty
adjustment can only be explained by more S9’s coming online. The
number of S9’s online is directly proportional to the hashrate, which
is directly proportional to the difficulty. Thus there is a direct
relationship between energy cost and the difficulty.</p>

<p>When the difficulty was 922724699725 (Sep 6 through 16), the hash rate
was at about 8,000,000 TH/s, or equivalent of 618,716 S9’s. At that
difficulty and the 12c kW/h price, a BTC cost $1,361 to mine.</p>

<p>Now let’s look back at the world before the S9, which uses the Bitmain
BM1387 16nm ASIC. Before the S9, there was S7, based on BitMain BM1385
28nm ASIC. The S7 power consumption is roughly same as S9, or let’s
assume it is for simplicity, but it is only capable of 4,000 GH/s.</p>

<p>Back at the end of 2015 when S7 was announced, the hashrate was at
around 700,000,000 GH/s, or equivalent to 175,000 S7’s. That cost
\$28,875 per hour, or \$4,812.5 per block. The block reward was 25
Bitcoins then, so a Bitcoin would cost only \$192 to mine. (With a 12.5
reward it would have been \$385).</p>

<p>This is all very confusing, but we can see that faster hardware and
more of it drives the cost of mining up and the rlationship between
the difficulty and the cost of mining a Bitcoin is linear. Faster
hardware enables higher hash rate at improved energy efficiency, and
the difficulty adjusts to keep the rate of blocks and supply of new
BTC at 10 minutes.</p>

<p>The cost factor behind Bitcoin is energy, and spending more energy on
mining makes a Bitcoin more expensive and less profitable. However, a
more energy-expensive Bitcoin is a more sound/secure Bitcoin from the
cryptographic perspective, which means it is likely to go up in USD
price, and thus should still be profitable for the miners. This is a
very interesting factor here, because if the BTC/USD price wasn’t
going up, the miners would be bitter enemies and would do everything
possible to prevent more miners from coming online. The rise of the
BTC/USD price is what justifies as positive more miners coming
online. So far we have not seen any news reports of mining facilities
being sabotaged, which probably means miners are not enemies.</p>

<p>I will need to think on this some more as there are a lot of moving
parts. But if I can make a cursory conclusion here, it is that
(industrial) mining is and will remain very profitable for some time.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2017/09/25/bitcoin-value-2/">Bitcoin: USD Value</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-09-25T08:50:00-04:00" pubdate data-updated="true">Sep 25<span>th</span>, 2017</time>
        
         | <a href="/blog/2017/09/25/bitcoin-value-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In <a href="/blog/2017/09/22/bitcoin-value/">part 1</a> I explained
how money has always been a global ledger and Bitcoin is just a
different implementation of one. The million dollar question remains,
what should Bitcoin be worth in a currency we’re more familiar with,
such as USD?</p>

<h3 id="asset-pricing">Asset Pricing</h3>

<p>To illustrate the dilemma we’re faced with, lets look at three types
of assets and how we price them.</p>

<p><em>Stocks:</em> price is determined by the present and future profits, which
is relatively straight forward.</p>

<p><em>Commodities</em> (e.g oil): price is a function of supply (oil being
produced) and demand (oil burned in engines or whatever).</p>

<p><em>Store of value:</em> this is anything that is bought because it keeps its
value. Most commonly it is precious metals like gold, but it can also
be fiat currency or valuable works of art. This category is most
fitting for Bitcoin. Pricing of a store of value is strangely
arbitrary, I attempt to explain it below.</p>

<h3 id="speculative-demand">Speculative Demand</h3>

<p>There are two kinds of demand. <em>Actual</em> demand is based in our
everyday needs. For example we rely on combustible engines which
consume oil. Engines burn oil (or its byproducts) converting it to
exhaust gases, at which point it is no more. The more we drive, the
more oil we burn, the higher the demand.</p>

<p>The second kind of demand is <em>speculative</em>. It is based on the
expectation of a future price change. Speculators buy assets they
expect to go up in price and sell those they don’t. When everyone
wants to buy oil because they think the price is going up, its price
does indeed goes up. But that is not directly related to the actual
supply of oil from the ground (it often is, but not always).</p>

<h3 id="right-price">Right Price</h3>

<p>In <a href="/blog/2017/09/22/bitcoin-value/">part 1</a> we covered how
a sale is actually a loan, and how the seller ends up with tokens
representing the value owed to the seller. The number of tokes (aka
price) is a reflection of how we value things relative to each other.</p>

<p>When we buy stuff for everyday use we establish a price range that is
driven by, for lack of a better term, <em>common sense</em>. For example we
may think that a loaf of bread is worth a dozen eggs. If the price of
something exceeds common sense, we will forego buying it. This means
that the price has a direct effect on demand especially when it comes
to everyday consumption items such as food or fuel.</p>

<p>Speculators have no respect for common sense and the right price. They
are only concerned with the trend. It is possible for the speculative
demand to drive the price way above the common sense level, we saw
that when “peak oil” was a thing. But the price will eventually
gravitate towards the common sense price.</p>

<h3 id="store-of-value-price">Store of Value Price</h3>

<p>In contrast, price for a store of value is purely speculative, which
means the sensibility of the price does not apply.</p>

<p>Let’s take gold, for example. Intuitively we might reason that there
is a (non-speculative) supply and demand for gold, but it’s actually
illusory.  The annual production of gold is minute compared to the
total gold above ground, which means there is essentially no
supply. There is also next to no demand, because gold cannot be
consumed. There is never less or more gold available in the world, its
quantity is fairly constant. Yet the price fluctuates. The only
explanation for this is speculation.</p>

<p>There is simply no such thing as the “right price” for store of
value. If I want to move a million dollars into gold, the price of
gold is of no consequence to me, be it a thousand or a million dollars
per ounce. So long as I know that it is stable, it is a good store of
value.</p>

<p>The good news here is that no price is too high (or too low) for
Bitcoin. 4K only seems high because a year ago it was 400. We tend to
judge the price based on history, and there is good sense in that,
indeed what goes up in value too much too fast often subsequently
<em>corrects</em>.</p>

<h3 id="importance-of-market-cap">Importance of Market Cap</h3>

<p><em>Market capitalization</em> is the price of all of the asset available in
the world. It’s easy to compute the market cap for a stock because we
know the number of shares outstanding. There is no such thing as a
market cap for a commodity because it is continuously produced and
consumed. When it comes to something like gold, we can estimate the
market cap because we know approximately how much physical gold is
above ground. Bitcoin, like gold, has an approximate market cap
(approximate because it is not possible to know how much BTC has been
lost).</p>

<p>Market cap size is critical for adoption of a store of value. It needs
to be large enough to “fit” even very large amounts of fiat, ideally
without affecting the market. Gold market cap is estimated at 7
trillion USD, which means that even the richest people can move all
their assets into gold and not move the market. (At least one at a
time. All of them at once will move the market big time).</p>

<p>Bitcoin market cap of about 70B USD is not large enough for even one
of the richest people on the planet. This implies that if the market
cap does not grow, Bitcoin is likely to fail as store of value.</p>

<h3 id="hash-rate">Hash Rate</h3>

<p>What sets Bitcoin apart from all other crypto currencies is its
extremely high hash rate. This means that a Bitcoin is orders of
magnitude more “precious” than any other crypto coin presently in
existence.</p>

<p>There is a definite correlation between the Bitcoin hash rate and the
price. Some people argue that hash rate follows price, not the other
way around, and it’s probably true.</p>

<p>Bitcoin’s high hash rate is what makes it the best store of value
among crypto coins today.</p>

<h3 id="adoption">Adoption</h3>

<p>Ultimately, I believe adoption is the most important factor in Bitcoin
USD price. Greater adoption will increase the number of speculators
willing to own Bitcoin, it will drive the price up, and hopefully
bring it to a level comparable to that of gold.</p>

<p>The key to adoption is not ease of payment or volume of transactions
like we used to think until very recently. The key to adoption is
understanding of the mathematics behind Bitcoin. With all the hype
surrounding it, only remarkably few understand how sound Bitcoin
actually is. In many ways it is more sound than any other store of
value known, including gold.</p>

<p>Regardless of whether Bitcoin becomes de facto digital gold or not, we
are witnessing a historic transformation possibly bigger than the
Internet itself.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    


<section>
  <br/>
  <p>
    <small>Send me some crypto if you like this content, TIA!</small><br/><br/>
<tt><small>Bitcoin: 1GrishapUx3mofmQuTbL4JEEMdzGgeSEcu</small></tt><br/>
<tt><small>Litecoin: LXLGrXXQM2t5ckq4gmznsVzpRNhRVD1V8w</small></tt><br/>
  </p>
</section>

<section>
  <h1>About Me</h1>

  <p>
  <div style="width: 75%; margin: 0 auto;">
  <a href="https://twitter.com/humblehack" class="twitter-follow-button"
    data-show-count="">Follow @humblehack</a>
  </div>
  </p>

  <p>I am currently a (Data) Hacker at <a href="http://voxmedia.com">Vox Media</a>.</p>
  <p>Grisha is a common Russian short name for Gregory. It is pronounced more like Greesha.</p>
  <p>Years ago I wrote <a href="http://modpython.org">mod_python</a>, which became a hugely succesful OSS Project used by millions of sites.</p>
  <p>I am a former VP and member emeritus of the <a href="http://apache.org">Apache Software Foundation</a>.</p>
  <p>I live near Washington, DC, USA</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2020/05/08/mini-bigquery-etl-in-python-with-bq-etl/">Keeping ETL in BigQuery&nbsp;with&nbsp;bq_etl.</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/06/19/sql-dag/">Implicit SQL DAG in Maestro</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/06/05/maestro-is-open-source/">Maestro the BigQuery Orchestrator</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/10/18/relative-imports-hack-in-go/">Relative Imports Hack in Golang</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/01/23/explaining-proof-of-work/">Blockchain Proof-of-Work is a Decentralized Clock</a>
      </li>
    
  </ul>
</section>

<br/><br/><br/>
<br/><br/><br/>
<br/><br/><br/>

<section>
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 200;
google_ad_height = 200;
google_ad_format = "200x200_as";
google_ad_type = "image";
//-->
</script>
<div style="text-align: center;">
  <div style="text-align: left; width: 200px; display: block; margin-left: auto; margin-right: auto;">
    <!-- script type="text/javascript"
            src="https://pagead2.googlesyndication.com/pagead/show_ads.js">
            </script -->
  </div>
</div>

</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  <img src="https://www.ispol.com/grisha_org.gif" height="1" width="1">
  Copyright &copy; 2020 - Gregory Trubetskoy -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'grisha';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'https://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
