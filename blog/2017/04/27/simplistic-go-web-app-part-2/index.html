
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Building a Go Web App - Part 2 - Gregory Trubetskoy</title>
  <meta name="author" content="Gregory Trubetskoy">

  
  <meta name="description" content="This is a continuation of part 1.
(There is also part 3
and part 4). So our app is going to have two major parts to it: client and
server. (What year &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://grisha.org/blog/2017/04/27/simplistic-go-web-app-part-2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Gregory Trubetskoy" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="https://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

<!-- MathJax -->
<!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
  jax: ["input/TeX", "output/HTML-CSS"],
  tex2jax: {
    inlineMath: [ ['$', '$'] ],
    displayMath: [ ['$$', '$$']],
    processEscapes: true,
  },
  messageStyle: "none",
  "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
  });
</script>
<!-- <script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script> -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-42971867-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Gregory Trubetskoy</a></h1>
  
    <h2>Notes to self.</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:grisha.org" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Building a Go Web App - Part 2</h1>
    
    
      <p class="meta">
        








  


<time datetime="2017-04-27T14:00:00-04:00" pubdate data-updated="true">Apr 27<span>th</span>, 2017</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>This is a continuation of <a href="/blog/2017/04/27/simplistic-go-web-app/">part 1</a>.
(There is also <a href="/blog/2017/04/27/go-web-app-part-3/">part 3</a>
and <a href="/blog/2017/04/27/go-web-app-part-4/">part 4</a>).</p>

<p>So our app is going to have two major parts to it: client and
server. (What year is this?). The server side is going to be in Go,
and the client side in JS. Let’s talk about the server side first.</p>

<h2 id="the-go-server-side">The Go (Server) Side</h2>

<p>The server side of our application is going to be responsible for
initially serving up all the necessary JavaScript and supporting files
if any, aka static assets and data in the form of JSON. That’s it,
just two functions: (1) static assets and (2) JSON.</p>

<p>It’s worth noting that serving assets is optional: assets could be
served from a CDN, for example. But what is different is that it is not
a problem for our Go app, unlike a Python/Ruby app it can perform on
par with Ngnix and Apache serving static assets. Delegating assets to
another piece of software to lighten its load is no longer necessary,
though certainly makes sense in some situations.</p>

<p>To make this simpler, let’s pretend we’re making an app that lists
people (just first and last name) from a database table, that’s
it. The code is here <a href="https://github.com/grisha/gowebapp">https://github.com/grisha/gowebapp</a>.</p>

<h3 id="directory-layout">Directory Layout</h3>

<p>It has been my experience that dividing functionality across packages
early on is a good idea in Go. Even if it is not completely clear how
the final program will be structured, it is good to keep things
separate to the extent possible.</p>

<p>For a web app I think something along the lines of the following
layout makes sense:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class=""><span class="line"># github.com/user/foo
</span><span class="line">
</span><span class="line">foo/            # package main
</span><span class="line">  |
</span><span class="line">  +--daemon/    # package daemon
</span><span class="line">  |
</span><span class="line">  +--model/     # package model
</span><span class="line">  |
</span><span class="line">  +--ui/        # package ui
</span><span class="line">  |
</span><span class="line">  +--db/        # package db
</span><span class="line">  |
</span><span class="line">  +--assets/    # where we keep JS and other assets</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="top-level-package-main">Top level: <code>package main</code></h3>

<p>At the top level we have package <code>main</code> and its code in <code>main.go</code>. The
key advantage here is that with this layout <code>go get github.com/user/foo</code>
can be the only command required to install the whole application into
<code>$GOPATH/bin</code>.</p>

<p>Package <code>main</code> should do as little as possible. The only code that
belongs here is to parse the command argument flags. If the app had a
config file, I’d stick parsing and checking of that file into yet
another package, probably called <code>config</code>. After that main should pass
the control to the <code>daemon</code> package.</p>

<p>An essential main.go is:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">main</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">    <span class="s">&quot;github.com/user/foo/daemon&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">var</span> <span class="nx">assetsPath</span> <span class="kt">string</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">processFlags</span><span class="p">()</span> <span class="o">*</span><span class="nx">daemon</span><span class="p">.</span><span class="nx">Config</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">cfg</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">daemon</span><span class="p">.</span><span class="nx">Config</span><span class="p">{}</span>
</span><span class="line">
</span><span class="line">    <span class="nx">flag</span><span class="p">.</span><span class="nx">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">ListenSpec</span><span class="p">,</span> <span class="s">&quot;listen&quot;</span><span class="p">,</span> <span class="s">&quot;localhost:3000&quot;</span><span class="p">,</span> <span class="s">&quot;HTTP listen spec&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="nx">flag</span><span class="p">.</span><span class="nx">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">Db</span><span class="p">.</span><span class="nx">ConnectString</span><span class="p">,</span> <span class="s">&quot;db-connect&quot;</span><span class="p">,</span> <span class="s">&quot;host=/var/run/postgresql dbname=gowebapp sslmode=disable&quot;</span><span class="p">,</span> <span class="s">&quot;DB Connect String&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="nx">flag</span><span class="p">.</span><span class="nx">StringVar</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">assetsPath</span><span class="p">,</span> <span class="s">&quot;assets-path&quot;</span><span class="p">,</span> <span class="s">&quot;assets&quot;</span><span class="p">,</span> <span class="s">&quot;Path to assets dir&quot;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="nx">flag</span><span class="p">.</span><span class="nx">Parse</span><span class="p">()</span>
</span><span class="line">    <span class="k">return</span> <span class="nx">cfg</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">setupHttpAssets</span><span class="p">(</span><span class="nx">cfg</span> <span class="o">*</span><span class="nx">daemon</span><span class="p">.</span><span class="nx">Config</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Assets served from %q.&quot;</span><span class="p">,</span> <span class="nx">assetsPath</span><span class="p">)</span>
</span><span class="line">    <span class="nx">cfg</span><span class="p">.</span><span class="nx">UI</span><span class="p">.</span><span class="nx">Assets</span> <span class="p">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Dir</span><span class="p">(</span><span class="nx">assetsPath</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">cfg</span> <span class="o">:=</span> <span class="nx">processFlags</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">    <span class="nx">setupHttpAssets</span><span class="p">(</span><span class="nx">cfg</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">daemon</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="nx">cfg</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Error in main(): %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The above program accepts three parameters, <code>-listen</code>, <code>-db-connect</code>
and <code>-assets-path</code>, nothing earth shattering.</p>

<h4 id="using-structs-for-clarity">Using structs for clarity</h4>

<p>In line <code>cfg := &amp;daemon.Config{}</code> we are creating a <code>daemon.Config</code>
object. It’s main purpose is to pass around configuration in a
structured and clear format. Every one of our packages defines its own
<code>Config</code> type describing the parameters it needs, and packages can
include other package configs. We see an example of this in
<code>processFlags()</code> above: <code>flag.StringVar(&amp;cfg.Db.ConnectString,
...</code>. Here <code>db.Config</code> is included in <code>daemon.Config</code>. I find doing
this very useful. These structures also keep open the possibility of
serializing configs as JSON, TOML or whatever.</p>

<h4 id="using-httpfilesystem-to-serve-assets">Using http.FileSystem to serve assets</h4>

<p>The <code>http.Dir(assetsPath)</code> in <code>setupHttpAssets</code> is in preparation to
how we will serve the assets in the <code>ui</code> package. The reason it’s done
this way is to leave the door open for <code>cfg.UI.Assets</code> (which is a
<code>http.FileSystem</code> interface) to be provided by other implementations,
e.g. serving this content from memory.  I will describe it in more
detail in a later post.</p>

<p>Lastly, main calls <code>daemon.Run(cfg)</code> which is what actually starts our
app and where it blocks until it’s terminated.</p>

<h3 id="package-daemon"><code>package daemon</code></h3>

<p>Package <code>daemon</code> contains everything related to running a
process. Stuff like which port to listen on, custom logging would
belong here, as well anything related to a graceful restart, etc.</p>

<p>Since the job of the <code>daemon</code> package is to initiate the database
connection, it will need to import the <code>db</code> package. It’s also
responsible for listening on the TCP port and starting the user
interface for that listener, therefore it needs to import the <code>ui</code>
package, and since the <code>ui</code> package needs to access data, which is
done via the <code>model</code> package, it will need to import <code>model</code> as well.</p>

<p>A bare bones <code>daemon</code> might look like this:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">daemon</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">    <span class="s">&quot;log&quot;</span>
</span><span class="line">    <span class="s">&quot;net&quot;</span>
</span><span class="line">    <span class="s">&quot;os&quot;</span>
</span><span class="line">    <span class="s">&quot;os/signal&quot;</span>
</span><span class="line">    <span class="s">&quot;syscall&quot;</span>
</span><span class="line">
</span><span class="line">    <span class="s">&quot;github.com/grisha/gowebapp/db&quot;</span>
</span><span class="line">    <span class="s">&quot;github.com/grisha/gowebapp/model&quot;</span>
</span><span class="line">    <span class="s">&quot;github.com/grisha/gowebapp/ui&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">type</span> <span class="nx">Config</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">ListenSpec</span> <span class="kt">string</span>
</span><span class="line">
</span><span class="line">    <span class="nx">Db</span> <span class="nx">db</span><span class="p">.</span><span class="nx">Config</span>
</span><span class="line">    <span class="nx">UI</span> <span class="nx">ui</span><span class="p">.</span><span class="nx">Config</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">Run</span><span class="p">(</span><span class="nx">cfg</span> <span class="o">*</span><span class="nx">Config</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Starting, HTTP on: %s\n&quot;</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">ListenSpec</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="nx">db</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">InitDb</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">Db</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Error initializing database: %v\n&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="nx">err</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="nx">m</span> <span class="o">:=</span> <span class="nx">model</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">db</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="nx">l</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listen</span><span class="p">(</span><span class="s">&quot;tcp&quot;</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">ListenSpec</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Error creating listener: %v\n&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class="line">        <span class="k">return</span> <span class="nx">err</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="nx">ui</span><span class="p">.</span><span class="nx">Start</span><span class="p">(</span><span class="nx">cfg</span><span class="p">.</span><span class="nx">UI</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">l</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="nx">waitForSignal</span><span class="p">()</span>
</span><span class="line">
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">waitForSignal</span><span class="p">()</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">ch</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">)</span>
</span><span class="line">    <span class="nx">signal</span><span class="p">.</span><span class="nx">Notify</span><span class="p">(</span><span class="nx">ch</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGINT</span><span class="p">,</span> <span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGTERM</span><span class="p">)</span>
</span><span class="line">    <span class="nx">s</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">ch</span>
</span><span class="line">    <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Got signal: %v, exiting.&quot;</span><span class="p">,</span> <span class="nx">s</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Note how <code>Config</code> includes <code>db.Config</code> and <code>ui.Config</code> as I described
earlier.</p>

<p>All the action happens in <code>Run(*Config)</code>. We initialize a database
connection, create a <code>model.Model</code> instance, and start the <code>ui</code>
passing in the config, a pointer to the model and the listener.</p>

<h3 id="package-model"><code>package model</code></h3>

<p>The purpose of <code>model</code> is to separate how data is stored in the
database from the <code>ui</code>, as well as to contain any business logic an
app might have. It’s the brains of the app if you will.</p>

<p>The <code>model</code> package should define a struct (<code>Model</code> seems like an
appropriate name) and a pointer to an instance of the struct should be
passed to all the <code>ui</code> functions and methods. There should only be one
such instance in our app - for extra credit you can enforce that
programmatically by making it a singleton, but I don’t think that’s
necessary.</p>

<p>Alternatively you could get by without a <code>Model</code> and just use the
package <code>model</code> itself. I don’t like this approach, but it’s an
option.</p>

<p>The model should also define structs for the data entities we are
dealing with. In our example it would be a <code>Person</code> struct. Its
members should be exported (capitalized) because other packages will
be accessing those. If you use
<a href="https://github.com/jmoiron/sqlx">sqlx</a>, this is where you would also
specify tags that map elements to db column names, e.g. <code>`db:"first_name"`</code></p>

<p>Our Person type:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">Id</span>          <span class="kt">int64</span>
</span><span class="line">    <span class="nx">First</span><span class="p">,</span> <span class="nx">Last</span> <span class="kt">string</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In our case we do not need tags because our column names match the
element names, and sqlx conveniently takes care of the capitalization,
so <code>Last</code> matches the column named <code>last</code>.</p>

<h4 id="package-model-should-not-import-db">package model should NOT import db</h4>

<p>Somewhat counter-intuitive, <code>model</code> cannot import <code>db</code>. This is
because <code>db</code> needs to import <code>model</code>, and circular imports are not
allowed in Go. This is one case where interfaces come in
handy. <code>model</code> needs to define an interface which <code>db</code> should
satisfy. For now all we know is we need to list people, so we can
start with this definition:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">type</span> <span class="nx">db</span> <span class="kd">interface</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">SelectPeople</span><span class="p">()</span> <span class="p">([]</span><span class="o">*</span><span class="nx">Person</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Our app doesn’t really do much, but we know it lists people, so our
model should probably have a <code>People() ([]*Person, error)</code> method:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Model</span><span class="p">)</span> <span class="nx">People</span><span class="p">()</span> <span class="p">([]</span><span class="o">*</span><span class="nx">Person</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="nx">m</span><span class="p">.</span><span class="nx">SelectPeople</span><span class="p">()</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>To keep things tidy, code should be in separate files, e.g. <code>Person</code>
definition should be in <code>person.go</code>, etc. For readability, here is a
single file version of our <code>model</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">model</span>
</span><span class="line">
</span><span class="line"><span class="kd">type</span> <span class="nx">db</span> <span class="kd">interface</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">SelectPeople</span><span class="p">()</span> <span class="p">([]</span><span class="o">*</span><span class="nx">Person</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">type</span> <span class="nx">Model</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">db</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">New</span><span class="p">(</span><span class="nx">db</span> <span class="nx">db</span><span class="p">)</span> <span class="o">*</span><span class="nx">Model</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Model</span><span class="p">{</span>
</span><span class="line">        <span class="nx">db</span><span class="p">:</span> <span class="nx">db</span><span class="p">,</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">Model</span><span class="p">)</span> <span class="nx">People</span><span class="p">()</span> <span class="p">([]</span><span class="o">*</span><span class="nx">Person</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="nx">m</span><span class="p">.</span><span class="nx">SelectPeople</span><span class="p">()</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">type</span> <span class="nx">Person</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">Id</span>          <span class="kt">int64</span>
</span><span class="line">    <span class="nx">First</span><span class="p">,</span> <span class="nx">Last</span> <span class="kt">string</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="package-db"><code>package db</code></h3>

<p><code>db</code> is the actual implementation of the database interaction. This is
where the SQL statements are constructed and executed. This package
also imports <code>model</code> because it will need to construct those structs
from database data.</p>

<p>First, <code>db</code> needs to provide the <code>InitDb</code> function which will
establish the database connection, as well as create the necessary
tables and prepare the SQL statements.</p>

<p>Our simplistic example doesn’t support migrations, but in theory this
is also where they might potentially happen.</p>

<p>We are using PostgreSQL, which means we need to import the
<a href="https://github.com/lib/pq">pq</a> driver. We are also going to rely on
sqlx, and we need our own <code>model</code>. Here is the beginning of our <code>db</code>
implementation:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">db</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">    <span class="s">&quot;database/sql&quot;</span>
</span><span class="line">
</span><span class="line">    <span class="s">&quot;github.com/grisha/gowebapp/model&quot;</span>
</span><span class="line">    <span class="s">&quot;github.com/jmoiron/sqlx&quot;</span>
</span><span class="line">    <span class="nx">_</span> <span class="s">&quot;github.com/lib/pq&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">type</span> <span class="nx">Config</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">ConnectString</span> <span class="kt">string</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">InitDb</span><span class="p">(</span><span class="nx">cfg</span> <span class="nx">Config</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">pgDb</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">dbConn</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sqlx</span><span class="p">.</span><span class="nx">Connect</span><span class="p">(</span><span class="s">&quot;postgres&quot;</span><span class="p">,</span> <span class="nx">cfg</span><span class="p">.</span><span class="nx">ConnectString</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span><span class="line">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">p</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">pgDb</span><span class="p">{</span><span class="nx">dbConn</span><span class="p">:</span> <span class="nx">dbConn</span><span class="p">}</span>
</span><span class="line">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">dbConn</span><span class="p">.</span><span class="nx">Ping</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">createTablesIfNotExist</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">        <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">prepareSqlStatements</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">            <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span><span class="line">        <span class="p">}</span>
</span><span class="line">        <span class="k">return</span> <span class="nx">p</span><span class="p">,</span> <span class="kc">nil</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Our <code>InitDb()</code> creates an instance of a <code>pgDb</code>, which is our Postgres
implementation of the <code>model.db</code> interface. It keeps all that we need
to communicate with the database, including the prepared statements,
and exports the necessary methods to satisfy the interface.</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">type</span> <span class="nx">pgDb</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">dbConn</span> <span class="o">*</span><span class="nx">sqlx</span><span class="p">.</span><span class="nx">DB</span>
</span><span class="line">
</span><span class="line">    <span class="nx">sqlSelectPeople</span> <span class="o">*</span><span class="nx">sqlx</span><span class="p">.</span><span class="nx">Stmt</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here is the code to create the tables and the statements. From the SQL
perspective this is rather simplistic, it could be a lot more
elaborate, of course:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">pgDb</span><span class="p">)</span> <span class="nx">createTablesIfNotExist</span><span class="p">()</span> <span class="kt">error</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">create_sql</span> <span class="o">:=</span> <span class="s">`</span>
</span><span class="line">
</span><span class="line"><span class="s">       CREATE TABLE IF NOT EXISTS people (</span>
</span><span class="line"><span class="s">       id SERIAL NOT NULL PRIMARY KEY,</span>
</span><span class="line"><span class="s">       first TEXT NOT NULL,</span>
</span><span class="line"><span class="s">       last TEXT NOT NULL);</span>
</span><span class="line">
</span><span class="line"><span class="s">    `</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">rows</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">dbConn</span><span class="p">.</span><span class="nx">Query</span><span class="p">(</span><span class="nx">create_sql</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">        <span class="k">return</span> <span class="nx">err</span>
</span><span class="line">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">rows</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="p">(</span><span class="nx">p</span> <span class="o">*</span><span class="nx">pgDb</span><span class="p">)</span> <span class="nx">prepareSqlStatements</span><span class="p">()</span> <span class="p">(</span><span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="nx">p</span><span class="p">.</span><span class="nx">sqlSelectPeople</span><span class="p">,</span> <span class="nx">err</span> <span class="p">=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">dbConn</span><span class="p">.</span><span class="nx">Preparex</span><span class="p">(</span>
</span><span class="line">        <span class="s">&quot;SELECT id, first, last FROM people&quot;</span><span class="p">,</span>
</span><span class="line">    <span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">        <span class="k">return</span> <span class="nx">err</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="k">return</span> <span class="kc">nil</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Finally, we need to provide the method to satisfy the interface:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="go"><span class="line">    <span class="nx">people</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">Person</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">p</span><span class="p">.</span><span class="nx">sqlSelectPeople</span><span class="p">.</span><span class="nx">Select</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">people</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class="line">        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
</span><span class="line">    <span class="p">}</span>
</span><span class="line">    <span class="k">return</span> <span class="nx">people</span><span class="p">,</span> <span class="kc">nil</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Here we’re taking advantage of sqlx to run the query and construct a
slice from results with a simple call to <code>Select()</code> (NB:
<code>p.sqlSelectPeople</code> is a <code>*sqlx.Stmt</code>). Without sqlx we would have to
iterate over the result rows, processing each with <code>Scan</code>, which would
be considerably more verbose.</p>

<p>Beware of a very subtle “gotcha” here. <code>people</code> could also be defined
as <code>var people []*model.Person</code> and the method would work just the
same. However, if the database returned no rows, the method would
return <code>nil</code>, not an empty slice. If the result of this method is
later encoded as JSON, the former would become <code>null</code> and the latter
<code>[]</code>. This could cause problems if the client side doesn’t know how to
treat <code>null</code>.</p>

<p>That’s it for <code>db</code>.</p>

<h3 id="package-ui">package ui</h3>

<p>Finally, we need to serve all that stuff via HTTP and that’s what the
<code>ui</code> package does.</p>

<p>Here is a very simplistic variant:</p>

<div class="bogus-wrapper"><notextile><figure class="code"> <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
</pre></td><td class="code"><pre><code class="go"><span class="line"><span class="kn">package</span> <span class="nx">ui</span>
</span><span class="line">
</span><span class="line"><span class="kn">import</span> <span class="p">(</span>
</span><span class="line">    <span class="s">&quot;fmt&quot;</span>
</span><span class="line">    <span class="s">&quot;net&quot;</span>
</span><span class="line">    <span class="s">&quot;net/http&quot;</span>
</span><span class="line">    <span class="s">&quot;time&quot;</span>
</span><span class="line">
</span><span class="line">    <span class="s">&quot;github.com/grisha/gowebapp/model&quot;</span>
</span><span class="line"><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="kd">type</span> <span class="nx">Config</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class="line">    <span class="nx">Assets</span> <span class="nx">http</span><span class="p">.</span><span class="nx">FileSystem</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">Start</span><span class="p">(</span><span class="nx">cfg</span> <span class="nx">Config</span><span class="p">,</span> <span class="nx">m</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">Model</span><span class="p">,</span> <span class="nx">listener</span> <span class="nx">net</span><span class="p">.</span><span class="nx">Listener</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">
</span><span class="line">    <span class="nx">server</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Server</span><span class="p">{</span>
</span><span class="line">        <span class="nx">ReadTimeout</span><span class="p">:</span>    <span class="mi">60</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
</span><span class="line">        <span class="nx">WriteTimeout</span><span class="p">:</span>   <span class="mi">60</span> <span class="o">*</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">,</span>
</span><span class="line">        <span class="nx">MaxHeaderBytes</span><span class="p">:</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="nx">http</span><span class="p">.</span><span class="nx">Handle</span><span class="p">(</span><span class="s">&quot;/&quot;</span><span class="p">,</span> <span class="nx">indexHandler</span><span class="p">(</span><span class="nx">m</span><span class="p">))</span>
</span><span class="line">
</span><span class="line">    <span class="k">go</span> <span class="nx">server</span><span class="p">.</span><span class="nx">Serve</span><span class="p">(</span><span class="nx">listener</span><span class="p">)</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="kd">const</span> <span class="nx">indexHTML</span> <span class="p">=</span> <span class="s">`</span>
</span><span class="line"><span class="s">&lt;!DOCTYPE HTML&gt;</span>
</span><span class="line"><span class="s">&lt;html&gt;</span>
</span><span class="line"><span class="s">  &lt;head&gt;</span>
</span><span class="line"><span class="s">    &lt;meta charset=&quot;utf-8&quot;&gt;</span>
</span><span class="line"><span class="s">    &lt;title&gt;Simple Go Web App&lt;/title&gt;</span>
</span><span class="line"><span class="s">  &lt;/head&gt;</span>
</span><span class="line"><span class="s">  &lt;body&gt;</span>
</span><span class="line"><span class="s">    &lt;div id=&#39;root&#39;&gt;&lt;/div&gt;</span>
</span><span class="line"><span class="s">  &lt;/body&gt;</span>
</span><span class="line"><span class="s">&lt;/html&gt;</span>
</span><span class="line"><span class="s">`</span>
</span><span class="line">
</span><span class="line"><span class="kd">func</span> <span class="nx">indexHandler</span><span class="p">(</span><span class="nx">m</span> <span class="o">*</span><span class="nx">model</span><span class="p">.</span><span class="nx">Model</span><span class="p">)</span> <span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span> <span class="p">{</span>
</span><span class="line">    <span class="k">return</span> <span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">r</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span><span class="line">        <span class="nx">fmt</span><span class="p">.</span><span class="nx">Fprintf</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">indexHTML</span><span class="p">)</span>
</span><span class="line">    <span class="p">})</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Note how <code>indexHTML</code> contains next to nothing. This is 100% of the
HTML that this app will ever serve. It will evolve a little as we get
into the client side of the app, but only by a few lines.</p>

<p>Also noteworthy is how the handler is defined. If this idiom is not
familiar, it’s worth spending a few minutes (or a day) to internalize
it completely as it is very common in Go. <code>indexHandler()</code> is not a
handler, it <em>returns</em> a handler function. It is done this way so
that we can pass in a <code>*model.Model</code> via closure, since an HTTP
handler function definition is fixed and a model pointer is not one of
the parameters.</p>

<p>In the case of <code>indexHandler()</code> we’re not actually doing anything with
the model pointer, but when we get to implementing an actual list of
people we will need it.</p>

<h3 id="conclusion">Conclusion</h3>

<p>Above is essentially all the knowledge required to build a basic Go
web app, at least the Go side of it. Next week I’ll get into the
client side and we will complete the people listing code.</p>

<p>Continue to <a href="/blog/2017/04/27/go-web-app-part-3/">part 3</a>.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Gregory Trubetskoy</span></span>

      








  


<time datetime="2017-04-27T14:00:00-04:00" pubdate data-updated="true">Apr 27<span>th</span>, 2017</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="https://twitter.com/share" class="twitter-share-button" data-url="http://grisha.org/blog/2017/04/27/simplistic-go-web-app-part-2/" data-via="humblehack" data-counturl="http://grisha.org/blog/2017/04/27/simplistic-go-web-app-part-2/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/blog/2017/04/27/go-web-app-part-3/" title="Previous Post: Building a Go Web App - Part 3">&laquo; Building a Go Web App - Part 3</a>
      
      
        <a class="basic-alignment right" href="/blog/2017/04/27/simplistic-go-web-app/" title="Next Post: Building a Go Web App in 2017">Building a Go Web App in 2017 &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    

<section>
Mar 2021: I am looking for a new gig! This won't last long. Contact me
if interested. (crypto, big data, go, ML, scale, security - find me on
<a href="https://linkedin.com/in/grisha">linkedin</a> or <a href="https://github.com/grisha">github</a>)
</section>

<section>
  <h1>About Me</h1>

  <p>
  <div style="width: 75%; margin: 0 auto;">
  <a href="https://twitter.com/humblehack" class="twitter-follow-button"
    data-show-count="">Follow @humblehack</a>
  </div>
  </p>

  <p>Grisha is a common Russian short name for Gregory. It is pronounced more like Greesha.</p>
  <p>Years ago I wrote <a href="http://modpython.org">mod_python</a>, which became a hugely succesful OSS Project used by millions of sites.</p>
  <p>I am a former VP and member emeritus of the <a href="http://apache.org">Apache Software Foundation</a>.</p>
  <p>I live near Washington, DC, USA</p>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2020/05/08/mini-bigquery-etl-in-python-with-bq-etl/">Keeping ETL in BigQuery&nbsp;with&nbsp;bq_etl.</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/06/19/sql-dag/">Implicit SQL DAG in Maestro</a>
      </li>
    
      <li class="post">
        <a href="/blog/2019/06/05/maestro-is-open-source/">Maestro the BigQuery Orchestrator</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/10/18/relative-imports-hack-in-go/">Relative Imports Hack in Golang</a>
      </li>
    
      <li class="post">
        <a href="/blog/2018/01/23/explaining-proof-of-work/">Blockchain Proof-of-Work is a Decentralized Clock</a>
      </li>
    
  </ul>
</section>

<br/><br/><br/>
<br/><br/><br/>
<br/><br/><br/>

<section>
<script type="text/javascript"><!--
google_ad_client = "pub-9718360309690383";
google_ad_width = 200;
google_ad_height = 200;
google_ad_format = "200x200_as";
google_ad_type = "image";
//-->
</script>
<div style="text-align: center;">
  <div style="text-align: left; width: 200px; display: block; margin-left: auto; margin-right: auto;">
    <!-- script type="text/javascript"
            src="https://pagead2.googlesyndication.com/pagead/show_ads.js">
            </script -->
  </div>
</div>

</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  <img src="https://www.ispol.com/grisha_org.gif" height="1" width="1">
  Copyright &copy; 2021 - Gregory Trubetskoy -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'grisha';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://grisha.org/blog/2017/04/27/simplistic-go-web-app-part-2/';
        var disqus_url = 'http://grisha.org/blog/2017/04/27/simplistic-go-web-app-part-2/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'https://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'https://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
