<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Apache Avro | Gregory Trubetskoy</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="description" content="Short version

Avro is better than Json for storing table data
Avro supports schema resolution so that the schema can evolve over time
Hive supports Avro and schema resolution nicely
Impala (1.0) can read Avro tables, but does not support schema resolution
Mixing compression codecs in the same table works in both Hive and Impala

The TL;DR version
Introduction
If you&rsquo;re logging data into Hadoop to be analyzed, chances are you&rsquo;re
using JSON. JSON is great because it&rsquo;s easy to generate in most any
language, it&rsquo;s human-readable, it&rsquo;s universally supported and
infinitely flexible.">
    <meta name="generator" content="Hugo 0.146.0">
    
    
    
      <meta name="robots" content="index, follow">
    
    <meta name="author" content="Gregory Trubetskoy">
    

    
<link rel="stylesheet" href="/ananke/css/main.min.d05fb5f317fcf33b3a52936399bdf6f47dc776516e1692e412ec7d76f4a5faa2.css" >




    


    
      

    

    

    
      <link rel="canonical" href="https://grisha.org/blog/2013/06/06/avro/">
    

    
    
    <meta property="og:url" content="https://grisha.org/blog/2013/06/06/avro/">
  <meta property="og:site_name" content="Gregory Trubetskoy">
  <meta property="og:title" content="Apache Avro">
  <meta property="og:description" content="Short version Avro is better than Json for storing table data Avro supports schema resolution so that the schema can evolve over time Hive supports Avro and schema resolution nicely Impala (1.0) can read Avro tables, but does not support schema resolution Mixing compression codecs in the same table works in both Hive and Impala The TL;DR version Introduction If you’re logging data into Hadoop to be analyzed, chances are you’re using JSON. JSON is great because it’s easy to generate in most any language, it’s human-readable, it’s universally supported and infinitely flexible.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2013-06-06T22:53:00+00:00">
    <meta property="article:modified_time" content="2013-06-06T22:53:00+00:00">

  <meta itemprop="name" content="Apache Avro">
  <meta itemprop="description" content="Short version Avro is better than Json for storing table data Avro supports schema resolution so that the schema can evolve over time Hive supports Avro and schema resolution nicely Impala (1.0) can read Avro tables, but does not support schema resolution Mixing compression codecs in the same table works in both Hive and Impala The TL;DR version Introduction If you’re logging data into Hadoop to be analyzed, chances are you’re using JSON. JSON is great because it’s easy to generate in most any language, it’s human-readable, it’s universally supported and infinitely flexible.">
  <meta itemprop="datePublished" content="2013-06-06T22:53:00+00:00">
  <meta itemprop="dateModified" content="2013-06-06T22:53:00+00:00">
  <meta itemprop="wordCount" content="1246">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Apache Avro">
  <meta name="twitter:description" content="Short version Avro is better than Json for storing table data Avro supports schema resolution so that the schema can evolve over time Hive supports Avro and schema resolution nicely Impala (1.0) can read Avro tables, but does not support schema resolution Mixing compression codecs in the same table works in both Hive and Impala The TL;DR version Introduction If you’re logging data into Hadoop to be analyzed, chances are you’re using JSON. JSON is great because it’s easy to generate in most any language, it’s human-readable, it’s universally supported and infinitely flexible.">

      
      
    
	
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    jax: ["input/TeX", "output/HTML-CSS"],
    tex2jax: {
      inlineMath: [ ['$', '$'] ],
      displayMath: [ ['$$', '$$']],
      processEscapes: true,
    },
    messageStyle: "none",
    "HTML-CSS": { preferredFont: "TeX", availableFonts: ["STIX","TeX"] }
  });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML" type="text/javascript"></script>

  </head><body class="ma0 avenir bg-near-white production">

    
   
  

  <header>
    <div class="bg-black">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l center items-center justify-between">
    <a href="/" class="f3 fw2 hover-white white-90 dib no-underline">
      
        Gregory Trubetskoy
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white white-90 no-underline" href="/archives/" title="Archives page">
              Archives
            </a>
          </li>
          
        </ul>
      
      <div class="ananke-socials"></div>

    </div>
  </div>
</nav>

    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l mw7 center ph3 flex-wrap justify-between">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked ttu">
          
        Posts
      </aside><div id="sharing" class="mt3 ananke-socials"></div>
<h1 class="f1 athelas mt3 mb1">Apache Avro</h1>
      
      <p class="tracked"><strong>Gregory Trubetskoy</strong>
      </p>
      
      
      
      <time class="f6 mv4 dib tracked" datetime="2013-06-06T22:53:00Z">June 6, 2013</time>
      

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-100-l"><h2 id="short-version">Short version</h2>
<ul>
<li>Avro is better than Json for storing table data</li>
<li>Avro supports schema resolution so that the schema can evolve over time</li>
<li>Hive supports Avro and schema resolution nicely</li>
<li>Impala (1.0) can read Avro tables, but does <em>not</em> support schema resolution</li>
<li>Mixing compression codecs in the same table works in both Hive and Impala</li>
</ul>
<h2 id="the-tldr-version">The TL;DR version</h2>
<h3 id="introduction">Introduction</h3>
<p>If you&rsquo;re logging data into Hadoop to be analyzed, chances are you&rsquo;re
using JSON. JSON is great because it&rsquo;s easy to generate in most any
language, it&rsquo;s human-readable, it&rsquo;s universally supported and
infinitely flexible.</p>
<p>It is also space inefficient, prone to errors, the standard has a few
ambiguities, all of which eventually catches up to you. It only takes
one bad record to spoil a potentially massive amount of data, and
finding the bad record and figuring out the root cause of the problem
is usually difficult and often even impossible.</p>
<p>So you might be considering a slightly more rigid and space efficient
format, and in the Hadoop world it is <a href="http://en.wikipedia.org/wiki/Apache_Avro">Apache Avro</a>.
<a href="http://avro.apache.org/docs/current/">Avro</a> is especially
compelling because it is supported by
<a href="http://blog.cloudera.com/blog/2013/05/cloudera-impala-1-0-its-here-its-real-its-already-the-standard-for-sql-on-hadoop/">Impala</a>,
while JSON isn&rsquo;t (not yet, at least).</p>
<p>Named after a <a href="http://en.wikipedia.org/wiki/Avro">British aircraft maker</a>, Avro is a schema-enforced
format for serializing arbitrary data. It is in the same category as
<a href="http://en.wikipedia.org/wiki/Thrift_%28protocol%29">Thrift</a>, only it seems like Thrift has found its niche in
RPC, whereas Avro appears more compelling as the on-disk
format (even though both Avro and Thrift were designed for both storage
and RPC). Thrift seems more insistent on you using its code
generator, whereas Avro does it the old-school way, but providing
you libraries you can use in your code. (It does code generation as
well, if that&rsquo;s your thing. I prefer to hand-write all my code).</p>
<p>I actually don&rsquo;t want to focus on the details of what Avro is as there
is plenty information on that elsewhere. I want to share my findings
regarding Avro&rsquo;s suitability as an alternative to JSON used with Hive
and JSON SerDe.</p>
<h3 id="schema-and-its-resolution">Schema (and its Resolution)</h3>
<p>Every Avro file contains a header with the schema describing (in
JSON!) the contents of the file&rsquo;s records. This is very nice, because
the file contains all the knowledge necessary to be able to read it.</p>
<p>Avro was designed with the understanding that the schema may change
over time (e.g. columns added or changed), and that software designed
for a newer schema may need to read older schema files. To support
this it provides something called Schema Resolution.</p>
<p>Imagine you&rsquo;ve been storing people&rsquo;s names in a file. Then later on
you decided to add &ldquo;age&rdquo; as another attribute. Now you&rsquo;re got two
schemas, one with &ldquo;age&rdquo; and one without. In JSON world you&rsquo;d have to
adjust your program to be able to read old files with some kind of an
if/then statement to make sure that when &ldquo;age&rdquo; is not there the
program knows what to do. In Avro, the new schema can specify a
default for the age (e.g. 0), and whatever Avro lib you&rsquo;d be using
should be able to convert a record of the old schema to the new schema
automatically, without any code modifications necessary. This is
called <em>schema resolution</em>.</p>
<h3 id="avro-support-in-hive">Avro support in Hive</h3>
<p>First we need an Avro file. Our schema is just one string column named
&ldquo;test&rdquo;. Here&rsquo;s a quick Ruby program to generate a file of 10 random
records (you&rsquo;ll need to <code>gem install avro</code>):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>require <span style="color:#e6db74">&#39;rubygems&#39;</span>
</span></span><span style="display:flex;"><span>require <span style="color:#e6db74">&#39;avro&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>schema <span style="color:#f92672">=</span> <span style="color:#66d9ef">Avro</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Schema</span><span style="color:#f92672">.</span>parse(<span style="color:#e6db74">&#39;{&#34;name&#34;:&#34;test_record&#34;, &#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#39; &#34;type&#34;:&#34;record&#34;, &#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#39; &#34;fields&#34;: [&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#39;   {&#34;name&#34;:&#34;full_name&#34;,  &#34;type&#34;:&#34;string&#34;}]}&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>writer <span style="color:#f92672">=</span> <span style="color:#66d9ef">Avro</span><span style="color:#f92672">::</span><span style="color:#66d9ef">IO</span><span style="color:#f92672">::</span><span style="color:#66d9ef">DatumWriter</span><span style="color:#f92672">.</span>new(schema)
</span></span><span style="display:flex;"><span>file <span style="color:#f92672">=</span> <span style="color:#66d9ef">File</span><span style="color:#f92672">.</span>open(<span style="color:#e6db74">&#39;test.avro&#39;</span>, <span style="color:#e6db74">&#39;wb&#39;</span>)
</span></span><span style="display:flex;"><span>dw <span style="color:#f92672">=</span> <span style="color:#66d9ef">Avro</span><span style="color:#f92672">::</span><span style="color:#66d9ef">DataFile</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Writer</span><span style="color:#f92672">.</span>new(file, writer, schema)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span>times <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  dw <span style="color:#f92672">&lt;&lt;</span> {<span style="color:#e6db74">&#39;full_name&#39;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;X</span><span style="color:#e6db74">#{</span>rand(<span style="color:#ae81ff">10000</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74"> Y</span><span style="color:#e6db74">#{</span>rand(<span style="color:#ae81ff">10000</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>dw<span style="color:#f92672">.</span>flush
</span></span><span style="display:flex;"><span>dw<span style="color:#f92672">.</span>close
</span></span></code></pre></div><p>Then we need to create a Hive table and load our file into it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> test_avro
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">ROW</span> FORMAT SERDE <span style="color:#e6db74">&#39;org.apache.hadoop.hive.serde2.avro.AvroSerDe&#39;</span>
</span></span><span style="display:flex;"><span> STORED <span style="color:#66d9ef">AS</span> INPUTFORMAT <span style="color:#e6db74">&#39;org.apache.hadoop.hive.ql.io.avro.AvroContainerInputFormat&#39;</span>
</span></span><span style="display:flex;"><span> OUTPUTFORMAT <span style="color:#e6db74">&#39;org.apache.hadoop.hive.ql.io.avro.AvroContainerOutputFormat&#39;</span>
</span></span><span style="display:flex;"><span> TBLPROPERTIES (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;avro.schema.literal&#39;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{&#34;name&#34;:&#34;test_record&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;type&#34;:&#34;record&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;fields&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                               {&#34;name&#34;:&#34;full_name&#34;, &#34;type&#34;:&#34;string&#34;}]}&#39;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">LOAD</span> <span style="color:#66d9ef">DATA</span> <span style="color:#66d9ef">LOCAL</span> INPATH <span style="color:#e6db74">&#39;test.avro&#39;</span> OVERWRITE <span style="color:#66d9ef">INTO</span> <span style="color:#66d9ef">TABLE</span> test_avro;
</span></span></code></pre></div><p>Note that the table definition needs its own schema definition, even
though our file already contains a schema. This is not a mistake. This
is the schema Hive will expect. And if the file that it&rsquo;s reading is of
a different schema, it will attempt to convert it using Avro schema
resolution. Also noteworthy is that this table defines <em>no
columns</em>. The entire definition is in the <code>avro.schema.literal</code>
property.</p>
<p>Let&rsquo;s make sure this is working:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>hive<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> test_avro;
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>X1800 Y9002
</span></span><span style="display:flex;"><span>X3859 Y8971
</span></span><span style="display:flex;"><span>X6935 Y5523
</span></span></code></pre></div><p>Now we also happen to have Impala running, let&rsquo;s see if it&rsquo;s able to read this file:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> test_avro;
</span></span><span style="display:flex;"><span>Query: <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> test_avro
</span></span><span style="display:flex;"><span>Query finished, fetching results ...
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">-------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> full_name   <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">-------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> X1800 Y9002 <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> X3859 Y8971 <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> X6935 Y5523 <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">-------------+
</span></span></span></code></pre></div><p>So far so good! Now let&rsquo;s create a second avro file, with one
additional column <code>age</code>, using the following Ruby:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span>schema <span style="color:#f92672">=</span> <span style="color:#66d9ef">Avro</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Schema</span><span style="color:#f92672">.</span>parse(<span style="color:#e6db74">&#39;{&#34;name&#34;:&#34;test_record&#34;, &#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#39; &#34;type&#34;:&#34;record&#34;, &#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#39; &#34;fields&#34;: [&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#39;   {&#34;name&#34;:&#34;full_name&#34;,  &#34;type&#34;:&#34;string&#34;},&#39;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#e6db74">&#39;   {&#34;name&#34;:&#34;age&#34;,        &#34;type&#34;:&#34;int&#34;}]}&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>writer <span style="color:#f92672">=</span> <span style="color:#66d9ef">Avro</span><span style="color:#f92672">::</span><span style="color:#66d9ef">IO</span><span style="color:#f92672">::</span><span style="color:#66d9ef">DatumWriter</span><span style="color:#f92672">.</span>new(schema)
</span></span><span style="display:flex;"><span>file <span style="color:#f92672">=</span> <span style="color:#66d9ef">File</span><span style="color:#f92672">.</span>open(<span style="color:#e6db74">&#39;test2.avro&#39;</span>, <span style="color:#e6db74">&#39;wb&#39;</span>)
</span></span><span style="display:flex;"><span>dw <span style="color:#f92672">=</span> <span style="color:#66d9ef">Avro</span><span style="color:#f92672">::</span><span style="color:#66d9ef">DataFile</span><span style="color:#f92672">::</span><span style="color:#66d9ef">Writer</span><span style="color:#f92672">.</span>new(file, writer, schema)
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span><span style="color:#f92672">.</span>times <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>  dw <span style="color:#f92672">&lt;&lt;</span> {<span style="color:#e6db74">&#39;full_name&#39;</span><span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;X</span><span style="color:#e6db74">#{</span>rand(<span style="color:#ae81ff">10000</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74"> Y</span><span style="color:#e6db74">#{</span>rand(<span style="color:#ae81ff">10000</span>)<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#39;age&#39;</span><span style="color:#f92672">=&gt;</span>rand(<span style="color:#ae81ff">100</span>)}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">end</span>
</span></span><span style="display:flex;"><span>dw<span style="color:#f92672">.</span>flush
</span></span><span style="display:flex;"><span>dw<span style="color:#f92672">.</span>close
</span></span></code></pre></div><p>Let&rsquo;s load this into Hive and see if it still works. (No OVERWRITE
keyword this time, we&rsquo;re appending a second file to our table).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>hive<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">LOAD</span> <span style="color:#66d9ef">DATA</span> <span style="color:#66d9ef">LOCAL</span> INPATH <span style="color:#e6db74">&#39;test2.avro&#39;</span> <span style="color:#66d9ef">INTO</span> <span style="color:#66d9ef">TABLE</span> test_avro;
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>hive<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> test_avro;
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>X1800 Y9002
</span></span><span style="display:flex;"><span>X3859 Y8971
</span></span><span style="display:flex;"><span>X6935 Y5523
</span></span><span style="display:flex;"><span>X4720 Y1361
</span></span><span style="display:flex;"><span>X4605 Y3067
</span></span><span style="display:flex;"><span>X7007 Y7852
</span></span></code></pre></div><p>This is working exactly as expected. Hive has shown the 3 original
records as before, and the 3 new ones got converted to Hive&rsquo;s version
of the schema, where the &ldquo;age&rdquo; column does not exist.</p>
<p>Let&rsquo;s see what Impala thinks of this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> test_avro;
</span></span><span style="display:flex;"><span>Query: <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> test_avro
</span></span><span style="display:flex;"><span>Query finished, fetching results ...
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">-------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> full_name   <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">-------------+
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#f92672">|</span> X1800 Y9002 <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> X3859 Y8971 <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> X6935 Y5523 <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#75715e">-------------+
</span></span></span></code></pre></div><p>Alas - we&rsquo;re only getting the 3 original rows. Bummer! What&rsquo;s
worrisome is that <em>no indication</em> was given to us that 3 other rows got
swallowed because Impala didn&rsquo;t do schema resolution. (I&rsquo;ve posted
regarding this on the Impala users list, awaiting response).</p>
<p>Now let&rsquo;s alter the table schema so that age is part of it. (This is
not your typical ALTER TABLE, we&rsquo;re just changing <code>avro.schema.literal</code>).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>hive<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> test_avro <span style="color:#66d9ef">SET</span> TBLPROPERTIES (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;avro.schema.literal&#39;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{&#34;name&#34;:&#34;test_record&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;type&#34;:&#34;record&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;fields&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                              {&#34;name&#34;:&#34;full_name&#34;, &#34;type&#34;:&#34;string&#34;},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                              {&#34;name&#34;:&#34;age&#34;,  &#34;type&#34;:&#34;int&#34;}]}&#39;</span>);
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>hive<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> test_avro;
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>Failed <span style="color:#66d9ef">with</span> <span style="color:#66d9ef">exception</span> java.io.IOException:org.apache.avro.AvroTypeException: <span style="color:#66d9ef">Found</span> test_record, expecting test_record
</span></span></code></pre></div><p>This error should not be surprising. Hive is trying to provide a value
for <code>age</code> for those records where it did not exist, but we neglected
to specify a default. (The error message <em>is</em> a little cryptic,
though). So let&rsquo;s try again, this time with a default:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span>hive<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">ALTER</span> <span style="color:#66d9ef">TABLE</span> test_avro <span style="color:#66d9ef">SET</span> TBLPROPERTIES (
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;avro.schema.literal&#39;</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{&#34;name&#34;:&#34;test_record&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;type&#34;:&#34;record&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                            &#34;fields&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                              {&#34;name&#34;:&#34;full_name&#34;, &#34;type&#34;:&#34;string&#34;},
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">                              {&#34;name&#34;:&#34;age&#34;,  &#34;type&#34;:&#34;int&#34;, &#34;default&#34;:999}]}&#39;</span>);
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>hive<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">select</span> <span style="color:#f92672">*</span> <span style="color:#66d9ef">from</span> test_avro;
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>X1800 Y9002     <span style="color:#ae81ff">999</span>
</span></span><span style="display:flex;"><span>X3859 Y8971     <span style="color:#ae81ff">999</span>
</span></span><span style="display:flex;"><span>X6935 Y5523     <span style="color:#ae81ff">999</span>
</span></span><span style="display:flex;"><span>X4720 Y1361     <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span>X4605 Y3067     <span style="color:#ae81ff">34</span>
</span></span><span style="display:flex;"><span>X7007 Y7852     <span style="color:#ae81ff">17</span>
</span></span></code></pre></div><p>Woo-hoo!</p>
<h3 id="other-notes">Other notes</h3>
<ul>
<li>There is a nice Avro-C library, but it currently does not support defaults (version 1.7.4).</li>
<li>Some <a href="http://code.google.com/p/thrift-protobuf-compare/wiki/Benchmarking">benchmarks</a></li>
<li>Avro&rsquo;s integer encoding is same as Lucene with <a href="https://developers.google.com/protocol-buffers/docs/encoding#types">zigzag encoding</a>
on top of it. (It&rsquo;s just like SQLite, only little-endian). Curiously,
it is used for <em>all</em> integers, including array indexes internal to
Avro, which can never be negative and thus ZigZag is of no use. This
is probably to keep all integer operation consistent.</li>
<li>A curious post on how Lucene/Avro variable-integer format is <a href="http://blog.mikemccandless.com/2010/07/moving-readvint-to-c.html">CPU-unfriendly</a></li>
</ul>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
        
        <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "grisha" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
      
      </div>
    </div></article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white white-70 dn dib-ns pv2 ph3 no-underline" href="https://grisha.org/" >
    &copy;  Gregory Trubetskoy 2026 
  </a>
    <div><div class="ananke-socials"></div>
</div>
  </div>
</footer>

  </body>
</html>
